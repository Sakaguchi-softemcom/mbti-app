<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>16 Personalities Deep Dive</title>
<meta name="description" content="16タイプの深層分析・恋愛相性・仕事相性・チーム分析">
<meta property="og:title" content="16 Personalities Deep Dive">
<meta property="og:description" content="あなたの性格を深く、美しく読み解く">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#0a0a0f; }
  #root { min-height:100vh; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;


/* ═══════════════════════════════════════════════
   16 Personalities Deep Dive — Editorial Design
   ═══════════════════════════════════════════════ */

/* --- Font injection --- */
const _fontLink = typeof document !== "undefined" && (() => {
  if (!document.getElementById("mbti-fonts")) {
    const l = document.createElement("link");
    l.id = "mbti-fonts";
    l.rel = "stylesheet";
    l.href = "https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap";
    document.head.appendChild(l);
  }
  const s = document.createElement("style");
  s.textContent = `
    @keyframes fadeUp { from { opacity:0; transform:translateY(18px) } to { opacity:1; transform:translateY(0) } }
    @keyframes glow { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.2)} }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    * { box-sizing:border-box; }
    ::-webkit-scrollbar { width:6px } ::-webkit-scrollbar-track { background:transparent } ::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.08);border-radius:4px }
    ::selection { background:rgba(139,92,246,0.3);color:#fff }
  `;
  document.head.appendChild(s);
})();

const F = { h: "'Outfit',sans-serif", b: "'Noto Sans JP','Outfit',sans-serif" };

/* --- Avatar URLs --- */
const AV_BASE = "https://www.16personalities.com/static/images/personality-types/avatars/";
const AV_URL = {
  INTJ:AV_BASE+"intj-architect-male.svg?v=3",INTP:AV_BASE+"intp-logician-female.svg?v=3",
  ENTJ:AV_BASE+"entj-commander-female.svg?v=3",ENTP:AV_BASE+"entp-debater-male.svg?v=3",
  INFJ:AV_BASE+"infj-advocate-male.svg?v=3",INFP:AV_BASE+"infp-mediator-female.svg?v=3",
  ENFJ:AV_BASE+"enfj-protagonist-male.svg?v=3",ENFP:AV_BASE+"enfp-campaigner-female.svg?v=3",
  ISTJ:AV_BASE+"istj-logistician-male.svg?v=3",ISFJ:AV_BASE+"isfj-defender-female.svg?v=3",
  ESTJ:AV_BASE+"estj-executive-female.svg?v=3",ESFJ:AV_BASE+"esfj-consul-male.svg?v=3",
  ISTP:AV_BASE+"istp-virtuoso-male.svg?v=3",ISFP:AV_BASE+"isfp-adventurer-female.svg?v=3",
  ESTP:AV_BASE+"estp-entrepreneur-male.svg?v=3",ESFP:AV_BASE+"esfp-entertainer-female.svg?v=3"
};

/* --- Core Data --- */
const NICK = {ISTJ:"管理者",ISFJ:"擁護者",INFJ:"提唱者",INTJ:"建築家",ISTP:"巨匠",ISFP:"冒険家",INFP:"仲介者",INTP:"論理学者",ESTP:"起業家",ESFP:"エンターテイナー",ENFP:"広報運動家",ENTP:"討論者",ESTJ:"幹部",ESFJ:"領事官",ENFJ:"主人公",ENTJ:"指揮官"};
const GRP = {ISTJ:"番人",ISFJ:"番人",ESTJ:"番人",ESFJ:"番人",INFJ:"外交官",INFP:"外交官",ENFJ:"外交官",ENFP:"外交官",INTJ:"分析家",INTP:"分析家",ENTJ:"分析家",ENTP:"分析家",ISTP:"探検家",ISFP:"探検家",ESTP:"探検家",ESFP:"探検家"};
const GC = {"番人":"#4298b4","外交官":"#33b98a","分析家":"#9b6dff","探検家":"#e4ae3a"};
const EM = {ISTJ:"🏛️",ISFJ:"🛡️",INFJ:"🔮",INTJ:"♟️",ISTP:"🔧",ISFP:"🎨",INFP:"🌙",INTP:"🧪",ESTP:"🏄",ESFP:"🎉",ENFP:"🦋",ENTP:"⚡",ESTJ:"📋",ESFJ:"☀️",ENFJ:"🌟",ENTJ:"👑"};

const AVD = {
  INTJ:{bg:"#2d1b69",skin:"#c4b5fd",hair:"#1a0f40",item:"♟"},INTP:{bg:"#2d1b69",skin:"#c4b5fd",hair:"#3b1a80",item:"∞"},
  ENTJ:{bg:"#2d1b69",skin:"#c4b5fd",hair:"#1e0e50",item:"★"},ENTP:{bg:"#2d1b69",skin:"#c4b5fd",hair:"#4a2496",item:"⚡"},
  INFJ:{bg:"#0d4a3a",skin:"#6ee7b7",hair:"#083d2f",item:"◈"},INFP:{bg:"#0d4a3a",skin:"#6ee7b7",hair:"#042e22",item:"♡"},
  ENFJ:{bg:"#0d4a3a",skin:"#6ee7b7",hair:"#0b5e4a",item:"☀"},ENFP:{bg:"#0d4a3a",skin:"#6ee7b7",hair:"#14654e",item:"✿"},
  ISTJ:{bg:"#1a5276",skin:"#85c1e9",hair:"#154360",item:"▣"},ISFJ:{bg:"#1a5276",skin:"#85c1e9",hair:"#0e3348",item:"♦"},
  ESTJ:{bg:"#1a5276",skin:"#85c1e9",hair:"#1b6d96",item:"▲"},ESFJ:{bg:"#1a5276",skin:"#85c1e9",hair:"#11527a",item:"◉"},
  ISTP:{bg:"#7d6608",skin:"#f9e79f",hair:"#6e5a06",item:"⚙"},ISFP:{bg:"#7d6608",skin:"#f9e79f",hair:"#4a3c04",item:"◆"},
  ESTP:{bg:"#7d6608",skin:"#f9e79f",hair:"#8b7209",item:"➤"},ESFP:{bg:"#7d6608",skin:"#f9e79f",hair:"#5c4d05",item:"♪"}
};

const LT = {
  E:{l:"外向型 (Extraversion)",d:"外の世界との交流からエネルギーを充電する。人が多い場所で活き活きとし、会話や活動を通じて思考を整理する。行動しながら考えるタイプで、社交的な刺激を自然と求める。",c:"#f97316"},
  I:{l:"内向型 (Introversion)",d:"内面の世界からエネルギーを充電する。深い対話や一人の時間を大切にし、じっくり考えてから発言する。少人数での親密な交流を好み、静かな環境で最も力を発揮する。",c:"#818cf8"},
  S:{l:"感覚型 (Sensing)",d:"五感を通じて得た具体的な情報を信頼する。「今ここ」の現実に集中し、経験や実績に基づいて判断を下す。細部への注意力が高く、実践的で着実なアプローチを好む。",c:"#14b8a6"},
  N:{l:"直感型 (iNtuition)",d:"パターンや隠れた意味を直感的に読み取る。未来の可能性にワクワクし、抽象的なアイデアや理論を自在に操る。「もしも」の世界を想像することが得意で、革新的な発想の源泉となる。",c:"#a855f7"},
  T:{l:"思考型 (Thinking)",d:"論理と客観的な基準に基づいて意思決定を行う。感情よりも事実やデータを重視し、公平さと一貫性を大切にする。問題を構造化して分析する能力に優れ、合理的な解決策を見出す。",c:"#3b82f6"},
  F:{l:"感情型 (Feeling)",d:"価値観と人への影響を考慮して判断する。相手の気持ちに敏感で、共感力を武器に調和のとれた環境を作る。人間関係の質を重視し、一人ひとりの事情を汲み取った温かい対応ができる。",c:"#ec4899"},
  J:{l:"判断型 (Judging)",d:"計画性と秩序を好み、物事を体系的に進める。期限を守り段取りを組むのが得意で、決断を先送りにしない。目標を設定してそこに向かって着実に前進する安心感をチームに与える。",c:"#64748b"},
  P:{l:"知覚型 (Perceiving)",d:"柔軟性と臨機応変さを大切にし、選択肢を残しておくことを好む。新しい情報が入れば軌道修正を厭わない。締切間際に爆発的な集中力を発揮し、変化を楽しむ適応力がある。",c:"#eab308"}
};

/* --- Expanded Profiles --- */
const PROF = {
  ISTJ:"責任感と誠実さの象徴。一度引き受けた仕事は何があっても最後までやり遂げる。ルールと伝統を重んじ、事実に基づいた堅実な判断を下す。記憶力が非常に優れており、過去の経験やデータを正確に引き出せる。感情表現は控えめだが、大切な人への愛情は日々の行動——約束を守る、必要なものを先回りして用意する——で静かに示す。組織のバックボーンとして欠かせない存在であり、チームが安心して動ける土台を作る縁の下の力持ちでもある。",
  ISFJ:"観察力と献身性を併せ持つ、コミュニティの守り手。周囲の些細な変化——体調の揺らぎや声のトーンの違い——にいち早く気づき、さりげなくサポートする天性のケアギバー。控えめな外見とは裏腹に内面は非常に強く、自分の信じる価値観を守るためには頑として譲らない。感謝されなくても黙々と献身し続けるその姿勢は、周囲からの揺るぎない信頼を自然と集める。記念日や相手の好みを驚くほど正確に記憶しており、心のこもったサプライズで人を感動させることが多い。",
  INFJ:"全タイプ中最も稀少とされる、神秘的な洞察力の持ち主。穏やかな外見の奥に、世界をより良くしたいという強烈なビジョンと使命感を秘めている。人の本質を見抜く直感は驚くほど正確で、相手本人すら気づいていない内面の葛藤や可能性を言い当てることがある。一人ひとりとの深い対話を好み、表面的な社交には疲弊しやすい。しかし心を開いた相手に対しては、生涯を通じた深い絆と無条件の信頼を寄せる。文章表現に非凡な才能を持つ人が多い。",
  INTJ:"常に5手先を読む戦略家。独自のビジョンを実現するために、緻密な計画を設計し着実に実行する。非効率と能力不足に対して厳しく、自分自身にも極めて高い基準を課す完璧主義者。一人の時間を最も生産的に活用でき、孤独をむしろエネルギーに変える稀有な能力を持つ。感情表現は不器用だが、理解者を得ると驚くほど忠実で深い絆を築く。複雑なシステムを俯瞰してボトルネックを見抜く力は、あらゆる組織で重宝される戦略的資産となる。",
  ISTP:"「まずやってみる」の精神で生きる実践派。機械やシステムの仕組みを直感的に理解し、手を動かしながら最適解を見つけ出す天性のエンジニア。普段はクールで寡黙だが、危機的状況では誰よりも冷静沈着に対応し、その場の全員を救う行動力を見せる。束縛を何より嫌い、自分のペースと空間を侵されると途端に距離を置く。道具や技術への深い愛着があり、一つのスキルを極限まで磨き上げる職人的な集中力は他の追随を許さない。",
  ISFP:"内に豊かな感性と美意識の泉を持つ、静かなアーティスト。色・音・質感・光の微妙なニュアンスを繊細に捉え、それを独自の表現に昇華させる。言葉で自分を説明するのは苦手だが、作品や行動を通じて深い内面世界を雄弁に語る。穏やかで争いを好まない平和主義者だが、自分の核となる価値観が侵害されたと感じたときには驚くほど強い抵抗を見せる。「今この瞬間」の美しさを味わう天才であり、その在り方は周囲の人々の心にも静かな癒やしをもたらす。",
  INFP:"内面に広大な感情の宇宙を持つ理想主義者。人の痛みに深く共感し、言葉にならない感情を見事に言語化する希有な才能を持つ。現実と理想のギャップに苦しむことがあるが、その葛藤こそが類まれな創造性の源泉となっている。価値観が合う仕事や関係では120%以上の力を発揮するが、魂が共鳴しない環境では急速にエネルギーを失う。複雑な人間心理を直感的に理解する力があり、カウンセリングや物語創作の分野で特に才能を開花させることが多い。",
  INTP:"純粋な知的好奇心の化身。複雑なシステムの中に美しい法則性を見出し、「なぜ？」を無限に追求し続ける。既存の常識を疑い、独自の理論フレームワークを構築することに深い喜びを感じる。普段は物静かだが、知的な議論になると別人のように饒舌になり、鮮やかな論理展開で相手を魅了する。社交的な場は苦手だが、同じ知的レベルで対話できる相手を見つけると生涯の友となる。プログラミングや数学など、論理的思考が要求される分野で圧倒的な能力を発揮する。",
  ESTP:"「今を全力で生きる」をそのまま体現するアクションヒーロー。リスクを恐れず直感と行動力で道を切り開き、交渉の場では持ち前の心理読みとカリスマ性で相手を動かす。五感が非常に鋭く、場の空気を瞬時に読んで最適な行動を取る天性の実務家。退屈が最大の敵で、刺激のない環境ではあっという間にモチベーションを失う。しかし困難な局面や緊急事態では本領を発揮し、周囲が凍りつく場面で唯一動ける「有事の人」として頼りにされる。",
  ESFP:"場の空気を一瞬で明るくする天性のエンターテイナー。その場にいるだけで周囲の緊張が解け、自然と笑顔が広がる不思議な魅力を持つ。五感のすべてを使って「今この瞬間」を最大限に楽しみ、その喜びを惜しみなく人と分かち合う。計画より直感で動くタイプだが、人を楽しませることに関しては天才的な段取り力を発揮する。共感力も高く、悩んでいる人のそばに自然と寄り添い、明るいエネルギーで心を軽くする名カウンセラーの一面も持つ。",
  ENFP:"好奇心と情熱のスパークプラグ。新しい可能性に出会うたびに目を輝かせ、その興奮を周囲に伝染させる天性のインフルエンサー。人の隠れた才能を見抜き、その可能性を本人以上に信じて全力で応援する。アイデアの量と発想の自由度は全タイプ中トップクラスで、ブレストの場では圧倒的な存在感を放つ。反面、一つのことを最後まで完遂するのは苦手で、次の面白いことに気を取られがち。自由と自己表現を何より大切にし、型にはめられることを本能的に拒む。",
  ENTP:"知的スリルを求め続ける「悪魔の代弁者」。あらゆる角度から物事を分析し、常識を覆す鮮やかな発想で周囲を驚かせる。議論を心から楽しみ、相手の論理の穴を瞬時に見つけて突く切れ味は全タイプ随一。既存の仕組みの非合理性に我慢ならず、「壊して再構築する」ことに情熱を燃やす改革者。複雑な問題ほど目が輝き、解決策にたどり着くまでの知的冒険そのものを楽しむ。口が達者で人を惹きつけるカリスマ性があるが、感情面のケアは意識的に学ぶ必要がある。",
  ESTJ:"組織の柱として揺るぎない安定をもたらすリーダー。明確なルールと目標を設定し、チーム全員が迷わず動ける仕組みを構築する。公平で一貫性があり、約束を必ず守るその姿勢は周囲から絶大な信頼を集める。効率を追求し曖昧さを嫌うため、即断即決で物事を前に進める推進力がある。やや柔軟性に欠ける面はあるが、それは「全員が同じ基準で評価される公正な世界」を本気で実現しようとする真摯さの裏返しでもある。危機管理やプロジェクト統制で真価を発揮する。",
  ESFJ:"コミュニティの心臓部。周囲の一人ひとりの状態を細やかに把握し、必要なサポートを的確なタイミングで提供する。その場の調和を何より大切にし、全員が居心地よく過ごせる環境づくりに情熱を注ぐ。社交性と実務力を兼ね備え、イベントの企画から人間関係の調整まで幅広くこなすマルチプレイヤー。他者からの評価や感謝に敏感で、自分の献身が認められないと深く傷つくことがある。しかしその繊細さこそが、誰も気づかない小さなSOSを拾い上げる力の源泉となっている。",
  ENFJ:"生まれながらのメンター。人の内に眠る可能性を驚くほど正確に見抜き、その才能を最大限に引き出すことに心からの喜びを感じる。カリスマ性と共感力を兼ね備え、言葉と態度で人の心を動かし行動を促す天性のリーダー。一対一の深い対話を通じて人を変革する力は全タイプ中随一で、教育やコーチングの場面で圧倒的な成果を上げる。ただし他者のために尽くしすぎて自分を後回しにする傾向があり、意識的なセルフケアが長期的な活躍の鍵となる。",
  ENTJ:"天性のCEO気質。壮大なビジョンを描き、それを実現するために必要な戦略・人材・リソースを的確に配置する。論理と決断力で組織を動かし、困難な状況でも堂々と先頭に立ってチームを牽引する。効率と成果を徹底追求する一方で、有能な人材を正当に評価し引き上げる器の大きさも持つ。感情面への配慮は意識的な努力が必要だが、信頼する仲間には意外なほど誠実で面倒見が良い。長期ビジョンの策定と組織の大変革において、ENTJ以上に適任な人材は稀である。"
};

const LOV = {
  ISTJ:{s:"信頼構築型",d:"言葉よりも行動で愛を示す堅実なパートナー。約束を守ること、安定した生活基盤を築くこと、日々の責任を誠実に果たすことが最大の愛情表現。派手なロマンスは得意ではないが、長い年月をかけて揺るぎない信頼関係を構築する。一度「この人」と決めたら浮気とは無縁の一途さを持つ。",n:"安定した関係性と互いの信頼",g:"経済的安定・誠実さ・計画力",warn:"感情表現の少なさにパートナーが不安を感じることがある"},
  ISFJ:{s:"献身奉仕型",d:"相手の好み・習慣・過去の何気ない一言まで全て記憶する驚異的な記憶力の持ち主。自分の欲求よりもパートナーの幸せを優先する生粋の尽くし屋。記念日やサプライズに全力を注ぎ、日常の中に温かい「特別」を散りばめる天才。愛情の深さに比べて、自分のニーズを伝えるのは苦手。",n:"感謝の言葉と安心できる居場所",g:"無条件の愛情・細やかなケア・安定感",warn:"自己犠牲が過ぎると不満が蓄積しやすい"},
  INFJ:{s:"魂接続型",d:"表面的な恋愛には全く興味がなく、魂レベルでの深い繋がりを求める。直感で「この人だ」と確信すると心の扉を開くが、そこに至るまでのハードルは非常に高い。一度信頼したパートナーには生涯揺るがない忠誠心を捧げる。相手の心の奥底にある欲求を言葉にされる前に察知する不思議な力を持つ。",n:"精神的な深い共鳴と本音の対話",g:"洞察力・揺るがない忠誠心・精神的なサポート",warn:"理想と現実のギャップに苦しみやすい"},
  INTJ:{s:"戦略分析型",d:"恋愛さえも無意識に分析してしまう知的なパートナー。好きという感情を認めるまでに時間がかかるが、一度認識すると非常に一途。知的に対等な会話ができ、互いの成長を促し合える関係を理想とする。愛情表現は不器用だが、パートナーの人生設計を本気で一緒に考え、問題解決に全力を注ぐ。",n:"知的刺激と互いの自立を尊重する関係",g:"問題解決力・将来への計画性・揺るがない忠誠心",warn:"感情面の表現が乏しく、冷たく映ることがある"},
  ISTP:{s:"自由共存型",d:"束縛を何より嫌う自由な恋愛スタイル。好きな相手にも態度があまり変わらないクールさが特徴だが、内面では深い愛情を持っている。言葉より行動派で、パートナーが困った時に黙って駆けつけて問題を解決する姿が最大の愛情表現。互いの独立性を保ちながら並走する関係を理想とする。",n:"個人の自由と干渉しすぎない距離感",g:"いざという時の頼もしさ・実務的サポート力",warn:"感情表現が少なすぎて愛されている実感を与えにくい"},
  ISFP:{s:"感性共鳴型",d:"美しい景色・音楽・食事を共有する五感で繋がる恋愛スタイル。言葉よりも雰囲気と体験で愛を伝え、パートナーとの何気ない日常の中に芸術的な美を見出す。争いを避ける穏やかさの中に強い愛情を秘めており、パートナーの個性と自由を心から尊重する。繊細なタッチや気配りで相手をそっと包み込む。",n:"感性の共有と自由な自己表現",g:"繊細な気配り・審美眼・穏やかな癒やし",warn:"不満を溜め込みやすく、突然距離を置くことがある"},
  INFP:{s:"理想追求型",d:"心の最も深い場所で繋がれる「運命の相手」を探し続けるロマンチスト。恋愛に対して非常に豊かな想像力と期待を持ち、パートナーの中に他の誰も気づかない美しさを見出す。共感力が極めて高く、相手の痛みを自分のことのように感じ取る。理想が高い分、現実とのギャップに苦しむこともあるが、それでも諦めない純粋さが最大の魅力。",n:"精神的な深い繋がりと魂の共鳴",g:"深い共感力・無条件の受容・創造的な愛情表現",warn:"理想化しすぎて現実のパートナーに失望しやすい"},
  INTP:{s:"知的探究型",d:"恋愛を一種の知的探究として捉える独特のアプローチ。好きな人の思考パターンを無意識に分析し、理解しようとする。感情表現は極めて控えめだが、パートナーに対しては驚くほどの忠誠心と深い思いやりを持つ。知的な会話が最大のスキンシップであり、一緒に新しい発見をする喜びを分かち合えるのが理想。",n:"知的刺激と自由な思考空間の尊重",g:"独創的な視点・問題解決力・忠実さ",warn:"感情的なニーズを察するのが苦手で鈍感に映ることがある"},
  ESTP:{s:"情熱体験型",d:"一緒にいて退屈しない刺激的な恋愛を提供するアクション派。好きになったら情熱的にアプローチし、デートは常にサプライズと冒険に満ちている。行動力があり頼りがいは抜群だが、長期的なコミットメントよりも「今この瞬間の盛り上がり」を重視しがち。感情的な深い対話よりも一緒に体験を共有することで愛を深める。",n:"刺激・自由・一緒に冒険できる関係",g:"行動力・カリスマ性・楽しい時間の提供",warn:"飽きっぽさと感情的な深みの不足が課題になりやすい"},
  ESFP:{s:"全力エンジョイ型",d:"好きになったら全力でアプローチし、パートナーとの時間を最大限に楽しむ情熱家。サプライズの天才で、常に新しい楽しみを見つけてきてくれる。その場の空気を読む力に長け、パートナーが落ち込んでいる時には絶妙なタイミングで元気づける。楽しさと愛情を惜しみなく注ぐ、一緒にいて飽きない太陽のような存在。",n:"楽しさ・注目・感謝の言葉",g:"明るいエネルギー・エンタメ力・共感力",warn:"シリアスな話題を避けがちで深い対話が不足することがある"},
  ENFP:{s:"可能性探索型",d:"恋に落ちやすく、相手の可能性を誰よりも信じて全力応援する情熱家。パートナーの夢や目標に深い関心を持ち、その実現のために一緒に奔走する。新鮮さと自由を重視するため、マンネリ化した関係には息苦しさを感じる。心の深い部分で繋がりたいという欲求が強く、表面的な関係では満足できない。",n:"精神的な深い繋がりと自由な関係",g:"無限の励まし・創造的な愛情表現・人生を豊かにする発想",warn:"新しい出会いに気を取られやすく、一途さが足りないと思われることがある"},
  ENTP:{s:"知的スパーリング型",d:"知的な刺激がない恋愛は続かない。パートナーとの議論やディベートが最高のコミュニケーション。相手の知性を尊敬でき、互いに知的成長を促し合える関係を求める。ユーモアのセンスが独特で、一緒にいると笑いが絶えない。ただし感情的なケアは意識的に学ぶ必要があり、パートナーの感情面のニーズを軽視しがち。",n:"知的挑戦と新しい体験・議論できる関係",g:"ユーモア・斬新な視点・知的成長の刺激",warn:"議論が白熱して相手の感情を傷つけることがある"},
  ESTJ:{s:"計画実行型",d:"恋愛にも真面目で誠実に向き合う頼れるパートナー。将来の人生設計をしっかり立て、パートナーと共に着実にステップを踏んでいく。約束は絶対に守り、経済的にも精神的にも安定した家庭を築くことに強いコミットメントを持つ。愛情表現はロマンティックというより実務的だが、その堅実さが安心感を生む。",n:"秩序・誠実さ・互いの役割の明確さ",g:"経済的安定・計画力・揺るがない信頼性",warn:"柔軟性に欠け、パートナーの感情的ニーズを見落としやすい"},
  ESFJ:{s:"献身ケア型",d:"愛情深く世話焼きなパートナー。パートナーだけでなくその家族や友人も含めた「家族全体」を大切にする。記念日は絶対に忘れず、日常の中に温かいサプライズを散りばめる。感謝と愛情の言葉を頻繁に伝え、それと同等のリアクションを求める。コミュニティの中心として温かい人間関係のネットワークを築く天才。",n:"感謝の言葉・愛情表現・家族の調和",g:"温かいケア・社交的なサポート・安定感",warn:"過干渉になりがちで、パートナーの自由を制限してしまうことがある"},
  ENFJ:{s:"成長伴走型",d:"パートナーの夢と成長を全力でサポートする献身的なメンター型恋人。相手の可能性を誰よりも信じ、その才能を引き出すことに情熱を注ぐ。深い精神的なつながりと相互成長を理想とし、関係を通じて二人とも成長していくことを目指す。カリスマ性と包容力で相手を安心させつつ、高みへと導く。",n:"深い精神的絆と感謝の気持ち",g:"成長支援・カリスマ的包容力・深い共感",warn:"自分を犠牲にしすぎてバーンアウトすることがある"},
  ENTJ:{s:"戦略パートナー型",d:"恋愛にも明確な目標とビジョンを持つ。対等な立場で互いに高め合い、パワーカップルとして共に成功を目指す関係が理想。パートナーには知性と野心を求め、依存的な関係は好まない。リーダーシップがあり、二人の将来を力強くリードする。直接的で率直なコミュニケーションを好み、駆け引きや曖昧さは苦手。",n:"対等な関係・知的刺激・共に成長する野心",g:"リーダーシップ・決断力・経済的安定・成長支援",warn:"支配的になりがちで、パートナーの自主性を侵害することがある"}
};

const WK = {
  ISTJ:{d:"黙々と正確にタスクをこなす職人気質。マニュアルと期限を厳守し、品質の一貫性を保つ鉄壁の安定感を持つ。データと事実に基づいた意思決定を好み、曖昧な指示には苦手意識がある。組織の規律を守り、全員が同じ基準で動ける環境を整える縁の下の力持ち。",str:["正確性","責任感","時間管理","データ分析"],weak:["変化への適応","曖昧な指示への対応"],j:["会計士","品質管理","法務","公務員","銀行員","システム管理者"],bp:["ESFP","ESTP","ISFJ"],wm:"ENFP"},
  ISFJ:{d:"チームの空気を読み、メンバーのニーズを誰よりも早く察知する観察力の持ち主。地道な作業を嫌がらず、周囲が避けるような面倒な仕事も黙々とこなす。新人や困っているメンバーに自然と手を差し伸べる姿勢が、チーム全体の心理的安全性を支えている。",str:["観察力","サポート力","継続力","記憶力"],weak:["自己主張","急な変化への対応"],j:["看護師","人事","秘書","教師","社会福祉士","図書館司書"],bp:["ESFP","ESTP","ISTJ"],wm:"ENTP"},
  INFJ:{d:"静かにビジョンを描き、着実に実現する稀有な存在。大人数の会議よりも1on1で真価を発揮し、相手の本質を見抜いた上で的確なアドバイスを提供する。文章での表現力は抜群で、複雑なコンセプトを人の心に響く言葉に変換する能力が際立つ。",str:["洞察力","ビジョン","文章力","1on1コーチング"],weak:["大人数対応","自己開示","政治的駆け引き"],j:["カウンセラー","作家","教育者","UXデザイナー","心理学者","コンサルタント"],bp:["ENFP","ENTP","INTJ"],wm:"ESTP"},
  INTJ:{d:"戦略を立てて組織の効率を最大化する参謀役。独立して最高のパフォーマンスを発揮し、複雑なシステムの設計と最適化を得意とする。長期的な視野でリスクを予測し、組織が陥りがちな罠を事前に回避する先見性がある。",str:["戦略立案","分析力","効率化","システム設計"],weak:["対人コミュニケーション","チームの感情面への配慮"],j:["経営戦略","シンクタンク","プログラマー","研究職","コンサルタント","投資アナリスト"],bp:["ENFP","ENTP","INFJ"],wm:"ESFP"},
  ISTP:{d:"問題が起きた時に最も頼りになる人材。現場対応力は全タイプ随一で、複雑なトラブルを冷静に分析して最短ルートで解決する。手を動かしながら考えるタイプで、理論よりも実践から最適解を導き出す。自由度の高い環境で最も力を発揮する。",str:["問題解決","現場対応","技術力","危機管理"],weak:["ルーティンワーク","報連相の継続"],j:["エンジニア","整備士","プログラマー","消防士","パイロット","データアナリスト"],bp:["ESTJ","ENTJ","ISFP"],wm:"ENFJ"},
  ISFP:{d:"美意識と独自の感性で創造的な価値を生み出すクリエイター。既存の枠にとらわれない自由な発想が持ち味で、デザインやアートの分野で唯一無二の作品を生む。マニュアル通りの仕事よりも、自分の感性を活かせる裁量の大きい環境で輝く。",str:["創造性","美的センス","共感力","細部へのこだわり"],weak:["管理業務","長期的な計画策定"],j:["デザイナー","アーティスト","シェフ","獣医","写真家","フローリスト"],bp:["ESTJ","ENTJ","ISTP"],wm:"ENTJ"},
  INFP:{d:"理念に共感できる仕事なら120%以上の力を引き出せるが、価値観と合わない環境では急速にエネルギーを失う。「なぜこの仕事が世界に必要なのか」という意味を感じられることが、INFPにとって最大のモチベーション源。人の内面を深く理解する力を活かした対人支援の仕事で特に才能を発揮する。",str:["共感力","創造的表現","言語化力","倫理的判断"],weak:["効率重視の環境","対立状況での主張"],j:["作家","カウンセラー","NPO職員","編集者","心理士","UXライター"],bp:["ENFJ","ENTJ","INFJ"],wm:"ESTJ"},
  INTP:{d:"複雑な問題を解くこと自体が最大の喜び。「なぜ」を飽くことなく追求し、独自の理論フレームワークで問題を再定義する能力が際立つ。アイデアの質と独創性では全タイプ中トップクラスだが、実装フェーズでは他タイプのサポートが有効。知的自由が保障された環境で圧倒的な成果を出す。",str:["論理分析","革新的発想","問題の再定義","抽象的思考"],weak:["コミュニケーション","締切管理","実装の完遂"],j:["研究者","データサイエンティスト","プログラマー","ゲーム開発者","哲学者","アナリスト"],bp:["ENTJ","ENFJ","INTJ"],wm:"ESFJ"},
  ESTP:{d:"行動力で道を切り開くセールスの天才。交渉の場では持ち前の心理読みと瞬発力で相手を動かし、困難な商談も次々とまとめる。座学や理論よりも現場での実践から学ぶタイプで、スピード感のある環境で本領を発揮する。退屈なルーティンワークは天敵。",str:["交渉力","瞬発力","現場対応","リスクテイク"],weak:["デスクワーク","長期的な計画策定"],j:["営業","起業家","スポーツ関連","イベント企画","不動産","レスキュー隊"],bp:["ISFJ","ISTJ","INFJ"],wm:"INFJ"},
  ESFP:{d:"場を盛り上げるムードメーカーとして、チームの士気向上に貢献する。プレゼンテーションや接客の場面では天性の才能を発揮し、どんな相手ともすぐに打ち解ける。柔軟性が高く、予想外の状況でも即座に適応して楽しみに変える力がある。",str:["プレゼン力","ムード作り","柔軟性","対人スキル"],weak:["事務的な作業","長時間の集中"],j:["販売職","ツアーガイド","パフォーマー","広報","イベント企画","インテリアコーディネーター"],bp:["ISFJ","ISTJ","INFP"],wm:"INTJ"},
  ENFP:{d:"アイデアの量と発想の自由度は全タイプ中トップクラス。企画の初期段階ではブレスト全体を牽引する圧倒的な存在感を放つ。人の可能性を引き出し、モチベートする天性の才能があり、チームビルディングやカルチャー醸成で特に力を発揮する。",str:["発想力","モチベーション付与","人脈形成","ストーリーテリング"],weak:["完遂力","ルーティン作業"],j:["企画職","広報","マーケター","カウンセラー","起業家","ブランドストラテジスト"],bp:["INTJ","INFJ","ENTJ"],wm:"ISTJ"},
  ENTP:{d:"既存の仕組みの非合理性を見抜き、壊して再構築する改革者。問題の本質を誰よりも早く見抜き、鮮やかな切り口で解決策を提示する。ディベート力は全タイプ随一で、複雑な利害関係者間の議論でも的確に論点を整理し合意形成に導く。",str:["革新力","ディベート力","問題の本質を見抜く力","戦略的思考"],weak:["ルーティンの継続","感情面のケア"],j:["コンサルタント","弁護士","起業家","プロダクトマネージャー","記者","ベンチャーキャピタリスト"],bp:["INFJ","INTJ","ENFJ"],wm:"ISFJ"},
  ESTJ:{d:"組織の柱としてプロジェクトを確実にゴールまで導く統率者。明確なルールと期限を設定し、全メンバーが迷わず動ける仕組みを構築する。プロジェクト管理のプロフェッショナルで、複数のタスクを同時進行で的確にコントロールする能力に長ける。",str:["管理能力","実行力","組織構築","進捗管理"],weak:["柔軟な対応","メンバーの感情面への配慮"],j:["プロジェクトマネージャー","管理職","経営者","裁判官","軍人","経営コンサルタント"],bp:["ISFP","ISTP","INFP"],wm:"INFP"},
  ESFJ:{d:"チーム全体の調和と雰囲気を守るガーディアン。メンバー一人ひとりの状態を把握し、モチベーションが下がっている人にはタイムリーなケアを提供する。採用面接やオンボーディングでの人を見る目は確かで、チームカルチャーの醸成と維持に不可欠な存在。",str:["チームケア","調整力","信頼構築","採用・オンボーディング"],weak:["厳しいフィードバック","批判への耐性"],j:["人事","教師","看護師","広報","ホテルマネージャー","カスタマーサクセス"],bp:["ISFP","ISTP","INFP"],wm:"INTP"},
  ENFJ:{d:"人を育てる天才。1on1やメンタリングの場面では全タイプ中最も効果的なコーチングを提供し、メンバーの自信と能力を驚くほど短期間で引き上げる。ビジョンを語る説得力と、個々の事情に寄り添う共感力の両方を兼ね備えた理想的なピープルマネージャー。",str:["リーダーシップ","人材育成","プレゼン","共感型マネジメント"],weak:["自己犠牲的傾向","完璧主義"],j:["教育者","HRマネージャー","コーチ","広報","政治家","NGO代表"],bp:["INFP","INTP","ISFP"],wm:"ISTP"},
  ENTJ:{d:"組織のCEOポジションに最も適性がある天性の経営者気質。ビジョン策定→戦略立案→実行→検証のサイクルを高速で回し、組織を着実にゴールに導く。困難な決断も躊躇なく下すことができ、変革期のリーダーシップで圧倒的な成果を上げる。",str:["決断力","統率力","戦略思考","変革推進"],weak:["感情面への配慮","ディテールの確認"],j:["経営者","戦略コンサルタント","投資家","弁護士","事業責任者","ベンチャー経営者"],bp:["INFP","INTP","ENFP"],wm:"ISFP"}
};

const TR = {ISTJ:"品質管理・規律整備",ISFJ:"チームケア・安定サポート",INFJ:"ビジョン策定・1on1コーチ",INTJ:"戦略立案・システム最適化",ISTP:"トラブルシューティング",ISFP:"クリエイティブ・感性デザイン",INFP:"価値観の言語化・文化醸成",INTP:"技術研究・論理的問題解析",ESTP:"営業突破・現場推進",ESFP:"プレゼン・チーム活性化",ENFP:"企画ブレスト・カルチャー構築",ENTP:"イノベーション・制度改革",ESTJ:"プロジェクト統制・進捗管理",ESFJ:"チーム調和・採用オンボーディング",ENFJ:"人材育成・メンタリング",ENTJ:"経営判断・組織牽引"};

const QT = {ISTJ:["「前例はあるの？」","「期限は守るもの」","「マニュアルに書いてある」","「データで示して」"],ISFJ:["「大丈夫？何か手伝おうか」","「去年の今頃は…」","「みんなが笑顔ならそれでいい」"],INFJ:["「なんとなくそうなる気がしてた」","「本当にそれでいいの？」","「人は変われると信じてる」"],INTJ:["「非効率すぎる、改善しよう」","「3手先まで読んでる」","「感情論はやめてくれ」"],ISTP:["「とりあえずバラしてみよう」","「触らせて」","「別に」","「やってみればわかる」"],ISFP:["「自分のペースでやらせて」","「言葉にするの難しいんだけど…」","「きれい…」"],INFP:["「それって本当に正しいの？」","「理想を捨てたくない」","「何かが違う気がする」"],INTP:["「面白い仮説を思いついた」","「まず定義を明確にしよう」","「論理的におかしい」"],ESTP:["「考えてないで動けば？」","「人生一回きりだろ」","「やってから考えよう」"],ESFP:["「楽しくなきゃ意味ない！」","「今を生きよう！」","「なんとかなるって」"],ENFP:["「聞いて聞いて！すごいこと思いついた！」","「可能性は無限大」","「面白そう、やってみよう！」"],ENTP:["「反例があるんだけど」","「常識を疑え」","「それ、本当にベスト？」"],ESTJ:["「結論から言って」","「期限と担当者を決めよう」","「ルールはルール」"],ESFJ:["「ご飯ちゃんと食べた？」","「みんなの意見も聞いてみよう」","「調和が大事」"],ENFJ:["「君ならきっとできる」","「もっと成長できるよ」","「一緒に頑張ろう」"],ENTJ:["「ゴールは何？」","「最適解を出せ」","「時間がないぞ」"]};

const BP = {INTJ:["ENFP","ENTP"],INTP:["ENTJ","ENFJ"],INFJ:["ENFP","ENTP"],INFP:["ENFJ","ENTJ"],ISTJ:["ESFP","ESTP"],ISFJ:["ESFP","ESTP"],ESTJ:["ISFP","ISTP"],ESFJ:["ISFP","ISTP"],ENTJ:["INFP","INTP"],ENFJ:["INFP","ISTP"],ENTP:["INFJ","INTJ"],ENFP:["INFJ","INTJ"],ESTP:["ISFJ","ISTJ"],ESFP:["ISFJ","ISTJ"],ISTP:["ENFJ","ESTJ"],ISFP:["ESTJ","ESFJ"]};

const REL = {IT:{l:"マイペースな天才肌",i:"🧠",c:"#818cf8",d:"論理で世界を解読する孤高の存在。自分の知的世界を持ち、信頼した相手にだけその扉を開く。感情表現は苦手だが忠誠心は絶大。",lv:"感情より行動で示す。信頼を得るまで時間がかかるが一度心を開くと驚くほど一途。",stt:"感情的な要求が続くとシャットダウンし殻に閉じこもる。"},ET:{l:"情熱のカリスマリーダー",i:"🔥",c:"#ef4444",d:"アップテンポで効率第一。チームを引っ張るリーダーシップは本能レベル。勝負の場で最も輝く。",lv:"主導権を握りたいタイプ。好きな人には情熱的に直球アプローチ。",stt:"自分のペースを乱されると一気にフラストレーションが爆発する。"},IF:{l:"穏やかな繊細アーティスト",i:"🌿",c:"#33b98a",d:"繊細な感受性とアーティスティックな内面世界を持つ。平和主義だが価値観の芯は鋼のように強い。",lv:"精神的なつながりを最も重視。言葉より態度や雰囲気で愛情を示す。",stt:"価値観を否定されると深く傷つき、回復に時間がかかる。"},EF:{l:"みんなを照らす太陽",i:"☀️",c:"#e4ae3a",d:"人を笑顔にすることが使命。常に誰かと繋がっていたい社交の星。感情的なつながりが生命線。",lv:"記念日・サプライズに全力投球。同じ熱量のリアクションを期待しがち。",stt:"無視や孤立が最大の恐怖。感謝されないと急速にモチベーションが低下する。"}};
const GE = {SF:{l:"あったかファミリー",i:"🏠",h:"ハッフルパフ",c:"#fbbf24",d:"温かい気配りと安心感に満ちた環境を築く。記念日を大切にし、メンバーの個人的な事情にも心を配る。",w:"チームの潤滑油。細やかな気配りで職場の雰囲気を明るくし、メンバー間の信頼関係を育む。"},ST:{l:"プロフェッショナル集団",i:"💼",h:"スリザリン",c:"#6b7280",d:"整理整頓・効率重視。感情よりもデータと結果で語る実力主義の環境を好む。",w:"数字で成果を示す。マニュアル化・業務改善・品質管理のプロフェッショナル。"},NF:{l:"未来を語る理想家集団",i:"🌈",h:"グリフィンドール",c:"#a78bfa",d:"「世界をより良くする」が合言葉。ビジョンと情熱で仲間を鼓舞し、大きな夢に向かって団結する。",w:"ビジョンと共感力でチームを動かす。メンバーの成長と組織の理念を一致させる架け橋。"},NT:{l:"知的エリート研究室",i:"🔬",h:"レイブンクロー",c:"#3b82f6",d:"「なぜ？」が口癖。知的好奇心の塊が集まり、複雑な問題を理論と分析で解き明かす。",w:"戦略立案・技術革新・問題分析の中核。データと論理で組織の方向性を定める。"}};
const ECO = {ES:{l:"リア充アクティブ派",i:"🏖️",c:"#f97316",d:"フットワークが軽くトレンドに敏感。人が集まる場所にエネルギーを感じ、体験を通じて人生を楽しむ。",q:"沈黙や退屈に耐えられない。常に次の予定を入れていないと不安になる。"},EN:{l:"未来のビジョナリー",i:"🚀",c:"#a855f7",d:"現状維持＝退屈。常に頭の中で新しいアイデアが渋滞を起こしている。可能性の追求が生きがい。",q:"話が突然飛ぶ。3つ先の話題に移動して周囲がついてこれない。"},IS:{l:"穏やかな安心キーパー",i:"🧸",c:"#14b8a6",d:"安定感と穏やかさの象徴。少人数での深い交流を好み、信頼できる人と過ごす静かな時間に幸せを感じる。",q:"褒められると固まる。突然の予定変更が最大のストレス源。"},IN:{l:"内省する哲学者",i:"📚",c:"#818cf8",d:"独自の価値観と哲学を持ち、深く考えること自体に喜びを感じる。内面世界の豊かさは全タイプ随一。",q:"考えすぎて眠れない夜がある。頭の中の対話が止まらない。"}};
const SR = {FP:{l:"価値観ファイター",i:"🎯",c:"#ec4899",d:"自分の価値観と自由を最優先に据える。本質を見抜く直感力があり、嘘や偽りを本能的に見破る。",m:"「それ本当に必要？」と核心を突く。無駄を削ぎ落とし本当に大切なものを浮かび上がらせる。"},FJ:{l:"調和のガーディアン",i:"🤝",c:"#0ea5e9",d:"場の雰囲気を守る調整役。対立を感知すると自然と間に入り、全員が納得する落とし所を見つける。",m:"全員の意見を引き出し、優先順位をつけてまとめ上げる。会議の空気を読むプロ。"},TP:{l:"論理の切れ者",i:"🐺",c:"#f43f5e",d:"合理性を追求する鋭い思考の持ち主。無駄を嫌い、最短ルートで核心にたどり着く。",m:"「で、結論は？」会議のムダを省き、論理の穴を瞬時に指摘。問題解決のスピードが段違い。"},TJ:{l:"目標達成マシーン",i:"⚙️",c:"#64748b",d:"効率と結果を重視し、計画を立て規律を守る。ゴールから逆算して行動する戦略的実行者。",m:"アジェンダ設定、時間管理、ネクストアクションの明確化。会議を成果に直結させる。"}};
const LS = {EJ:{l:"目的達成の推進者",i:"🏆",c:"#eab308",d:"「やると決めたことは必ずやる」が信条。目標に向かって周囲を巻き込む強力な推進力を持つ。",mt:"「決めたらやる。言い訳は聞かない」"},IJ:{l:"確実な道筋の設計者",i:"🗺️",c:"#0891b2",d:"綿密な計画と内面の強さで、確実にゴールにたどり着く。派手さはないが信頼性は抜群。",mt:"「準備がすべて。備えあれば憂いなし」"},EP:{l:"自由な冒険者",i:"🎲",c:"#d946ef",d:"人生の選択は自分で決める。型にはまらない生き方を貫き、予定調和を嫌う自由な精神の持ち主。",mt:"「後悔だけはしたくない。やらない後悔よりやる後悔」"},IP:{l:"静かなる求道者",i:"🧘",c:"#059669",d:"自分の内なる声に従い、信念を貫く。外からの評価より自分自身が納得できるかを重視する。",mt:"「自分に嘘をつかない。それだけは譲れない」"}};
const TAL = {NJ:{l:"パーフェクト型",i:"💎",c:"#7c3aed",s:"高い目標を掲げ、カリスマ性と計画力で組織を牽引する。ビジョンを現実に変える実行力が強み。",sp:"未来予測 — まだ誰も見ていない可能性を先取りする直感力"},SJ:{l:"ディテール型",i:"🔍",c:"#0284c7",s:"現実的で几帳面。ルールとの整合性を保ちながら、コツコツと信頼を積み上げていく堅実さが武器。",sp:"ミス発見 — 他の誰もが見落とす小さなズレを確実に捕捉する眼力"},NP:{l:"イノベーション型",i:"💡",c:"#ea580c",s:"好奇心旺盛で変化を楽しむ。退屈を最も恐れ、常に新しい可能性を追求し続けるイノベーター。",sp:"発想転換 — 行き詰まった状況で全く新しい切り口を見出す閃き"},SP:{l:"パフォーマンス型",i:"⚡",c:"#dc2626",s:"圧倒的な行動力と現実への適応力。瞬間的な判断と実行のスピードで他を圧倒する。",sp:"瞬間対応 — 予想外の事態に即座に反応し最適な行動を取る反射神経"}};

/* ═══════════════════════════════════════════════
   心理機能 (Cognitive Function Stacks)
   ═══════════════════════════════════════════════ */
var CF_INFO = {
  Ni:{name:"内向的直感",abbr:"Ni",icon:"🔮",c:"#a855f7",d:"未来のパターンや本質を直感的に見抜く力。「なんとなくこうなる気がする」という予感が高い精度で的中する。表面に見えない深い意味やつながりを無意識に読み取る。"},
  Ne:{name:"外向的直感",abbr:"Ne",icon:"💡",c:"#f59e0b",d:"可能性とアイデアを無限に広げる力。一つの情報から連想ゲームのように発想が飛躍し、「こうしたらどうなる？」と常に新しい切り口を見つけ出す。"},
  Si:{name:"内向的感覚",abbr:"Si",icon:"📚",c:"#0891b2",d:"過去の経験やデータを精密に記憶し、現在に活かす力。「以前こうだったから」という経験則が判断の土台になる。安定感と再現性を重視する。"},
  Se:{name:"外向的感覚",abbr:"Se",icon:"⚡",c:"#dc2626",d:"今この瞬間の現実を五感でリアルに捉える力。環境の変化に素早く反応し、身体感覚を通じて世界と深くつながる。行動力とスピード感が武器。"},
  Ti:{name:"内向的思考",abbr:"Ti",icon:"🧩",c:"#3b82f6",d:"内面で独自の論理体系を組み立てる力。「これは本当に正しいのか？」と原理原則から徹底的に検証する。矛盾を見抜く鋭さに長ける。"},
  Te:{name:"外向的思考",abbr:"Te",icon:"📊",c:"#059669",d:"効率と結果を追求し、外部のシステムを整える力。データや事実に基づいて素早く判断し、計画を実行に移す推進力がある。"},
  Fi:{name:"内向的感情",abbr:"Fi",icon:"💎",c:"#ec4899",d:"自分の内なる価値観や信念に基づいて判断する力。「自分にとって何が本当に大切か」を深く理解しており、その軸がブレない。真実と誠実さを重んじる。"},
  Fe:{name:"外向的感情",abbr:"Fe",icon:"🤝",c:"#8b5cf6",d:"他者の感情を敏感に読み取り、場の調和を保つ力。グループの雰囲気を自然とまとめ上げ、全員が心地よくいられる環境を作り出す。"}
};
var CF_ROLE = [
  {name:"主機能",sub:"最も得意な心の武器",c:"#33b98a",icon:"👑",bar:95},
  {name:"補助機能",sub:"主機能を支えるパートナー",c:"#3b82f6",icon:"🛡️",bar:75},
  {name:"第三機能",sub:"成長とともに開花するポテンシャル",c:"#eab308",icon:"🌱",bar:45},
  {name:"劣等機能",sub:"ストレス時に顔を出す弱点",c:"#ef4444",icon:"⚠️",bar:20}
];
var CF_STACK = {
  INTP:["Ti","Ne","Si","Fe"],INTJ:["Ni","Te","Fi","Se"],INFP:["Fi","Ne","Si","Te"],INFJ:["Ni","Fe","Ti","Se"],
  ISTP:["Ti","Se","Ni","Fe"],ISTJ:["Si","Te","Fi","Ne"],ISFP:["Fi","Se","Ni","Te"],ISFJ:["Si","Fe","Ti","Ne"],
  ENTP:["Ne","Ti","Fe","Si"],ENTJ:["Te","Ni","Se","Fi"],ENFP:["Ne","Fi","Te","Si"],ENFJ:["Fe","Ni","Se","Ti"],
  ESTP:["Se","Ti","Fe","Ni"],ESTJ:["Te","Si","Ne","Fi"],ESFP:["Se","Fi","Te","Ni"],ESFJ:["Fe","Si","Ne","Ti"]
};
var CF_STRESS = {
  INTP:"ストレスが限界に達すると、普段は無頓着な他者の評価が突然気になり始め、「みんなに嫌われているのでは」と感情的になる。",
  INTJ:"追い込まれると、細部へのこだわりや快楽への暴走（暴食・衝動買い等）という普段とは真逆の行動が表出する。",
  INFP:"過度のストレスで突然冷徹なロジックを振りかざし、周囲を論破しようとする攻撃的な一面が現れる。",
  INFJ:"限界時に五感の刺激に溺れる（過食・散財等）か、「もう誰も自分を理解してくれない」と完全に殻に閉じこもる。",
  ISTP:"感情を溜め込みすぎると突然爆発し、普段は絶対に言わないような感情的な言葉で周囲を驚かせる。",
  ISTJ:"ストレス過多で「最悪の未来」ばかりが見えるようになり、普段の冷静さを失って破滅的な予測に囚われる。",
  ISFP:"追い詰められると急にデータや論理で武装し、冷たく批判的な態度で周囲を切り捨てようとする。",
  ISFJ:"限界を超えると「もう全部どうでもいい」と投げやりになり、普段の献身的な姿からは想像できない無関心さを見せる。",
  ENTP:"ストレスで突然、過去の細かい失敗やトラウマに囚われ、普段の楽観性が消えてネガティブなループに陥る。",
  ENTJ:"感情を無視し続けた結果、「誰も自分の気持ちを分かってくれない」と突然感傷的になり、孤独感に苛まれる。",
  ENFP:"過度な疲労で急に細部が気になり始め、体調の些細な変化に不安を覚えたり、ルーティンに固執したりする。",
  ENFJ:"限界時に「自分のことは自分で決めろ」と突然冷たく突き放し、普段の温かさが嘘のように消える。",
  ESTP:"追い込まれると「どうせ未来は暗い」と悲観的な妄想に囚われ、普段のポジティブさが完全に消失する。",
  ESTJ:"感情を抑え込みすぎると突然爆発し、「誰も自分を認めてくれない」と被害者意識に陥る。",
  ESFP:"ストレスが蓄積すると陰謀論的な思考に走り、「裏で何か企んでいるのでは」と周囲を疑い始める。",
  ESFJ:"限界を超えると突然「もう人に合わせるのはやめた」と反抗的になり、論理で武装して周囲を攻撃する。"
};
/* ═══════════════════════════════════════════════
   ソシオニクス タイプ間関係 (Intertype Relations)
   ═══════════════════════════════════════════════ */
var MBTI_TO_SOC = {
  ENTP:"ILE",ESFJ:"ESE",ENFJ:"EIE",ESTP:"SLE",ESFP:"SEE",ENTJ:"LIE",ESTJ:"LSE",ENFP:"IEE",
  ISFJ:"SEI",INTP:"LII",ISTP:"LSI",INFJ:"IEI",INTJ:"ILI",ISFP:"ESI",ISTJ:"SLI",INFP:"EII"
};
var SOC_FS = {
  ILE:["Ne","Ti","Se","Fi","Si","Fe","Ni","Te"],SEI:["Si","Fe","Ni","Te","Ne","Ti","Se","Fi"],
  ESE:["Fe","Si","Te","Ni","Ti","Ne","Fi","Se"],LII:["Ti","Ne","Fi","Se","Fe","Si","Te","Ni"],
  EIE:["Fe","Ni","Te","Si","Ti","Se","Fi","Ne"],LSI:["Ti","Se","Fi","Ne","Fe","Ni","Te","Si"],
  SLE:["Se","Ti","Ne","Fi","Ni","Fe","Si","Te"],IEI:["Ni","Fe","Si","Te","Se","Ti","Ne","Fi"],
  SEE:["Se","Fi","Ne","Ti","Ni","Te","Si","Fe"],ILI:["Ni","Te","Si","Fe","Se","Fi","Ne","Ti"],
  LIE:["Te","Ni","Fe","Si","Fi","Se","Ti","Ne"],ESI:["Fi","Se","Ti","Ne","Te","Ni","Fe","Si"],
  IEE:["Ne","Fi","Se","Ti","Si","Te","Ni","Fe"],SLI:["Si","Te","Ni","Fe","Ne","Fi","Se","Ti"],
  LSE:["Te","Si","Fe","Ni","Fi","Ne","Ti","Se"],EII:["Fi","Ne","Ti","Se","Te","Si","Fe","Ni"]
};

function getITRelation(m1,m2){
  var p=((m1[0]!==m2[0])?1:0)+""+((m1[1]!==m2[1])?1:0)+""+((m1[2]!==m2[2])?1:0)+""+((m1[3]!==m2[3])?1:0);
  switch(p){
    case"0000":return"同一";case"1110":return"双対";case"1000":return"鏡像";case"0001":return"準同一";
    case"1001":return"消滅";case"0111":return"活性化";case"1111":return"衝突";case"1101":return"準双対";
    case"0010":return"同属";case"0100":return"共鳴";case"0110":return"超自我";case"1011":return"幻影";
    case"0011":case"0101":return _itBen(m1,m2);
    case"1010":case"1100":return _itSup(m1,m2);
    default:return"不明";
  }
}
function _itSup(a,b){var s1=SOC_FS[MBTI_TO_SOC[a]],s2=SOC_FS[MBTI_TO_SOC[b]];if(s1[0]===s2[3])return"監督する";if(s2[0]===s1[3])return"被監督";return"監督する";}
function _itBen(a,b){var s1=SOC_FS[MBTI_TO_SOC[a]],s2=SOC_FS[MBTI_TO_SOC[b]];if(s1[1]===s2[4])return"恩恵を与える";if(s2[1]===s1[4])return"恩恵を受ける";return"恩恵を与える";}

var IT_META = {
  "同一":{en:"Identity",emoji:"🪞",score:3,color:"#6B7280",desc:"同じタイプ同士。深く理解し合えるが新たな刺激に欠ける"},
  "双対":{en:"Duality",emoji:"💎",score:5,color:"#2563EB",desc:"最高の補完関係。互いの弱点を自然にカバーし合う黄金ペア"},
  "活性化":{en:"Activation",emoji:"⚡",score:4,color:"#F59E0B",desc:"一緒にいると刺激的でエネルギーが溢れる活発な関係"},
  "鏡像":{en:"Mirror",emoji:"🔄",score:4,color:"#8B5CF6",desc:"似た思考回路だが視点が逆。深い対話と相互理解が生まれる"},
  "同属":{en:"Kindred",emoji:"🤝",score:3,color:"#10B981",desc:"似た世界観で居心地が良い。ただし成長の刺激は少なめ"},
  "準双対":{en:"Semi-dual",emoji:"💫",score:3,color:"#3B82F6",desc:"双対に近い心地よさがあるが、わずかなすれ違いも"},
  "幻影":{en:"Mirage",emoji:"🌙",score:3,color:"#A78BFA",desc:"心地よいが期待とのギャップが生じやすい幻想的な関係"},
  "共鳴":{en:"Business",emoji:"💼",score:3,color:"#64748B",desc:"ビジネスライクに協力できるが深い絆にはなりにくい"},
  "準同一":{en:"Quasi-id",emoji:"👥",score:2,color:"#9CA3AF",desc:"表面的に似ているが本質的に異なり、すれ違いやすい"},
  "消滅":{en:"Extinguish",emoji:"🌫️",score:2,color:"#94A3B8",desc:"互いの存在感を薄め合い、影響を打ち消し合う"},
  "超自我":{en:"Super-ego",emoji:"⚔️",score:2,color:"#EF4444",desc:"互いの弱点を刺激し合う。尊敬はするが疲れやすい"},
  "衝突":{en:"Conflict",emoji:"💥",score:1,color:"#DC2626",desc:"最も困難な関係。理解し合うこと自体が難しい"},
  "監督する":{en:"Supervisor",emoji:"👆",score:2,color:"#D97706",desc:"相手を導く立場。無意識にプレッシャーを与えがち"},
  "被監督":{en:"Supervisee",emoji:"👇",score:2,color:"#D97706",desc:"導かれる立場。窮屈さやプレッシャーを感じやすい"},
  "恩恵を与える":{en:"Benefactor",emoji:"🎁",score:3,color:"#059669",desc:"自然と相手を助ける。ただし善意が伝わりにくいことも"},
  "恩恵を受ける":{en:"Beneficiary",emoji:"🙏",score:3,color:"#059669",desc:"恩恵を受ける立場。感謝しつつ依存に注意が必要"}
};

/* --- Helper: get keys --- */
function gk(t) {
  if (!t) return {};
  return {grp:GRP[t],eco:t[0]+t[1],rel:t[0]+t[2],role:t[2]+t[3],life:t[0]+t[3],talent:t[1]+t[3]};
}

/* --- Love Compatibility --- */
function calcLove(t1, t2) {
  if (!t1 || !t2) return null;
  var k1=gk(t1),k2=gk(t2),score=38,pros=[],cons=[],tips=[];
  /* Golden pairs — consensus from multiple sources */
  var goldenLove = ["INTJ-ENFP","ENFP-INTJ","INFJ-ENTP","ENTP-INFJ","INTP-ENTJ","ENTJ-INTP","INFP-ENFJ","ENFJ-INFP"];
  if(goldenLove.indexOf(t1+"-"+t2)>=0){score+=25;pros.push("多くの相性研究で「最高の組み合わせ」に挙がるゴールデンペア。深い理解とワクワクする刺激が同時に得られる");}
  /* Socionics-inspired complementary bonus (Japanese web consensus: 双対関係)
     Pattern: E/I, S/N, T/F all different but J/P same = 完全補完ペア */
  var isDualComplement = (t1[0]!==t2[0]) && (t1[1]!==t2[1]) && (t1[2]!==t2[2]) && (t1[3]===t2[3]);
  if(isDualComplement){
    score+=15;
    pros.push("心理機能が完全に補い合う「補完関係」（双対）。互いの弱点を自然にカバーし合い、長く一緒にいるほど居心地の良さが深まるパートナーシップ");
    tips.push("最初は「全く違うタイプ」と感じても、相手の得意なことを素直にリスペクトし任せる信頼関係を築くことで、唯一無二のパートナーになれる。違いを楽しむ好奇心が鍵");
  }
  /* E/I — opposite is often better in love (balance) */
  if(t1[0]===t2[0]){score+=4;pros.push("エネルギーの充電スタイルが一致しており、一緒にいて自然体でいられる安心感がある");}
  else{score+=7;pros.push("E型がI型を外の世界に連れ出し、I型がE型に内省の時間を与える。互いの世界を広げ合える補完関係");
    tips.push("E型は「黙って隣にいる時間」もI型にとっては最高の愛情表現だと理解する。I型は月に数回でも相手の社交イベントに参加する姿勢を見せるだけで関係が劇的に安定する");
  }
  /* S/N — same is MOST important in love (shared worldview) */
  if(t1[1]===t2[1]){score+=10;pros.push("世界の見方が近く、日常会話から深い対話まで自然と噛み合う。恋愛の土台となる「分かり合える感覚」が強い");}
  else{score+=2;
    cons.push("S型が「今日の夕飯どうする？」と具体的な話をしたい時にN型が「将来どこに住みたい？」と飛躍した話を始める——この会話のズレが日常的に蓄積してフラストレーションになりやすい");
    tips.push("S型は時々パートナーの夢や理想の話に付き合い、N型は話を具体的なアクションに落とし込む練習をする。「今日は夢の話タイム / 現実の話タイム」と切り替えるルールを作るのも効果的");
  }
  /* T/F — less impact than expected; FF pairs do well, TF also fine */
  if(t1[2]===t2[2]){score+=6;
    if(t1[2]==="F"){pros.push("感情を共有し合える温かい関係。互いの気持ちに寄り添う力があり、深い絆を築きやすい");}
    else{pros.push("論理的に話し合えるためケンカが建設的。問題が起きても冷静に解決できる安定感がある");}
  }
  else{score+=5;pros.push("T型の冷静さとF型の温かさのバランスで、互いにない視点を補い合える");
    cons.push("T型が問題解決モードで「こうすればいいのに」とアドバイスすると、F型は「気持ちを理解してほしいだけなのに」と傷つく悪循環に陥りやすい");
    tips.push("T型は話を聞く時の最初の5分間は解決策を言わず「それは辛かったね」と共感に徹する訓練を。F型は「今は聞いてほしいだけ／アドバイスが欲しい」を事前に伝える習慣も有効");
  }
  /* J/P — opposite often works well in love (complement) */
  if(t1[3]===t2[3]){score+=3;
    if(t1[3]==="J"){pros.push("計画的で安定した生活リズムを共有でき、将来設計もスムーズに進む");}
    else{pros.push("自由で柔軟な関係性。束縛しない信頼感があり、互いの個性を尊重できる");
      cons.push("二人とも気ままなため、家事や将来の計画が後回しになりがち");
      tips.push("生活の大枠（家事分担・お金の管理）だけはルール化しておくと、自由さを保ちつつ安定も得られる");
    }
  }
  else{score+=8;pros.push("J型が安定した土台を作り、P型が新鮮な刺激をもたらす。退屈しない安定感が手に入る");
    tips.push("J型はP型の「今決めなくてもいい」は怠慢ではなく最適化本能だと理解する。P型はJ型が安心できるよう、大枠の方向性だけでも早めに共有する。家事はJ型リード、余暇はP型に委ねるといったゆるやかな分業がおすすめ");
  }
  if(k1.rel===k2.rel){score+=6;pros.push("人との距離感や愛情の示し方が似ており、無理なく心地よい関係を維持できる");}
  else{score+=2;
    cons.push("対人スタイルが異なるため、「愛している証拠」の見せ方に認識のズレが生まれやすい");
    tips.push("「5つの愛の言語（言葉・行動・贈り物・時間・スキンシップ）」を二人で共有し、互いが最も嬉しい愛情表現を明確にしておくと劇的に改善する");
  }
  if(k1.life===k2.life){score+=4;pros.push("人生の中で大切にするものが共通しており、長期的な関係が安定しやすい");}
  if(k1.grp===k2.grp){score+=4;pros.push("趣味や友人グループの傾向が合い、共通の楽しみを見つけやすい");}
  var diff=0;for(var i=0;i<4;i++){if(t1[i]!==t2[i])diff++;}
  if(diff===4){score-=10;
    cons.push("4つの軸が全て逆の組み合わせ。価値観やコミュニケーションが根本的に異なり、「普通こうするでしょ？」の定義が全く違うため衝突が頻発しやすい");
    tips.push("「理解しよう」という姿勢そのものが最大の愛情表現。定期的に二人の時間を確保し、相手の世界観を聞く「デブリーフィング・デート」を習慣にすると、違いを強みに変えていける");
  }
  score=Math.min(97,Math.max(20,score));
  if(t1===t2){score=72;
    pros=["互いを完全に理解できる鏡のような存在。言葉にしなくても気持ちが通じ合い、価値観の衝突がほぼ起こらない安心感がある"];
    cons=["似すぎてマンネリ化しやすく、関係に新鮮な刺激が不足しがち。互いの弱点も共通しているため、同じ問題に二人ともハマりやすい"];
    tips=["あえて普段やらないジャンルの体験（アウトドア・アート・スポーツ等）を一緒に試す。また、互いの弱点を補うために第三者（友人・メンター）との交流を意識的に増やすと関係がさらに深まる"];
  }
  if(pros.length===0)pros.push("異なる魅力を持つ刺激的なカップル — 互いの世界を広げ合える可能性を秘めている");
  if(cons.length===0)cons.push("価値観の違いを「面白い」と思えるかどうかが関係の長続きの鍵");
  if(tips.length===0)tips.push("互いの「当たり前」が違うことを前提に、好奇心を持って相手の内面を探索し続ける");
  return {score:score,pros:pros,cons:cons,tips:tips};
}

/* --- Work Compatibility --- */
function calcWork(t1, t2) {
  if (!t1 || !t2) return null;
  var k1=gk(t1),k2=gk(t2),score=40,pros=[],cons=[],tips=[];
  /* Work golden pairs — research consensus: complementary professional skills */
  var goldenWork = ["ENTJ-INTP","INTP-ENTJ","INTJ-ENTJ","ENTJ-INTJ","ENTP-INTJ","INTJ-ENTP","ENFJ-INFP","INFP-ENFJ","ESTJ-ISFP","ISFP-ESTJ","ISTJ-ESFP","ESFP-ISTJ"];
  if(goldenWork.indexOf(t1+"-"+t2)>=0){score+=20;pros.push("仕事上の理想的パートナー — 互いのスキルが完璧に噛み合い、1+1が3以上になるゴールデンペア");}
  /* Socionics-inspired complementary bonus for work */
  var isDualComplement = (t1[0]!==t2[0]) && (t1[1]!==t2[1]) && (t1[2]!==t2[2]) && (t1[3]===t2[3]);
  if(isDualComplement){
    score+=10;
    pros.push("心理機能が完全に補完し合い、互いの盲点を自然にカバーできるチーム構成。ビジョンと実行、分析と共感のバランスに優れ、死角のない協力体制を築ける");
    tips.push("役割分担を明確にし、相手の得意領域を信頼して任せ切ることで最大の成果が生まれる。「自分ならこうする」を押し付けず、異なるアプローチを尊重する姿勢が重要");
  }
  /* T/F — MOST critical in work (decision-making alignment) */
  if(t1[2]===t2[2]){
    if(t1[2]==="T"){score+=10;pros.push("論理的な議論でスピーディーに意思決定でき、感情的なバイアスに流されにくい");
      cons.push("二人とも論理重視のため、チームメンバーやクライアントの感情面への配慮が不足しがち");
      tips.push("フィードバック前に「相手はこれを聞いてどう感じるか」を5秒だけ考える習慣を。論理的に正しいことと伝え方が適切であることは別問題");
    }
    else{score+=7;pros.push("チームの雰囲気やメンバーのモチベーション管理を重視した温かいチーム運営ができる");
      cons.push("二人とも感情面を重視するため、厳しい判断（人事・予算削減・方針転換）を先送りにしがち");
      tips.push("データや数字を判断の根拠として明示するルールを設ける。「感情と論理、両方のレンズで見る」チェックリストを重要な意思決定時に参照する習慣を");
    }
  }else{score+=4;pros.push("T型の論理的分析とF型の共感的配慮のバランスで、多角的な意思決定ができる");
    cons.push("T型の率直なフィードバックをF型が「冷たい」と感じたり、F型の配慮をT型が「回りくどい」と感じる場面が起きがち");
    tips.push("T型はフィードバック時に「まず良い点→改善点→応援」のサンドイッチ構造を。F型は「結論を先に、理由を添える」練習を。互いのスタイルの違いをチーム内で公開的に共有すると摩擦が大幅に減る");
  }
  /* J/P — very important for work (project management style) */
  if(t1[3]===t2[3]){
    if(t1[3]==="J"){score+=12;pros.push("計画・進捗管理の価値観が一致し、プロジェクトの納期遵守が盤石。安定した成果を出し続けられる");}
    else{score+=5;pros.push("柔軟な発想で互いのアイデアを膨らませ、イノベーティブなアウトプットが生まれやすい");
      cons.push("二人ともP型のため、締切管理やタスクの収束が甘くなりがち。「誰かがやるだろう」と思っていたら誰もやっていなかった、というリスクが常にある");
      tips.push("プロジェクト開始時に必ず中間マイルストーンを設定し、どちらかが明示的にスケジュール管理役を担う。ツール（Trello等）の導入も効果的");
    }
  }else{score+=7;pros.push("J型の緻密な計画力とP型の柔軟な対応力で、想定内・想定外の両方に強いチーム");
    cons.push("J型が「予定通りに進めたい」場面でP型が方向転換を提案し、互いにフラストレーションが溜まることがある");
    tips.push("J型がマイルストーンの大枠を設定し、各マイルストーン内の進め方はP型に裁量を委ねる二段階方式が最も効果的");
  }
  /* S/N — complement valued in work (vision + execution) */
  var sameGroup = k1.grp === k2.grp;
  if(t1[1]===t2[1]){
    if(t1[1]==="N"){score+=5;pros.push("イノベーティブな企画やコンセプトが次々と生まれるクリエイティブなペア");
      cons.push("アイデアは豊富だが実装フェーズの詰めが甘くなりがち。実現可能性やコストの検証を後回しにするリスク");
      tips.push("アイデア出しと実行計画のフェーズを明確に分ける。実務力のあるS型メンバーを1人加えると完璧な体制に");
    }
    else{score+=6;pros.push("現場の実務力が高く、確実な遂行力でプロジェクトを着実にゴールまで導ける");
      cons.push("「前例通り」に固執しやすく、市場変化への対応や新規事業の立ち上げが苦手になりがち");
      tips.push("月1回は「そもそもこのやり方は最適か？」を問い直すレビューを。N型人材との勉強会で視野を広げるインプットを意識的に");
    }
  }else{score+=9;pros.push("N型がビジョンとコンセプトを描き、S型が着実に実装する——仕事における理想的な分業体制");
    tips.push("N型はアイデアを具体例と共に説明する。S型は「それは現実的に無理」と即否定せず、まず可能性を検討してからフィードバックする。この相互リスペクトが黄金コンビの鍵");
  }
  /* E/I — complement works well in work (role division) */
  if(t1[0]===t2[0]){
    if(t1[0]==="E"){score+=4;pros.push("プレゼン・交渉の場で圧倒的な推進力を発揮する営業力抜群のコンビ");
      cons.push("「話して考える」二人が集まると会議が長くなり結論が出ないまま次の話題に移るリスク");
      tips.push("会議には必ずアジェンダとタイムキーパーを。「発散15分→収束10分」のように構造化する");
    }
    else{score+=4;pros.push("深い分析と集中作業で質の高いアウトプットを安定的に生み出せる");
      cons.push("対外発信やネットワーキングが苦手なため、成果が組織内外に伝わりにくい");
      tips.push("成果の可視化と発信を意識的にタスク化する。可能であればE型メンバーを巻き込んでプレゼンや社内広報を任せる");
    }
  }else{score+=7;pros.push("E型が対外折衝・プレゼンを、I型が深い分析・品質管理を担う自然な役割分担が生まれる");
    tips.push("I型は考えがまとまる前でも途中段階を共有することを意識。E型はI型の集中時間を中断しない配慮を。非同期ツールとリアルタイム会話の使い分けがスムーズ");
  }
  /* Same temperament group bonus (NT-NT, SJ-SJ etc) */
  if(sameGroup){score+=4;pros.push("仕事の優先順位や価値基準が近く、コミュニケーションコストが低い");}
  /* NT+SJ complement bonus (strategy + execution) */
  var grp1 = t1[1]+t1[2], grp2 = t2[1]+t2[2];
  if((grp1==="NT"&&(grp2==="SJ"||grp2==="SF"))||(grp2==="NT"&&(grp1==="SJ"||grp1==="SF"))){
    score+=3;pros.push("戦略思考と実務遂行の理想的な補完関係。ビジョンを確実に形にできる");
  }
  if((grp1==="NF"&&grp2==="ST")||(grp2==="NF"&&grp1==="ST")){
    score+=2;pros.push("理念と実務のバランス。組織の方向性と日々のオペレーションの両方をカバーできる");
  }
  /* Talent compatibility */
  if(k1.talent===k2.talent){score+=1;
    cons.push("同じ才能タイプのため得意領域が被りやすく、成果の差が直接比較されて競争関係に陥るリスク");
    tips.push("担当領域を明確に分けて棲み分けを意識する。完全に異なるプロジェクトにアサインされるのも一案");
  }
  else{score+=4;pros.push("異なる才能タイプでチームの死角を埋め合い、多角的なアプローチが可能に");}
  /* 4 letters all different = worst work match */
  var diff=0;for(var i=0;i<4;i++){if(t1[i]!==t2[i])diff++;}
  if(diff===4){score-=8;
    cons.push("仕事の進め方・意思決定・コミュニケーションの全てが根本的に異なる。意識的な歩み寄りがないと生産性が大きく低下するリスク");
    tips.push("役割を明確に分け、互いの領域に口を出さないルールを設ける。週1回の短い振り返りMTGで認識を合わせ、摩擦の芽を早期に摘むことが重要");
  }
  score=Math.min(97,Math.max(20,score));
  if(t1===t2){score=70;
    pros=["意思疎通がスムーズで信頼関係を築きやすい — 阿吽の呼吸で動ける。説明コストが圧倒的に低い"];
    cons=["視点が偏り盲点が生まれやすく、同じミスを二人とも見落とす危険性がある"];
    tips=["異なるタイプの第三者をチームに加えることで突破口が開ける。定期的に外部レビューを取り入れ盲点をチェックする仕組みを作る"];
  }
  if(pros.length===0)pros.push("異なるスキルセットで幅広い課題に対応でき、互いの弱みをカバーし合える");
  if(cons.length===0)cons.push("仕事の進め方にギャップがあるため、プロジェクト初期段階での擦り合わせが特に重要");
  if(tips.length===0)tips.push("互いの強みリストを共有し得意分野で分業する。週次15分チェックインMTGで進捗と課題を共有する習慣をつけると生産性が劇的に向上");
  return {score:score,pros:pros,cons:cons,tips:tips};
}

/* --- Team Analysis --- */
function analyzeTeam(members) {
  var traits={E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0};
  members.forEach(function(m){m.split("").forEach(function(c){if(traits[c]!==undefined)traits[c]++;});});
  var total=members.length||1;var gaps=[];
  function _addGap(trait,issue,fix,action,suggest){
    var pct=Math.round(traits[trait]/total*100);
    if(pct<25)gaps.push({issue:issue,fix:fix,action:action,suggest:suggest,pct:pct,count:traits[trait],trait:trait});
  }
  _addGap("E","外向型(E)不足",
    "対外コミュニケーション力と推進力が不足しています。プレゼンテーション、営業交渉、社内外へのアピールが弱くなり、チームの成果が正当に評価されにくいリスクがあります。",
    "チーム外への成果発信を意識的にタスク化する。月次レポートの共有、社内LTへの登壇、クライアント向けデモの担当者を明示的にアサインしましょう。",
    ["ESTP","ENFP","ENTJ"]);
  _addGap("I","内向型(I)不足",
    "深い分析や内省の担い手が少なく、拙速な判断に陥るリスクがあります。議論が活発で盛り上がるものの、「本当にこれで正しいのか」を立ち止まって検証する機能が弱い状態です。",
    "重要な意思決定の前に「沈黙の10分間」を設け、各自が紙に意見を書き出すサイレントブレストを導入する。非同期のドキュメントレビューも有効です。",
    ["INTJ","INTP","ISFJ"]);
  _addGap("S","感覚型(S)不足",
    "実装のディテールや品質管理が甘くなる傾向があります。大きなビジョンは描けるのに実行段階でミスが頻発したり、現実のリソース制約を見落としたりするリスクがあります。",
    "プロジェクトの各マイルストーンに品質チェックリストを設ける。要件定義は抽象的な理想だけでなく「具体的に何をいつまでに」の形式に落とし込む習慣を徹底しましょう。",
    ["ISTJ","ESTJ","ISTP"]);
  _addGap("N","直感型(N)不足",
    "新しいアイデアや中長期ビジョンが出にくく、現状維持に陥りやすい状態です。目の前のタスクは確実にこなせるが、市場の変化や技術トレンドへの対応が遅れ、気づいた時には競合に先を越されるリスクがあります。",
    "月1回の「未来ブレスト会議」を設定し、3年後の理想の状態を議論する場を作る。他部署の企画職や外部アドバイザーとの交流機会を積極的に作りましょう。",
    ["ENTP","INFJ","ENFP"]);
  _addGap("T","思考型(T)不足",
    "論理的な意思決定基盤が弱く、「雰囲気」や「みんなの気持ち」で重要な判断が左右されがちです。データに基づく客観的な評価が不足し、非効率な施策が続いてしまうリスクがあります。",
    "KPIとデータダッシュボードを整備し、「数字で語る」文化を意識的に醸成する。意思決定時には必ず「賛成/反対の論理的根拠」を明文化するルールを導入しましょう。",
    ["INTJ","ENTP","ISTP"]);
  _addGap("F","感情型(F)不足",
    "メンバーの感情面のケアが不足し、心理的安全性が損なわれやすい状態です。成果を出していても「このチームにいて楽しいか」が置き去りにされ、モチベーション低下や離職に繋がるリスクがあります。",
    "1on1ミーティングを定期化し、業務だけでなく「最近どう？」という雑談の時間を意識的に確保する。フィードバック時は必ず良い点から伝えるサンドイッチ方式を導入しましょう。",
    ["ESFJ","ENFJ","ISFP"]);
  _addGap("J","判断型(J)不足",
    "計画と締切管理の甘さがプロジェクト進行の最大のボトルネックになっています。アイデアは出るがまとまらない、タスクが増えるが完了しない、優先順位が曖昧なままズルズル進む——という状態に陥りやすいです。",
    "プロジェクト管理ツール（Trello/Asana等）を必ず導入し、タスクの担当者・期限・ステータスを可視化する。週次の進捗レビューを欠かさず実施し、優先順位の再整理を習慣化しましょう。",
    ["ESTJ","ISTJ","ENTJ"]);
  _addGap("P","知覚型(P)不足",
    "変化への適応力が低く、想定外の事態に柔軟に対応できない状態です。計画通りに進めることには長けていますが、前提条件が変わった時に方針転換が遅れ、機会損失に繋がるリスクがあります。",
    "計画にあえて「バッファ枠」を設け、想定外に対応できる余白を確保する。四半期ごとに「このまま進めて本当にいいのか」を検証するリトロスペクティブを実施しましょう。",
    ["ENFP","ESTP","INTP"]);

  /* === Strengths analysis === */
  var strengths = [];
  var STRENGTH_DATA = {
    E:{icon:"📢",title:"発信力・推進力が高い",desc:"対外コミュニケーションが得意なメンバーが多く、チームの成果を社内外にアピールする力があります。会議やプレゼンの場で積極的に発言し、物事を前に進める推進力に優れています。",tip:"この強みを活かすために、メンバーに社外発表やクライアント対応の機会を積極的に任せましょう。"},
    I:{icon:"🔍",title:"深い分析力・集中力がある",desc:"じっくり考えて本質を見抜くメンバーが多く、拙速な判断を防ぐ「ブレーキ役」として機能します。一人で集中して高品質なアウトプットを出す力に長けています。",tip:"深い分析が必要なリサーチや品質レビューをこのチームに任せると、精度の高い成果が期待できます。"},
    S:{icon:"📋",title:"実行力・品質管理に強い",desc:"具体的な事実やデータに基づいて判断するメンバーが多く、計画を確実に実行に移す力があります。細部への注意力が高く、ミスの少ない堅実な仕事ができます。",tip:"品質チェック、マニュアル作成、運用設計など、ディテールが重要なタスクで真価を発揮します。"},
    N:{icon:"💡",title:"発想力・ビジョン構築に強い",desc:"未来の可能性や新しいアイデアを生み出すメンバーが多く、イノベーションの原動力となります。既存の枠にとらわれない発想で、チームに新しい方向性を示せます。",tip:"ブレインストーミング、新規事業企画、中長期戦略の策定で特に力を発揮します。"},
    T:{icon:"🧠",title:"論理的思考・問題解決に強い",desc:"データと論理に基づいて冷静に判断できるメンバーが多く、感情に流されない意思決定ができます。複雑な問題を構造的に分解し、効率的な解決策を導き出す力があります。",tip:"KPI設計、業務プロセス改善、技術的な課題解決にこのチームの強みが光ります。"},
    F:{icon:"💕",title:"共感力・チームワークに強い",desc:"メンバーの気持ちに寄り添い、心理的安全性の高い環境を作る力があります。対人関係の調整やモチベーション管理に長けており、チームの一体感を生み出します。",tip:"顧客対応、社内調整、メンバー育成など、人の気持ちが重要な場面で真価を発揮します。"},
    J:{icon:"📐",title:"計画力・実行管理に強い",desc:"目標から逆算して計画を立て、期限を守って着実に遂行するメンバーが多く、プロジェクトの安定運用に貢献します。優先順位の整理と進捗管理が得意です。",tip:"プロジェクト管理、スケジュール策定、品質保証プロセスの構築で力を発揮します。"},
    P:{icon:"🌊",title:"柔軟性・適応力に強い",desc:"変化を恐れず、状況に応じて臨機応変に対応できるメンバーが多く、予想外の事態にも動じません。新しい情報を素早く取り入れて方針を修正する力があります。",tip:"アジャイル開発、トラブル対応、新規市場の探索など、変化の激しい環境で強みが際立ちます。"}
  };
  var COMBO_STRENGTHS = {
    EF:{icon:"☀️",title:"場を明るくするムードメーカー力",desc:"人を巻き込む力と共感力を兼ね備え、チーム全体の士気を高められます。メンバー同士の関係構築や、チームの一体感醸成において無類の強さを発揮します。"},
    ET:{icon:"🚀",title:"突破力のあるリーダーシップ",desc:"論理的な判断力と積極的な発信力を兼ね備え、困難な局面でもチームを力強く牽引できます。意思決定が速く、決めたことを実行に移すスピードが抜群です。"},
    IF:{icon:"🌿",title:"繊細な感受性と深い共感力",desc:"メンバーの小さな変化にも気づき、きめ細かいサポートができます。一人ひとりに丁寧に向き合う姿勢が、チームの心理的安全性を高めています。"},
    IT:{icon:"🔬",title:"深い分析力と戦略的思考",desc:"静かに物事の本質を見抜き、緻密な分析と戦略立案ができます。データドリブンな意思決定と、長期的な視野に基づく計画策定が得意です。"},
    NF:{icon:"🌈",title:"ビジョンと共感で人を動かす力",desc:"理想を掲げて人の心に火をつける力と、メンバーの成長を支える共感力を併せ持ちます。チームの「なぜやるのか」を言語化し、意味のある方向へ導けます。"},
    NT:{icon:"⚡",title:"知的パワーでイノベーションを起こす力",desc:"高い知的好奇心と論理的思考力で、複雑な課題に対して革新的な解決策を生み出せます。戦略立案から技術革新まで、知の力で組織を前進させます。"},
    SF:{icon:"🏠",title:"安心感のある実務力",desc:"現実的な判断力と人への気配りを兼ね備え、堅実かつ温かいチーム運営ができます。ルーティンワークの正確さと、メンバーへの細やかなサポートが強みです。"},
    ST:{icon:"💼",title:"数字と成果で語るプロ意識",desc:"データに基づく判断力と確実な実行力で、高品質な成果を安定的に出し続けられます。業務改善や品質管理のプロフェッショナル集団です。"},
    SJ:{icon:"🏗️",title:"盤石な基盤を作る組織力",desc:"ルールと計画を重視し、ブレない運用体制を構築できます。マニュアル化、品質チェック、進捗管理など、組織の土台を支える力が圧倒的です。"},
    NP:{icon:"🎨",title:"自由な発想と探求心",desc:"好奇心と柔軟性を兼ね備え、既存の枠にとらわれない斬新なアイデアを次々に生み出せます。変化を楽しみ、未知の領域に果敢に踏み込む冒険心があります。"},
    NJ:{icon:"🎯",title:"ビジョンを計画に落とし込む力",desc:"理想を描くだけでなく、それを具体的なロードマップに変換して実行まで持っていける稀有な力を持っています。"},
    SP:{icon:"⚡",title:"現場対応力と瞬発力",desc:"目の前の状況に即座に反応し、最適な行動を取れる瞬発力があります。トラブル発生時の対応スピードと柔軟性は他の追随を許しません。"}
  };
  /* Single-axis strengths (>=50%) */
  var _rawStr = [];
  "EISNTFJP".split("").forEach(function(k) {
    var pct = Math.round(traits[k]/total*100);
    if(pct >= 50 && STRENGTH_DATA[k]) {
      _rawStr.push({s:Object.assign({},STRENGTH_DATA[k],{pct:pct}),score:traits[k]/total});
    }
  });
  /* Combo strengths (both axes >=40%) */
  Object.keys(COMBO_STRENGTHS).forEach(function(combo) {
    var a = combo[0], b = combo[1];
    var pa = Math.round(traits[a]/total*100), pb = Math.round(traits[b]/total*100);
    if(pa >= 40 && pb >= 40) {
      _rawStr.push({s:Object.assign({},COMBO_STRENGTHS[combo],{pct:Math.round((pa+pb)/2)}),score:(traits[a]+traits[b])/(total*2)});
    }
  });
  /* Sort by dominance and cap at 4 */
  _rawStr.sort(function(a,b){return b.score-a.score;});
  strengths = _rawStr.slice(0,4).map(function(r){return r.s;});

  /* === Weaknesses (traits <35%, with severity) === */
  var weaknesses = [];
  var WEAKNESS_DATA = {
    E:{icon:"🔇",title:"対外発信が控えめ",desc:"チームの成果を外にアピールする機会を逃しがち。会議でも受け身になりやすい傾向があります。"},
    I:{icon:"💨",title:"立ち止まって考える力が弱い",desc:"行動は速いが、深い検討が不足しがち。「本当にこれでいいのか」の検証が甘くなる傾向があります。"},
    S:{icon:"🌫️",title:"実行のディテールが甘い",desc:"大きな絵は描けるが、具体的な手順や品質管理が後回しになりがち。ミスの温床になりやすいです。"},
    N:{icon:"🧱",title:"新しいアイデアが出にくい",desc:"現状維持に陥りやすく、変化や技術トレンドへの対応が遅れるリスクがあります。"},
    T:{icon:"🫧",title:"論理的な判断基盤が弱い",desc:"雰囲気や感情で重要な判断が左右されがち。データに基づく客観的な評価が不足する傾向です。"},
    F:{icon:"🧊",title:"メンバーの感情ケアが不足",desc:"成果重視で「このチームにいて楽しいか」が置き去りに。モチベーション低下や離職リスクがあります。"},
    J:{icon:"🌀",title:"計画と締切管理が甘い",desc:"アイデアは出るがまとまらない、タスクが完了しない、優先順位が曖昧になりやすいです。"},
    P:{icon:"🔒",title:"変化への適応が苦手",desc:"計画通りには強いが、前提が変わった時の方針転換が遅れがち。柔軟性に欠ける面があります。"}
  };
  "EISNTFJP".split("").forEach(function(k) {
    var pct = Math.round(traits[k]/total*100);
    if(pct < 35 && WEAKNESS_DATA[k]) {
      var severity = pct === 0 ? "致命的" : pct <= 15 ? "深刻" : "やや不足";
      var sevColor = pct === 0 ? "#ef4444" : pct <= 15 ? "#f97316" : "#eab308";
      weaknesses.push(Object.assign({},WEAKNESS_DATA[k],{pct:pct,severity:severity,sevColor:sevColor,trait:k,count:traits[k]}));
    }
  });
  /* Team character summary */
  var dominant = [];
  [["E","I"],["S","N"],["T","F"],["J","P"]].forEach(function(pair){
    dominant.push(traits[pair[0]] >= traits[pair[1]] ? pair[0] : pair[1]);
  });
  var teamChar = dominant.join("");

  /* Team archetype - descriptive name instead of MBTI */
  var TEAM_ARCHETYPE = {
    ENTJ:{name:"突破型リーダーチーム",icon:"🚀",desc:"目標に向かって全力で突き進む推進力が最大の武器"},
    ENFJ:{name:"チームビルダー型",icon:"🤝",desc:"人の力を引き出し、一体感で成果を出すチーム"},
    ENTP:{name:"イノベーター型",icon:"💡",desc:"常識を壊して新しい価値を生み出す発想力が武器"},
    ENFP:{name:"ムーブメント型",icon:"🎪",desc:"情熱と巻き込み力で周囲にポジティブな変化を起こす"},
    ESTJ:{name:"鉄壁マネジメント型",icon:"🏗️",desc:"計画・実行・管理の三拍子が揃った盤石の運営力"},
    ESFJ:{name:"あったかサポート型",icon:"☀️",desc:"気配りと協調性でチーム全体を温かく包むチーム"},
    ESTP:{name:"現場突撃型",icon:"⚡",desc:"スピードと行動力で困難を突破する実行チーム"},
    ESFP:{name:"お祭りエンタメ型",icon:"🎉",desc:"楽しさとエネルギーでチームの士気を爆上げする"},
    INTJ:{name:"戦略参謀型",icon:"🎯",desc:"冷静な分析と長期視点で最適解を導き出すチーム"},
    INFJ:{name:"静かなる革命家型",icon:"🌿",desc:"深い洞察と理想で組織を内側から変えていく"},
    INTP:{name:"知的探究型",icon:"🔬",desc:"「なぜ？」を追求し、本質を解明する知の集団"},
    INFP:{name:"理想追求型",icon:"🌈",desc:"ブレない価値観と繊細さで独自の世界を作り上げる"},
    ISTJ:{name:"堅実キッチリ型",icon:"📐",desc:"ルールと責任感で確実に成果を積み上げる信頼のチーム"},
    ISFJ:{name:"縁の下の力持ち型",icon:"🧸",desc:"献身的なサポートと気配りでチームの土台を支える"},
    ISTP:{name:"職人クール型",icon:"🔧",desc:"無駄なく的確に問題を解決するプロフェッショナル集団"},
    ISFP:{name:"感性クリエイティブ型",icon:"🎨",desc:"独自のセンスと穏やかさで心地よい環境を作る"}
  };
  var archetype = TEAM_ARCHETYPE[teamChar] || {name:"バランス型チーム",icon:"⚖️",desc:"多様な強みを持つバランスの取れたチーム"};

  return {traits:traits,gaps:gaps,strengths:strengths,weaknesses:weaknesses,teamChar:teamChar,archetype:archetype,total:total};
}

/* ═══════════════════════════════════════════════
   AVATAR COMPONENT
   ═══════════════════════════════════════════════ */
function CssAvatar({type,size}) {
  var z = size || 60;
  var d = AVD[type];
  if (!d) return null;
  var gc = GC[GRP[type]];
  var isE = type[0]==="E";
  var isF = type[2]==="F";
  var h = Math.round(z*0.44);
  var e = Math.max(2,Math.round(z*0.04));
  var b = Math.round(z*0.26);
  return (
    <div style={{width:z,height:z,borderRadius:"50%",background:d.bg,position:"relative",overflow:"hidden",flexShrink:0,display:"inline-block"}}>
      <div style={{position:"absolute",bottom:0,left:"50%",transform:"translateX(-50%)",width:h*1.6,height:Math.round(z*0.35),borderRadius:"50% 50% 0 0",background:gc,opacity:0.8}} />
      <div style={{position:"absolute",top:Math.round(z*0.12),left:"50%",transform:"translateX(-50%)",width:h,height:h,borderRadius:"50%",background:d.skin}} />
      <div style={{position:"absolute",top:Math.round(z*0.06),left:"50%",transform:"translateX(-50%)",width:Math.round(h*(isE?1.05:1.1)),height:Math.round(h*(isE?0.55:0.65)),borderRadius:isE?"50% 50% 40% 40%":"45% 45% 30% 30%",background:d.hair}} />
      <div style={{position:"absolute",top:Math.round(z*0.34),left:"50%",transform:"translateX(-50%)",display:"flex",gap:Math.max(3,Math.round(z*0.12))}}>
        <div style={{width:e,height:e,borderRadius:"50%",background:"#1e293b"}} />
        <div style={{width:e,height:e,borderRadius:"50%",background:"#1e293b"}} />
      </div>
      {isF ? (
        <div style={{position:"absolute",top:Math.round(z*0.46),left:"50%",transform:"translateX(-50%)",width:Math.max(6,Math.round(z*0.14)),height:Math.max(3,Math.round(z*0.04)),borderRadius:"0 0 50% 50%",borderBottom:"1.5px solid #94a3b8"}} />
      ) : (
        <div style={{position:"absolute",top:Math.round(z*0.46),left:"50%",transform:"translateX(-50%)",width:Math.max(6,Math.round(z*0.14)),height:0,borderBottom:"1.5px solid #94a3b8"}} />
      )}
      <div style={{position:"absolute",top:Math.round(z*0.02),right:Math.round(z*0.02),width:b,height:b,borderRadius:"50%",background:d.bg,border:"1.5px solid "+gc,display:"flex",alignItems:"center",justifyContent:"center",fontSize:Math.max(8,Math.round(z*0.16)),lineHeight:1,color:gc}}>
        {d.item}
      </div>
    </div>
  );
}

function Avatar({type,size}) {
  if (!type) return null;
  var z = size || 60;
  var st = useState(0);
  var status = st[0], setStatus = st[1];
  var url = AV_URL[type];
  useEffect(function(){ setStatus(0); }, [type]);
  if (!url || status === 2) return <CssAvatar type={type} size={z} />;
  return (
    <div style={{width:z,height:z,flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",position:"relative"}}>
      {status === 0 ? <div style={{position:"absolute",inset:0}}><CssAvatar type={type} size={z} /></div> : null}
      <img
        src={url} alt={type} width={z} height={z}
        style={{display:status===1?"block":"none",borderRadius:"50%",objectFit:"cover"}}
        onLoad={function(){ setStatus(1); }}
        onError={function(){ setStatus(2); }}
      />
    </div>
  );
}
/* ═══════════════════════════════════════════════
   DESIGN SYSTEM — Editorial Luxury
   ═══════════════════════════════════════════════ */
var S = {
  bg:"#0a0a0f", bg2:"#12121a", bg3:"#1a1a28",
  card:"rgba(255,255,255,0.03)", cardHover:"rgba(255,255,255,0.06)",
  glass:"rgba(255,255,255,0.04)", border:"rgba(255,255,255,0.06)",
  tx:"#e8e4f0", dm:"#8b8698", accent:"#9b6dff",
  gradient:"linear-gradient(135deg,#9b6dff 0%,#e46dff 50%,#6db8ff 100%)"
};

/* --- Glassmorphism Card --- */
function Card({title,icon,color,children,delay,large}) {
  var c = color || S.accent;
  return (
    <div style={{
      background:S.card, backdropFilter:"blur(20px)",
      borderRadius:large?20:16, border:"1px solid "+S.border,
      padding:large?"28px 24px":"20px 18px", marginBottom:large?20:14,
      animation:"fadeUp 0.5s ease both", animationDelay:(delay||0)*0.08+"s",
      position:"relative", overflow:"hidden"
    }}>
      <div style={{position:"absolute",top:0,left:0,right:0,height:2,background:"linear-gradient(90deg,transparent,"+c+",transparent)",opacity:0.5}} />
      {title ? (
        <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:large?16:12}}>
          {icon ? <span style={{fontSize:large?22:18,filter:"saturate(1.2)"}}>{icon}</span> : null}
          <h3 style={{margin:0,fontFamily:F.b,fontWeight:700,fontSize:large?16:13,color:S.tx,letterSpacing:"0.02em"}}>{title}</h3>
        </div>
      ) : null}
      {children}
    </div>
  );
}

/* --- Pill Badge --- */
function Pill({text,color,glow}) {
  var c = color || S.accent;
  return (
    <span style={{
      display:"inline-block",padding:"4px 12px",borderRadius:20,fontSize:10,fontWeight:600,
      fontFamily:F.b,letterSpacing:"0.04em",
      background:glow ? "linear-gradient(135deg,"+c+"22,"+c+"11)" : c+"15",
      color:c, border:"1px solid "+c+"30",
      boxShadow:glow ? "0 0 12px "+c+"20" : "none"
    }}>{text}</span>
  );
}

/* --- Score Ring --- */
function ScoreRing({score,size,color,label}) {
  var sz = size || 100, r = sz*0.38, circ = 2*Math.PI*r;
  var c = color || (score>=75?"#33b98a":score>=55?"#e4ae3a":score>=40?"#f97316":"#ef4444");
  return (
    <div style={{textAlign:"center"}}>
      <svg width={sz} height={sz} style={{filter:"drop-shadow(0 0 12px "+c+"40)"}}>
        <circle cx={sz/2} cy={sz/2} r={r} fill="none" stroke={c+"15"} strokeWidth={sz*0.06} />
        <circle cx={sz/2} cy={sz/2} r={r} fill="none" stroke={c} strokeWidth={sz*0.06}
          strokeDasharray={circ} strokeDashoffset={circ*(1-score/100)}
          strokeLinecap="round" transform={"rotate(-90 "+sz/2+" "+sz/2+")"}
          style={{transition:"stroke-dashoffset 1s ease"}} />
        <text x={sz/2} y={sz/2-4} textAnchor="middle" dominantBaseline="middle"
          style={{fontFamily:F.h,fontWeight:800,fontSize:sz*0.28,fill:c}}>{score}</text>
        <text x={sz/2} y={sz/2+sz*0.15} textAnchor="middle"
          style={{fontFamily:F.b,fontWeight:400,fontSize:sz*0.1,fill:S.dm}}>/ 100</text>
      </svg>
      {label ? <p style={{margin:"6px 0 0",fontFamily:F.b,fontSize:10,color:S.dm}}>{label}</p> : null}
    </div>
  );
}

/* --- Bar Chart --- */
function BarChart({items}) {
  return (
    <div style={{display:"flex",flexDirection:"column",gap:8}}>
      {items.map(function(it,i) {
        return (
          <div key={i} style={{animation:"fadeUp 0.4s ease both",animationDelay:i*0.05+"s"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
              <span style={{fontFamily:F.b,fontSize:10,color:S.tx,fontWeight:500}}>{it.label}</span>
              <span style={{fontFamily:F.h,fontSize:10,color:it.color||S.accent,fontWeight:700}}>{it.value}%</span>
            </div>
            <div style={{height:6,borderRadius:3,background:S.glass,overflow:"hidden"}}>
              <div style={{
                height:"100%",borderRadius:3,width:it.value+"%",
                background:"linear-gradient(90deg,"+( it.color||S.accent)+"cc,"+(it.color||S.accent)+")",
                transition:"width 0.8s ease",boxShadow:"0 0 8px "+(it.color||S.accent)+"40"
              }} />
            </div>
          </div>
        );
      })}
    </div>
  );
}

/* --- Trait Dimension Bar --- */
function DimBar({left,right,value,leftColor,rightColor}) {
  var isLeft = value < 50;
  return (
    <div style={{marginBottom:10}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
        <span style={{fontFamily:F.b,fontSize:10,color:isLeft?leftColor:S.dm,fontWeight:isLeft?700:400}}>{left}</span>
        <span style={{fontFamily:F.b,fontSize:10,color:!isLeft?rightColor:S.dm,fontWeight:!isLeft?700:400}}>{right}</span>
      </div>
      <div style={{height:8,borderRadius:4,background:"rgba(255,255,255,0.06)",position:"relative",overflow:"hidden"}}>
        <div style={{position:"absolute",left:0,top:0,bottom:0,width:value+"%",borderRadius:4,
          background:"linear-gradient(90deg,"+leftColor+","+rightColor+")",
          transition:"width 0.6s ease"}} />
        <div style={{position:"absolute",left:"calc("+value+"% - 2px)",top:-1,width:5,height:10,borderRadius:3,background:"#fff",boxShadow:"0 0 6px rgba(255,255,255,0.5)"}} />
      </div>
    </div>
  );
}

/* --- Section Divider --- */
function Divider({text}) {
  return (
    <div style={{display:"flex",alignItems:"center",gap:12,margin:"20px 0 14px"}}>
      <div style={{flex:1,height:1,background:S.border}} />
      {text ? <span style={{fontFamily:F.b,fontSize:9,color:S.dm,letterSpacing:"0.15em",textTransform:"uppercase",flexShrink:0}}>{text}</span> : null}
      <div style={{flex:1,height:1,background:S.border}} />
    </div>
  );
}

/* --- Quote Block --- */
function Quote({text}) {
  return (
    <div style={{borderLeft:"3px solid "+S.accent,paddingLeft:14,margin:"12px 0",position:"relative"}}>
      <span style={{position:"absolute",top:-8,left:-2,fontSize:28,color:S.accent+"40",fontFamily:"Georgia",lineHeight:1}}>"</span>
      <p style={{fontFamily:F.b,fontSize:11,color:S.dm,lineHeight:1.8,margin:0,fontStyle:"italic"}}>{text}</p>
    </div>
  );
}

/* --- Info Grid --- */
function InfoGrid({items,columns}) {
  return (
    <div style={{display:"grid",gridTemplateColumns:"repeat("+(columns||2)+",1fr)",gap:8}}>
      {items.map(function(it,i) {
        return (
          <div key={i} style={{
            padding:"12px 10px",borderRadius:12,
            background:"linear-gradient(135deg,"+(it.color||S.accent)+"08,"+(it.color||S.accent)+"04)",
            border:"1px solid "+(it.color||S.accent)+"15",
            animation:"fadeUp 0.4s ease both",animationDelay:i*0.06+"s"
          }}>
            {it.icon ? <span style={{fontSize:14,display:"block",marginBottom:4}}>{it.icon}</span> : null}
            <p style={{fontFamily:F.b,fontSize:9,color:it.color||S.accent,fontWeight:700,margin:"0 0 3px",letterSpacing:"0.03em"}}>{it.label}</p>
            <p style={{fontFamily:F.b,fontSize:10,color:S.tx,margin:0,lineHeight:1.6}}>{it.value}</p>
          </div>
        );
      })}
    </div>
  );
}

/* --- Compat Result --- */
function CompatResult({data,t1,t2,mode}) {
  if (!data) return null;
  var isLove = mode === "love";
  var itRel = getITRelation(t1, t2);
  var itMeta = IT_META[itRel];
  return (
    <div style={{animation:"fadeUp 0.5s ease both"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:16,margin:"16px 0"}}>
        <Avatar type={t1} size={64} />
        <div style={{display:"flex",flexDirection:"column",alignItems:"center"}}>
          <span style={{fontSize:24}}>{isLove ? "💕" : "🤝"}</span>
          <span style={{fontFamily:F.h,fontSize:10,color:S.dm,marginTop:2}}>{isLove?"Love":"Work"}</span>
        </div>
        <Avatar type={t2} size={64} />
      </div>
      {/* Socionics Relation Badge */}
      <div style={{display:"flex",justifyContent:"center",marginBottom:12}}>
        <div style={{
          display:"inline-flex",alignItems:"center",gap:8,padding:"8px 16px",borderRadius:20,
          background:itMeta.color+"12",border:"1px solid "+itMeta.color+"30",
          boxShadow:"0 0 16px "+itMeta.color+"15"
        }}>
          <span style={{fontSize:18}}>{itMeta.emoji}</span>
          <div>
            <p style={{fontFamily:F.b,fontSize:11,color:itMeta.color,fontWeight:700,margin:0}}>{itRel}<span style={{fontFamily:F.h,fontSize:9,color:itMeta.color+"aa",fontWeight:500,marginLeft:6}}>{itMeta.en}</span></p>
            <p style={{fontFamily:F.b,fontSize:9,color:S.dm,margin:0}}>{"★".repeat(itMeta.score)+"☆".repeat(5-itMeta.score)} タイプ間関係</p>
          </div>
        </div>
      </div>
      <div style={{display:"flex",justifyContent:"center",marginBottom:16}}>
        <ScoreRing score={data.score} size={110} label={isLove?"恋愛相性スコア":"仕事相性スコア"} />
      </div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>
        <div style={{padding:12,borderRadius:12,background:"rgba(51,185,138,0.05)",border:"1px solid rgba(51,185,138,0.12)"}}>
          <p style={{fontFamily:F.b,fontSize:10,color:"#33b98a",fontWeight:800,margin:"0 0 8px",letterSpacing:"0.05em"}}>✦ 強み</p>
          {data.pros.map(function(p,i){return <p key={i} style={{fontFamily:F.b,color:"#a7f3d0",fontSize:10,margin:"0 0 6px",lineHeight:1.7}}>{p}</p>;})}
        </div>
        <div style={{padding:12,borderRadius:12,background:"rgba(249,115,22,0.05)",border:"1px solid rgba(249,115,22,0.12)"}}>
          <p style={{fontFamily:F.b,fontSize:10,color:"#fb923c",fontWeight:800,margin:"0 0 8px",letterSpacing:"0.05em"}}>⚡ 注意点</p>
          {data.cons.map(function(c,i){return <p key={i} style={{fontFamily:F.b,color:"#fed7aa",fontSize:10,margin:"0 0 6px",lineHeight:1.7}}>{c}</p>;})}
        </div>
        <div style={{padding:12,borderRadius:12,background:"rgba(155,109,255,0.05)",border:"1px solid rgba(155,109,255,0.12)"}}>
          <p style={{fontFamily:F.b,fontSize:10,color:"#9b6dff",fontWeight:800,margin:"0 0 8px",letterSpacing:"0.05em"}}>💡 Tips</p>
          {data.tips.map(function(t,i){return <p key={i} style={{fontFamily:F.b,color:"#c4b5fd",fontSize:10,margin:"0 0 6px",lineHeight:1.7}}>{t}</p>;})}
        </div>
      </div>
    </div>
  );
}
/* ═══════════════════════════════════════════════
   TYPE GRID
   ═══════════════════════════════════════════════ */
var GRPS = [{types:["INTJ","INTP","ENTJ","ENTP"],name:"分析家",color:"#9b6dff"},{types:["INFJ","INFP","ENFJ","ENFP"],name:"外交官",color:"#33b98a"},{types:["ISTJ","ISFJ","ESTJ","ESFJ"],name:"番人",color:"#4298b4"},{types:["ISTP","ISFP","ESTP","ESFP"],name:"探検家",color:"#e4ae3a"}];

function TypeGrid({value,onChange,label,compact}) {
  return (
    <div>
      {label ? <p style={{fontFamily:F.b,fontSize:11,color:S.dm,margin:"0 0 10px",fontWeight:500}}>{label}</p> : null}
      <div style={{display:"flex",flexDirection:"column",gap:compact?6:10}}>
        {GRPS.map(function(g) {
          return (
            <div key={g.name}>
              <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:compact?3:5}}>
                <div style={{width:8,height:8,borderRadius:2,background:g.color}} />
                <span style={{fontFamily:F.b,fontSize:9,color:g.color,fontWeight:700,letterSpacing:"0.08em"}}>{g.name}</span>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:compact?4:6}}>
                {g.types.map(function(t) {
                  var sel = value === t;
                  return (
                    <button key={t} onClick={function(){onChange(sel?"":t);}}
                      style={{
                        all:"unset",cursor:"pointer",textAlign:"center",
                        padding:compact?"6px 2px":"10px 4px",borderRadius:compact?8:12,
                        background:sel?"linear-gradient(135deg,"+g.color+"30,"+g.color+"15)":S.glass,
                        border:sel?"1.5px solid "+g.color+"80":"1px solid "+S.border,
                        transition:"all 0.25s ease",
                        boxShadow:sel?"0 0 20px "+g.color+"25":"none",
                        transform:sel?"scale(1.02)":"scale(1)"
                      }}>
                      <div style={{display:"flex",justifyContent:"center",marginBottom:compact?2:4}}>
                        <Avatar type={t} size={compact?28:36} />
                      </div>
                      <p style={{fontFamily:F.h,fontSize:compact?9:11,fontWeight:sel?800:600,color:sel?g.color:S.dm,margin:0,letterSpacing:"0.05em"}}>{t}</p>
                      {compact ? null : <p style={{fontFamily:F.b,fontSize:8,color:sel?g.color+"cc":S.dm+"88",margin:"2px 0 0"}}>{NICK[t]}</p>}
                    </button>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ═══════════════════════════════════════════════
   TAB: ANALYSIS (分析)
   ═══════════════════════════════════════════════ */
function AnalysisTab({type}) {
  if (!type) return <EmptyState text="タイプを選択してください" />;
  var k = gk(type), gc = GC[GRP[type]];
  var relData = REL[k.rel], ecoData = ECO[k.eco], srData = SR[k.role], lsData = LS[k.life], talData = TAL[k.talent], geData = GE[k.eco[1]+k.role[0]];
  var dims = [
    {l:"外向 E",r:"内向 I",v:type[0]==="E"?30:70,lc:"#f97316",rc:"#818cf8"},
    {l:"感覚 S",r:"直感 N",v:type[1]==="S"?30:70,lc:"#14b8a6",rc:"#a855f7"},
    {l:"思考 T",r:"感情 F",v:type[2]==="T"?30:70,lc:"#3b82f6",rc:"#ec4899"},
    {l:"判断 J",r:"知覚 P",v:type[3]==="J"?30:70,lc:"#64748b",rc:"#eab308"}
  ];
  return (
    <div>
      {/* Hero */}
      <div style={{
        textAlign:"center",padding:"28px 20px",marginBottom:20,borderRadius:20,position:"relative",overflow:"hidden",
        background:"linear-gradient(180deg,"+gc+"12,"+gc+"04,transparent)"
      }}>
        <div style={{position:"absolute",inset:0,background:"radial-gradient(ellipse at 50% 0%,"+gc+"20,transparent 70%)"}} />
        <div style={{position:"relative",zIndex:1}}>
          <div style={{display:"inline-block",animation:"float 3s ease-in-out infinite"}}><Avatar type={type} size={90} /></div>
          <div style={{marginTop:14}}>
            <span style={{fontFamily:F.h,fontSize:32,fontWeight:900,background:S.gradient,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",letterSpacing:"0.04em"}}>{type}</span>
          </div>
          <p style={{fontFamily:F.b,fontSize:14,color:gc,fontWeight:700,margin:"4px 0 0"}}>{EM[type]} {NICK[type]}</p>
          <div style={{display:"flex",justifyContent:"center",gap:6,marginTop:10,flexWrap:"wrap"}}>
            <Pill text={GRP[type]} color={gc} glow />
            <Pill text={relData ? relData.l : ""} color={relData ? relData.c : gc} />
            <Pill text={talData ? talData.l : ""} color={talData ? talData.c : gc} />
          </div>
        </div>
      </div>

      {/* Profile */}
      <Card title="パーソナリティプロファイル" icon="📖" color={gc} delay={1} large>
        <p style={{fontFamily:F.b,fontSize:12,color:S.tx,lineHeight:2,margin:0}}>{PROF[type]}</p>
        {QT[type] ? (
          <div style={{marginTop:14}}>
            <p style={{fontFamily:F.b,fontSize:9,color:S.dm,margin:"0 0 6px",letterSpacing:"0.1em"}}>口ぐせ</p>
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {QT[type].map(function(q,i) {
                return <span key={i} style={{fontFamily:F.b,fontSize:10,color:gc,padding:"5px 12px",background:gc+"10",borderRadius:20,border:"1px solid "+gc+"20"}}>{q}</span>;
              })}
            </div>
          </div>
        ) : null}
      </Card>

      {/* 4 Letter Breakdown */}
      <Card title="認知機能の傾向" icon="🧬" color="#818cf8" delay={2}>
        {dims.map(function(d,i) { return <DimBar key={i} left={d.l} right={d.r} value={d.v} leftColor={d.lc} rightColor={d.rc} />; })}
        <Divider text="各レターの詳細" />
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          {type.split("").map(function(letter,i) {
            var lt = LT[letter];
            if (!lt) return null;
            return (
              <div key={i} style={{padding:10,borderRadius:10,background:lt.c+"08",border:"1px solid "+lt.c+"15"}}>
                <p style={{fontFamily:F.h,fontSize:11,color:lt.c,fontWeight:800,margin:"0 0 4px"}}>{letter}</p>
                <p style={{fontFamily:F.b,fontSize:9,color:lt.c+"cc",fontWeight:600,margin:"0 0 4px"}}>{lt.l}</p>
                <p style={{fontFamily:F.b,fontSize:9,color:S.dm,lineHeight:1.7,margin:0}}>{lt.d}</p>
              </div>
            );
          })}
        </div>
      </Card>

      {/* 2-letter personality blocks */}
      <Card title="パーソナリティの深層分析" icon="🔬" color="#a855f7" delay={3} large>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
          {[
            {title:"対人スタイル",data:relData,key:"rel"},
            {title:"エネルギー源",data:ecoData,key:"eco"},
            {title:"会議での役割",data:srData,key:"sr"},
            {title:"人生の価値観",data:lsData,key:"ls"},
            {title:"才能タイプ",data:talData,key:"tal"},
            {title:"チーム文化",data:geData,key:"ge"}
          ].map(function(block,i) {
            if (!block.data) return null;
            return (
              <div key={i} style={{padding:12,borderRadius:12,background:block.data.c+"08",border:"1px solid "+block.data.c+"12",animation:"fadeUp 0.4s ease both",animationDelay:i*0.06+"s"}}>
                <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:6}}>
                  <span style={{fontSize:16}}>{block.data.i}</span>
                  <div>
                    <p style={{fontFamily:F.b,fontSize:8,color:S.dm,margin:0,letterSpacing:"0.08em"}}>{block.title}</p>
                    <p style={{fontFamily:F.b,fontSize:11,color:block.data.c,fontWeight:700,margin:0}}>{block.data.l}</p>
                  </div>
                </div>
                <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.7,margin:"0 0 6px"}}>{block.data.d}</p>
                {block.data.lv ? <p style={{fontFamily:F.b,fontSize:9,color:S.dm,lineHeight:1.6,margin:0,fontStyle:"italic"}}>{block.data.lv || block.data.m || block.data.mt || block.data.s || block.data.w || ""}</p> : null}
                {block.data.sp ? <p style={{fontFamily:F.b,fontSize:9,color:block.data.c+"bb",margin:"4px 0 0",lineHeight:1.5}}>{"✦ "+block.data.sp}</p> : null}
              </div>
            );
          })}
        </div>
      </Card>

      {/* Cognitive Function Stack */}
      <Card title="心理機能スタック" icon="⚙️" color="#0ea5e9" delay={4} large>
        <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"0 0 14px",lineHeight:1.6}}>{type}が使う4つの心理機能を、得意な順に並べたものです。上ほど自然に使え、下ほど意識的な努力が必要です。</p>
        {(CF_STACK[type]||[]).map(function(fn,i){
          var info = CF_INFO[fn];
          var role = CF_ROLE[i];
          if(!info||!role) return null;
          return (
            <div key={i} style={{padding:14,borderRadius:14,background:role.c+"08",border:"1px solid "+role.c+"15",marginBottom:i<3?10:0,animation:"fadeUp 0.4s ease both",animationDelay:(i*0.1)+"s"}}>
              <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:8}}>
                <div style={{width:40,height:40,borderRadius:12,background:info.c+"15",display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,flexShrink:0}}>{info.icon}</div>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:2}}>
                    <span style={{fontFamily:F.h,fontSize:14,color:info.c,fontWeight:800}}>{info.abbr}</span>
                    <span style={{fontFamily:F.b,fontSize:10,color:info.c,fontWeight:600}}>{info.name}</span>
                  </div>
                  <div style={{display:"flex",alignItems:"center",gap:6}}>
                    <span style={{fontSize:10}}>{role.icon}</span>
                    <span style={{fontFamily:F.b,fontSize:9,color:role.c,fontWeight:700}}>{role.name}</span>
                    <span style={{fontFamily:F.b,fontSize:8,color:S.dm}}>— {role.sub}</span>
                  </div>
                </div>
              </div>
              <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.7,margin:0}}>{info.d}</p>
            </div>
          );
        })}

        {/* Stress reaction */}
        {CF_STRESS[type] ? (
          <div style={{marginTop:14,padding:14,borderRadius:14,background:"rgba(239,68,68,0.05)",border:"1px solid rgba(239,68,68,0.12)"}}>
            <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:6}}>
              <span style={{fontSize:14}}>😰</span>
              <p style={{fontFamily:F.b,fontSize:11,color:"#ef4444",fontWeight:700,margin:0}}>ストレス時の反応（劣等機能グリップ）</p>
            </div>
            <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.8,margin:0}}>{CF_STRESS[type]}</p>
          </div>
        ) : null}
      </Card>
    </div>
  );
}

/* ═══════════════════════════════════════════════
   TAB: LOVE (恋愛)
   ═══════════════════════════════════════════════ */
function LoveTab({type}) {
  var pairState = useState("");
  var t2 = pairState[0], setT2 = pairState[1];
  if (!type) return <EmptyState text="まず「分析」タブで自分のタイプを選んでください" />;
  var t1 = type, l1 = LOV[t1], l2 = t2 ? LOV[t2] : null;
  var compat = t2 ? calcLove(t1,t2) : null;
  var k = gk(t1), gc = GC[GRP[t1]], relData = REL[k.rel];

  return (
    <div>
      {/* My Love Style */}
      <Card title={t1+" の恋愛スタイル"} icon="💗" color="#ec4899" delay={0} large>
        <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:14}}>
          <Avatar type={t1} size={56} />
          <div>
            <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:4}}><Pill text={l1.s} color="#ec4899" glow /><Pill text={NICK[t1]} color={gc} /></div>
            <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:0}}>{relData ? relData.lv : ""}</p>
          </div>
        </div>
        <p style={{fontFamily:F.b,fontSize:11,color:S.tx,lineHeight:1.9,margin:"0 0 14px"}}>{l1.d}</p>
        <InfoGrid items={[
          {icon:"💝",label:"求めるもの",value:l1.n,color:"#ec4899"},
          {icon:"🎁",label:"与えるもの",value:l1.g,color:"#33b98a"},
          {icon:"⚠️",label:"注意ポイント",value:l1.warn,color:"#f97316"},
          {icon:"💬",label:"ストレス時",value:relData ? relData.stt : "",color:"#818cf8"}
        ]} />
      </Card>

      <Divider text="相性チェック" />

      {/* Partner Selection */}
      <Card title="相手のタイプを選択" icon="🔮" color="#a855f7" delay={1}>
        <TypeGrid value={t2} onChange={setT2} compact />
      </Card>

      {/* Partner's Love Style */}
      {(t2 && l2) ? (
        <Card title={t2+" の恋愛スタイル"} icon="💜" color={GC[GRP[t2]]} delay={2}>
          <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:10}}>
            <Avatar type={t2} size={50} />
            <div>
              <Pill text={l2.s} color="#a855f7" glow />
              <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"4px 0 0"}}>{NICK[t2]}</p>
            </div>
          </div>
          <p style={{fontFamily:F.b,fontSize:11,color:S.tx,lineHeight:1.9,margin:"0 0 10px"}}>{l2.d}</p>
          <InfoGrid items={[
            {icon:"💝",label:"求めるもの",value:l2.n,color:"#ec4899"},
            {icon:"🎁",label:"与えるもの",value:l2.g,color:"#33b98a"}
          ]} />
        </Card>
      ) : null}

      {/* Compatibility */}
      {compat ? (
        <Card title={t1+" × "+t2+" 恋愛相性"} icon="💕" color={compat.score>=70?"#33b98a":"#e4ae3a"} delay={3} large>
          <CompatResult data={compat} t1={t1} t2={t2} mode="love" />
          {BP[t1] ? (
            <div style={{marginTop:14,padding:12,borderRadius:12,background:"rgba(236,72,153,0.05)",border:"1px solid rgba(236,72,153,0.12)"}}>
              <p style={{fontFamily:F.b,fontSize:9,color:"#ec4899",fontWeight:700,margin:"0 0 6px"}}>💘 {t1}のベストパートナー</p>
              <div style={{display:"flex",gap:8}}>
                {BP[t1].map(function(bp){
                  return <div key={bp} style={{display:"flex",alignItems:"center",gap:6,padding:"4px 10px",borderRadius:16,background:"rgba(236,72,153,0.08)"}}>
                    <Avatar type={bp} size={22} /><span style={{fontFamily:F.h,fontSize:10,color:"#f9a8d4",fontWeight:600}}>{bp} {NICK[bp]}</span>
                  </div>;
                })}
              </div>
            </div>
          ) : null}
        </Card>
      ) : null}
    </div>
  );
}

/* ═══════════════════════════════════════════════
   TAB: WORK (仕事)
   ═══════════════════════════════════════════════ */
function WorkTab({type}) {
  var partnerState = useState("");
  var partner = partnerState[0], setPartner = partnerState[1];
  if (!type) return <EmptyState text="まず「分析」タブで自分のタイプを選んでください" />;
  var k = gk(type), gc = GC[GRP[type]], ws = WK[type], relData = REL[k.rel], talData = TAL[k.talent];
  var wc = partner ? calcWork(type,partner) : null;

  return (
    <div>
      {/* Career Profile */}
      <Card title={NICK[type]+"のキャリアプロファイル"} icon="💼" color="#3b82f6" delay={0} large>
        <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:14}}>
          <Avatar type={type} size={56} />
          <div style={{flex:1}}>
            <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:4}}>
              <Pill text={TR[type]} color="#3b82f6" glow />
              <Pill text={GRP[type]} color={gc} />
            </div>
            <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:0}}>才能: {talData ? talData.l : ""}</p>
          </div>
        </div>
        <p style={{fontFamily:F.b,fontSize:11,color:S.tx,lineHeight:1.9,margin:"0 0 14px"}}>{ws.d}</p>

        {/* Strengths & Weaknesses */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>
          <div style={{padding:12,borderRadius:12,background:"rgba(51,185,138,0.05)",border:"1px solid rgba(51,185,138,0.12)"}}>
            <p style={{fontFamily:F.b,fontSize:9,color:"#33b98a",fontWeight:800,margin:"0 0 8px",letterSpacing:"0.06em"}}>✦ 強み</p>
            <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
              {ws.str.map(function(s){return <Pill key={s} text={s} color="#33b98a" />;})}
            </div>
          </div>
          <div style={{padding:12,borderRadius:12,background:"rgba(249,115,22,0.05)",border:"1px solid rgba(249,115,22,0.12)"}}>
            <p style={{fontFamily:F.b,fontSize:9,color:"#f97316",fontWeight:800,margin:"0 0 8px",letterSpacing:"0.06em"}}>△ 課題</p>
            <div style={{display:"flex",flexWrap:"wrap",gap:4}}>
              {ws.weak.map(function(w){return <Pill key={w} text={w} color="#f97316" />;})}
            </div>
          </div>
        </div>

        {/* Recommended Jobs */}
        <div style={{padding:12,borderRadius:12,background:"rgba(155,109,255,0.05)",border:"1px solid rgba(155,109,255,0.12)"}}>
          <p style={{fontFamily:F.b,fontSize:9,color:"#9b6dff",fontWeight:800,margin:"0 0 8px",letterSpacing:"0.06em"}}>🎯 適職</p>
          <div style={{display:"flex",flexWrap:"wrap",gap:5}}>
            {ws.j.map(function(j){return <Pill key={j} text={j} color="#9b6dff" />;})}
          </div>
        </div>
      </Card>

      {/* Work Style Cards */}
      <Card title="仕事のスタイルと特性" icon="⚡" color="#e4ae3a" delay={1}>
        <InfoGrid items={[
          {icon:relData?relData.i:"",label:"対人スタイル",value:relData?relData.d:"",color:relData?relData.c:""},
          {icon:talData?talData.i:"",label:"才能タイプ",value:talData?talData.s:"",color:talData?talData.c:""},
          {icon:"😤",label:"ストレス要因",value:relData?relData.stt:"",color:"#ef4444"},
          {icon:"😓",label:"苦手な相手",value:ws.wm+" "+NICK[ws.wm]+" — 根本的にアプローチが異なるため摩擦が起きやすい",color:"#f97316"}
        ]} />
      </Card>

      <Divider text="仕事相性チェック" />

      {/* Partner Selection */}
      <Card title="同僚・上司のタイプを選択" icon="🤝" color="#0ea5e9" delay={2}>
        <TypeGrid value={partner} onChange={setPartner} compact />
      </Card>

      {/* Work Compatibility */}
      {wc ? (
        <Card title={type+" × "+partner+" 仕事相性"} icon="📊" color={wc.score>=70?"#33b98a":"#e4ae3a"} delay={3} large>
          <CompatResult data={wc} t1={type} t2={partner} mode="work" />
        </Card>
      ) : null}
    </div>
  );
}


/* ═══════════════════════════════════════════════
   TAB: 相関図 (Correlation Diagram) — 16types.studio style
   ═══════════════════════════════════════════════ */

/* --- Relationship labels (all from 16types.studio i18n relationshipLabels, casual display versions) --- */
var REL_LABELS = [
  {label:"沼りそう",color:"#ec4899"},{label:"ちょっと好き",color:"#a855f7"},
  {label:"相棒",color:"#3b82f6"},{label:"ライバル",color:"#f97316"},
  {label:"尊敬してる",color:"#22c55e"},{label:"気になる存在",color:"#06b6d4"},
  {label:"ドキドキ",color:"#FF6B9D"},{label:"波長合う",color:"#4A9EFF"},
  {label:"戦友",color:"#FF8C42"},{label:"安心感",color:"#33a474"},
  {label:"憧れ",color:"#FFB6C1"},{label:"刺激的",color:"#FF5757"},
  {label:"頼れる",color:"#4A9E9E"},{label:"謎",color:"#8B7FB8"},
  {label:"不思議",color:"#B8A8E0"},{label:"守りたい",color:"#FFA5C4"},
  {label:"恋愛で最高",color:"#ec4899"},{label:"仕事で良好",color:"#3b82f6"},
  {label:"親友の予感",color:"#a855f7"},{label:"恋の予感",color:"#FF6B9D"},
  {label:"まずは友達から",color:"#FFB84D"},{label:"運命的な出会い",color:"#9747FF"},
  {label:"尊敬し合える仲",color:"#22c55e"},{label:"刺激し合える関係",color:"#FF5757"}
];

/* --- Group description templates (6 per type, varied & fun) --- */
var GRP_DESC = {
  ENFP:["自由な発想と情熱が特徴の{name}は、このグループで雰囲気をあたたかくし、新しい可能性を次々に見つける魅力を発揮しています。","「それ面白いじゃん！」が口癖の{name}。このグループのアイデア発火装置として、みんなの創造力に火をつけています。","気づけばみんなが{name}の話に引き込まれている——そんな不思議な求心力がこのグループの空気を変えています。","{name}がいると「なんとかなりそう」感が2割増しになります。根拠はないけど、不思議と信じたくなるポジティブパワーの持ち主。","突拍子もないことを言い出すかと思えば、ちゃんと人の気持ちを見ている{name}。このグループの「自由だけど優しい風」です。","計画通りにいかなくても{name}だけは楽しそう。その姿がグループの「まあいっか精神」を支えています。"],
  INTJ:["洞察力と戦略性が特徴の{name}は、このグループで物事の本質を整理し、長期的な道筋を示す魅力を発揮しています。","黙って考えているように見えて、実は3手先まで読んでいる{name}。このグループの影の参謀です。","{name}の「それ、本当に必要？」という一言で、議論が一気に整理されることがあります。無駄を削ぎ落とす天才。","静かに話し始めた{name}の言葉に、なぜかみんな耳を傾けてしまう。少ない言葉で核心を突く力がこのグループの羅針盤。","{name}は表情が読みにくいけれど、実はこのグループのことをよく観察しています。信頼は行動で示すタイプ。","完璧を求めすぎて疲れていないか、ちょっと心配になる{name}。でもその緻密さがグループの品質を支えているのも事実。"],
  INTP:["論理性と好奇心が特徴の{name}は、このグループで新しい発見を促し、深い洞察を提供する魅力を発揮しています。","「なんで？」「でもそれって…」と問いを重ねる{name}。面倒に思えて、実はグループの思考レベルを引き上げています。","{name}の頭の中は小さな宇宙。突然飛び出す独自の視点に、みんなが「そういう見方もあるのか」とハッとさせられます。","普段は省エネモードの{name}が、好きなテーマになると急にギアが上がる。そのギャップがこのグループの隠し味。","このグループで一番「面白がる力」が強いのは{name}かもしれません。知的好奇心の塊が、退屈を許しません。","{name}が沈黙しているときは要注意——だいたい、とんでもないアイデアが発酵中です。"],
  ENTJ:["リーダーシップと決断力が特徴の{name}は、このグループで方向性を示し、目標達成へと導く魅力を発揮しています。","「で、結局どうする？」と切り込む{name}。このグループが迷子にならずに済んでいるのは、だいたいこの人のおかげ。","{name}の前では言い訳が通用しない。でもその厳しさの裏にある「みんなならできる」という信頼を、グループは感じています。","走り出したら止まらない{name}。その勢いに最初は驚くけれど、気づけばみんな同じ方向を向いている。天性のリーダー。","{name}が「任せて」と言ったら、本当に任せて大丈夫。このグループの安心感の土台を作っている人です。","実は誰よりもグループの成功を願っている{name}。表面的な厳しさの奥にある情熱を、みんなが少しずつ気づき始めています。"],
  ENTP:["創造性と議論好きな性格が特徴の{name}は、このグループで新しい可能性を探り、刺激的な対話を生む魅力を発揮しています。","あえて「逆のこと」を言って場をかき混ぜる{name}。でも不思議と、そのあと議論が深まる。天然のファシリテーター。","{name}の思いつきの半分は暴走、でも残りの半分は天才。このグループのイノベーション担当です。","退屈な空気を3秒で壊せるのが{name}の才能。真面目一辺倒になりそうなとき、いい意味で脱線させてくれます。","{name}が「ちょっと思ったんだけど」と言い出したら、会議は予定の3倍長くなる。でもその分、面白くなる。","ふざけているようで、ちゃんと全体を見ている{name}。このグループの「笑いと知恵のハイブリッド」です。"],
  INFJ:["共感力と洞察力が特徴の{name}は、このグループで深い理解を示し、調和をもたらす魅力を発揮しています。","言葉にする前に察してくれる{name}。このグループの「心のセンサー」として、誰かが辛いときにそっと寄り添っています。","{name}は静かだけど、実は一番みんなのことを考えている人。その深い思いやりが、グループのセーフティネットです。","「なぜかこの人には本音を話せる」——{name}にそう感じているメンバーは、きっと一人じゃないはず。","{name}が大事にしている理想やビジョンは、表に出さなくてもグループに静かな影響を与えています。灯台のような存在。","誰かの言葉の裏にある感情を読み取って、さりげなくフォローを入れる{name}。このグループの空気清浄機みたいな人。"],
  INFP:["優しさと創造性が特徴の{name}は、このグループで温かい雰囲気を作り、独自の視点を提供する魅力を発揮しています。","{name}が静かに微笑んでいるだけで、なぜかその場が丸くなる。このグループの「癒しの磁場」を作っている人。","表面上は控えめだけど、実は一番芯が強いかもしれない{name}。大切なことに対する姿勢は誰よりもまっすぐ。","{name}の感想は、いつも少し遅れてやってくる。でもその分、深くて温かい。このグループの「余韻」を担当しています。","「別にいいよ」と譲りつつ、実はちゃんと自分の中に答えを持っている{name}。その静かな信念がグループの芯になっています。","{name}が「いいね」と言ってくれると、他の誰に褒められるより嬉しかったりする。この人の承認には不思議な重みがあります。"],
  ENFJ:["カリスマ性と思いやりが特徴の{name}は、このグループで人を励まし、一体感を生み出す魅力を発揮しています。","「みんなどう？」が口癖の{name}。このグループの温度を常にチェックして、誰も置いていかない優しいリーダー。","{name}がいると、不思議とグループの連帯感が増す。見えない糸でみんなを結びつけるような存在です。","一人ひとりの良いところを見つけて、それを本人にちゃんと伝える{name}。このグループのモチベーション管理は{name}のおかげ。","{name}は頑張りすぎて疲れていることがある。でも「大丈夫？」と聞くと「うん、大丈夫」と笑う。そういうところが心配で、好き。","場の空気を読みすぎて我慢しているとき、{name}はある。でもその気遣いが、グループ全体の快適さを守っているのです。"],
  ISTJ:["誠実さと実務力が特徴の{name}は、このグループで安定感をもたらし、計画を着実に形にする魅力を発揮しています。","派手さはないけど{name}がいないとこのグループは回らない。地味に見えて、実は最重要人物。","約束の時間に絶対遅れない{name}。その「当たり前をちゃんとやる姿勢」が、このグループの信頼の土台を作っています。","{name}に「大丈夫」と言われると、本当に大丈夫な気がする。裏付けのある安心感を提供してくれる、頼れる存在。","真面目一直線に見えて、実はツボが浅い{name}。ふとした瞬間に見せる笑顔にグループがほっこりしています。","誰かが雑にやった仕事を、黙って直している{name}。その気遣いに気づいている人は、ちゃんといます。感謝。"],
  ISFJ:["献身性と細やかな気配りが特徴の{name}は、このグループで安心感を提供し、サポート役として活躍する魅力を発揮しています。","このグループで一番「ありがとう」を言われるべき人は{name}です。縁の下で静かに支え続けるその姿勢に頭が下がります。","{name}が持ってきたお菓子や、さりげなく入れてくれたお茶。そういう小さなケアがグループの幸福度を爆上げしています。","「大変だったね」と真っ先に声をかけてくれるのは、いつも{name}。このグループの心のお医者さんです。","{name}は自分のことは後回しにしがち。でもその優しさに報いたいと、みんな密かに思っているはず。","記憶力がいい{name}は、誰が何を好きで何が苦手か全部覚えている。このグループの生きたデータベースです。"],
  ESTJ:["組織力と実行力が特徴の{name}は、このグループで秩序を保ち、効率的に目標を達成する魅力を発揮しています。","「いつまでに誰がやる？」を明確にしてくれる{name}。このグループが前に進めるのは、この仕切り力のおかげ。","{name}のツッコミは鋭いけど愛がある。厳しく見えて、実はグループのために一番考えてくれている人。","ルールは守る、期限は守る、約束は守る。{name}の「当たり前力」がこのグループの信用を支えています。","たまに{name}がボソッと言うギャグが面白すぎる。普段のギャップがこのグループのスパイスになっています。","{name}がOKを出したら、それはもう安心して前に進めていいサイン。このグループの品質保証マークです。"],
  ESFJ:["社交性と思いやりが特徴の{name}は、このグループで温かい雰囲気を作り、皆をつなぐ魅力を発揮しています。","「最近どう？元気？」の一言を欠かさない{name}。このグループの人間関係を陰で支えている調整役。","{name}がいるだけで場が明るくなる。でもそれは天然じゃなくて、ちゃんと配慮した結果なんです。","誕生日もイベントも絶対忘れない{name}。このグループの「記念日管理大臣」兼「おもてなし番長」。","{name}は人のために頑張りすぎることがある。だからたまには{name}のために何かしたい——とグループは思っています。","ケンカが起きそうな時に、さりげなく話題を変えて空気を和ませる{name}。このグループの平和維持軍です。"],
  ISTP:["実用性と冷静さが特徴の{name}は、このグループで問題を素早く解決し、技術的な視点をもたらす魅力を発揮しています。","いざというとき頼りになるのは{name}。普段は静かだけど、問題が起きた瞬間にスイッチが入る頼もしい存在。","「考えるより先に手が動いてた」——そんなタイプの{name}が、このグループの実行スピードを支えています。","{name}の「別に」には3種類ある。本当にどうでもいい時、照れている時、そして深く考えている時。見極めが楽しい。","みんなが「どうしよう」と慌てている時に、{name}だけ冷静に解決策を出してくる。このグループのトラブルシューター。","口数は少ないけど、{name}が頷いてくれると安心する。「分かってる人が同意してくれた」という心強さがあります。"],
  ISFP:["芸術性と優しさが特徴の{name}は、このグループで独自の感性を示し、穏やかな雰囲気を作る魅力を発揮しています。","{name}のセンスは本物。選ぶもの、身につけるもの、全部にその人らしさが滲み出ていて、みんなが密かに参考にしています。","多くを語らないけど、{name}の表情には嘘がない。だからこのグループの中で一番「信頼できる反応」をくれる人。","{name}と一緒にいると、無理に何か話さなくても心地いい。「居てくれるだけでいい」を体現する存在。","静かに見えて、実は好きなものへの情熱がすごい{name}。その「好き」を語るときの表情が、このグループで一番いい顔。","{name}は争いを好まないけど、大事なことに対してはそっと、でもはっきり意見を言う。その静かな強さがグループの良心です。"],
  ESTP:["行動力と瞬発力が特徴の{name}は、このグループでスピード感をもたらし、現場を力強く推進する魅力を発揮しています。","「とりあえずやってみようぜ！」の{name}がいなかったら、このグループは永遠に計画だけで終わっていたかも。","{name}のフットワークの軽さは異常。思い立ったら即行動で、グループ全体のテンポを爆速にしてくれます。","ピンチに強すぎる{name}。むしろ困難を楽しんでいるフシがある。その姿を見て、みんなも「なんとかなるか」と思えます。","真面目な話をしている最中に{name}が空気を壊してくる。でもそのおかげで、硬くなりすぎずに済んでいるのも事実。","{name}の「大丈夫大丈夫」には根拠がないけど、不思議と信じたくなる。このグループの元気の源です。"],
  ESFP:["社交性とエネルギーが特徴の{name}は、このグループで楽しい雰囲気を作り、皆を元気づける魅力を発揮しています。","{name}がいるだけでイベント感が出る。普通の集まりが「今日楽しかったね」に変わるのは、この人のおかげ。","テンション上げたいときの特効薬、それが{name}。このグループの公式ムードメーカーに認定されています。","{name}は人の良いところを見つける天才。「それいいじゃん！」の一言で、何人のメンバーが救われたことか。","実はめちゃくちゃ人の空気を読んでいる{name}。楽しそうに見えて、実は周りのことをよく見ている繊細な一面も。","このグループの写真フォルダは、だいたい{name}が撮ったもので埋まっている。思い出を残す名人です。"]
};

/* --- Secret thought templates keyed by TARGET's MBTI (exact 16types.studio n object) --- */
var SECRET_BY_TYPE = {
  ENFP:["【A】は、ENFPの【B】の「ふいに核心を突く直感力」に実は驚かされています。説明してないのに察してくる瞬間があり、思わず「なぜ分かった？」と心の中で思っています。","【A】は、ENFPの【B】の「自由なのに気遣いが絶妙なところ」が実は気になっています。ふざけているようで周りをちゃんと見ている姿に、安心と不思議さが混ざった感情を抱きます。","【A】は、ENFPの【B】の「勢いだけじゃない繊細さ」に実は気づいています。テンションの裏にある優しさや直感の鋭さを感じると、思わず深掘りしてみたくなります。","【A】は、ENFPの【B】の「どんな話題もポジティブに変換してしまう力」に助けられています。落ち込みそうな空気を、いつの間にか「まあ何とかなるよね」に変えてくれる姿に、心の中で何度も救われています。","【A】は、ENFPの【B】の「人に興味を持ちすぎるくらい持ってくれるところ」に少し照れながらも嬉しくなっています。自分の小さな一言まで覚えていてくれるのを感じると、「こんなに見てくれてるんだ」と温かい気持ちになります。","【A】は、ENFPの【B】の「突然の思いつきから本当に物事を動かしてしまう行動力」に密かに感心しています。冗談みたいなアイデアがいつの間にか現実になっていて、「この人のノリは侮れない」と思っています。"],
  ENFJ:["【A】は、ENFJの【B】の「みんなの気持ちを先回りして動いてくれるところ」に、実はかなり甘えています。【B】が場を整えてくれるおかげで、「自分は好きにしゃべっていても大丈夫だ」と安心しています。","【A】は、ENFJの【B】の「誰に対しても温度差をつけない優しさ」にこっそり感心しています。自分なら気づかない小さな変化にも寄り添う姿を見て、「すごいな」と静かに尊敬しています。","【A】は、ENFJの【B】の「ビジョンを感情ごと伝えてくる力」に刺激を受けています。ロジックだけでは動かない人を動かしてしまうその影響力を、「自分にはない大事な要素だ」と感じています。","【A】は、ENFJの【B】の「どれだけ忙しくても、人との約束は後回しにしないところ」に胸を打たれています。スケジュールの隙間を縫ってでも時間を作る姿に、「人を大事にするってこういうことなんだな」と感じています。","【A】は、ENFJの【B】の「ときどき見せる弱音や本音」に、むしろ親近感を覚えています。いつも頼れる【B】がふっと力を抜く瞬間に、「この人を支える側にも回りたい」とひそかに思っています。","【A】は、ENFJの【B】の「場の空気を読みながら、難しい話もやわらかく伝えるセンス」に見惚れています。角が立ちそうな話も、なぜかみんな納得してしまう様子を見て、「天性の調整役だ」と感じています。"],
  ENTJ:["【A】は、ENTJの【B】の「サクッと決めてサクッと動くリーダーシップ」に密かにときめいています。多少強引でも前に進めてくれるその感じに、「この人について行ったらおもしろそう」とワクワクしています。","【A】は、ENTJの【B】の「判断基準がブレないところ」に安心感を覚えています。たとえ厳しく見えても、言っていることとやっていることが一致しているので、「信用できる」と感じています。","【A】は、ENTJの【B】の「勝負どころを逃さない嗅覚」に実は憧れています。ノリだけで動くのではなく、ちゃんと計算した上で攻めに転じる姿に「かっこいいな」と思っています。","【A】は、ENTJの【B】の「失敗を分析材料にして、次の一手に変えてしまう切り替えの速さ」に驚かされています。落ち込む暇もなく前を見ている姿に、「この人の時間は常に未来に向いている」と感じています。","【A】は、ENTJの【B】の「大きな絵を描きながら、細部の詰めも怠らないところ」に圧倒されています。ざっくりしているだけのリーダーではなく、「本当に全部見えているんだな」と実感しています。","【A】は、ENTJの【B】の「本気で取り組んでいる人に対しては、想像以上に面倒見がいいところ」に密かに気づいています。信じた相手に対しての深い思いやりと真剣な導きの力に、密かに憧れています。"],
  ENTP:["【A】は、ENTPの【B】の「その場でどんどんアイデアをひっくり返してくる頭の回転」にワクワクしています。自分の発言を面白がりながら広げてくれるので、「この人と話すと発想が解放される」と感じています。","【A】は、ENTPの【B】の「あえて逆張りすることで議論を深めるスタイル」を内心ありがたく思っています。面倒そうに見えて、本質をあぶり出す役割を果たしてくれていると感じ、「良いスパイスだ」と思っています。","【A】は、ENTPの【B】の「どんなテーマも笑いに変えてしまうところ」にかなり助けられています。場が重くなりそうな時でも、サラッと空気を変えてくれるので、「いてくれてよかった」と感じています。","【A】は、ENTPの【B】の「議論の最中でも、相手の感情のラインはちゃんと踏み越えない絶妙なさじ加減」に感心しています。ギリギリを攻めているようでいて、本当には壊さないバランス感覚に、「意外とやさしいんだな」と思っています。","【A】は、ENTPの【B】の「退屈そうに見えた会議を一瞬でブレスト大会に変えてしまう力」に感謝しています。予定調和を壊してくれるおかげで、「この場から何か生まれるかも」と感じられるようになります。","【A】は、ENTPの【B】の「興味を持ったときには異様な集中力で情報を集めてくるところ」に驚いています。さっきまでふざけていたのに、気づけば誰よりも詳しくなっていて、「この人の本気スイッチは怖い」と感じています。"],
  ESFP:["【A】は、ESFPの【B】の「今この瞬間を全力で楽しむ才能」に惹かれています。一緒にいると、自分まで「まあいっか」と肩の力が抜けていくのを感じて、また会いたくなります。","【A】は、ESFPの【B】の「初対面でも距離を一気に縮める明るさ」に実は助けられています。自分では話しかけづらい人とも自然に繋いでくれるので、「社交の窓口みたいな存在だ」と感じています。","【A】は、ESFPの【B】の「難しい話も体感ベースで理解しようとする姿勢」を面白く感じています。抽象的な話を「で、具体的には？」と現場に落としてくれるので、議論が現実的になると感じています。","【A】は、ESFPの【B】の「ちょっとした出来事もイベント級に盛り上げてくれるところ」に密かに感謝しています。単なる飲み会や雑談が、気づけば思い出になる感じに、「この人の場づくりってすごい」と感じています。","【A】は、ESFPの【B】の「人のいいところを見つけて、自然なノリで褒めてくれるところ」に救われています。照れくさいけれど、その一言で、その日一日が少し明るくなるのを感じています。","【A】は、ESFPの【B】の「実は人の空気の変化にとても敏感なところ」に気づいています。誰かのテンションが落ちた瞬間に、さりげなく話題を変えたり、いじられ役を買って出たりする姿に、「優しいな」と思っています。"],
  ESFJ:["【A】は、ESFJの【B】の「みんなのコンディションをさりげなく気にかけてくれるところ」に安心しています。何も言わなくても飲み物を勧めてくれたり、話を振ってくれたりする優しさに、「本当にありがたいな」と感じています。","【A】は、ESFJの【B】の「ルールと優しさのバランス感覚」に信頼を寄せています。きちんとすべきところはきちんとしつつ、誰も傷つけないように配慮する姿を見て、「任せて大丈夫な人だ」と思っています。","【A】は、ESFJの【B】の「全員を輪の中に入れようとするところ」に少し照れつつも感謝しています。自分が雑に振る舞っても、さりげなくフォローしてくれるので、「裏でめちゃくちゃ支えてもらってる」と感じています。","【A】は、ESFJの【B】の「忘れがちな記念日や節目をちゃんと覚えていてくれるところ」に心を打たれています。自分が流してしまいそうな日を丁寧に扱ってくれる姿に、「この人といると人生の密度が上がる」と感じています。","【A】は、ESFJの【B】の「自分の大変さをあまり表に出さないところ」が少し心配でもあります。誰かのために動きすぎているのを感じると、「たまには甘えてほしい」と密かに思っています。","【A】は、ESFJの【B】の「その場の『普通』を守りつつ、少しだけ楽しくしてくれるセンス」に助けられています。安心とワクワクがちょうど半々になる空気をつくる姿に、「場の温度管理のプロだな」と感じています。"],
  ESTP:["【A】は、ESTPの【B】の「予測不能なノリの良さ」に密かにワクワクしています。何か起きそうな気配に弱く、「次はどんな話が飛び出すんだろう」と期待で目が輝きます。","【A】は、ESTPの【B】の「状況を即興でひっくり返す力」を密かに尊敬しています。合理性では説明できない突破力に、少しだけ羨ましさを覚えています。","【A】は、ESTPの【B】の「行動の早さとぶっちゃけた会話」にこっそり惹かれています。自分にはないリズム感があり、聞いているだけで楽しくなります。","【A】は、ESTPの【B】の「ピンチのときほどテンションが上がって、笑いながら解決していくスタイル」に驚いています。普通なら焦る場面で「おもしろくなってきたじゃん」と言えるメンタルに、「この人、タフだな」と感じています。","【A】は、ESTPの【B】の「実は守るべきところはちゃんと守っているところ」に気づいています。冗談の裏でラインを越えない感覚に、「信頼していいタイプだ」と感じています。","【A】は、ESTPの【B】の「行動しながら考えるスタイル」に惹かれています。あれこれ議論する前にサクッと試してみる姿を見て、「口より行動ってこういうことか」と感心しています。"],
  ESTJ:["【A】は、ESTJの【B】の「言いにくいことを代わりに言ってくれる役回り」に助けられています。自分がふわっとさせがちな話を、締めるところはきっちり締めてくれるので、「ありがたいパイセン」だと感じています。","【A】は、ESTJの【B】の「段取りと指示が分かりやすいところ」に信頼を置いています。誰が何をいつまでにやるのかが明確なので、「この人がいると仕事が進む」と安心しています。","【A】は、ESTJの【B】の「勢いを現実の結果に変えてくれる実行力」に感心しています。思いつきで言った自分のアイデアを、気づいたらプロジェクトにしてくれていて、「やっぱリーダーだな」と感じています。","【A】は、ESTJの【B】の「口調は厳しくても、見ているポイントはいつもチーム全体であるところ」に気づいています。個人攻撃ではなく、全体のために言っているのが分かるので、「本当は優しい人だ」と感じています。","【A】は、ESTJの【B】の「過去の実績やデータをきちんと踏まえて判断する慎重さ」に安心しています。勢いだけではなく、「ここまで積み上げてきたから大丈夫」と言える根拠を持っているところに信頼を寄せています。","【A】は、ESTJの【B】の「たまに見せる小さなユーモア」に密かに喜んでいます。普段真面目な人から不意に出てくるボケやツッコミが、なぜか何倍もおもしろく感じられて、「このギャップはずるい」と思っています。"],
  INFP:["【A】は、INFPの【B】の「静かだけど芯の強い価値観」に惹かれています。大声で主張はしないのに、ふとした一言に深さがにじんでいて、「もっとこの人の世界を知りたい」と感じています。","【A】は、INFPの【B】の「人の気持ちを丁寧に扱おうとする姿勢」に一目置いています。ロジックでは切り捨てられない部分を大事にしてくれるおかげで、「自分の視野が補完されている」と感じています。","【A】は、INFPの【B】の「さりげない優しさで場のトゲを丸くするところ」に救われています。ピリッとした空気のあとにふっと和ませてくれるので、「この人がいると安心する」と思っています。","【A】は、INFPの【B】の「夢や理想の話をするときだけ、目が少しキラッとする瞬間」がたまらなく好きです。普段おだやかな分、その小さな変化が印象に残り、「もっと聞きたい」と思ってしまいます。","【A】は、INFPの【B】の「表ではあまり文句を言わないのに、心の中ではちゃんと自分なりのジャッジを持っているところ」に興味を持っています。何も言わないからといって何も考えていないわけではないと感じ、「その内側の世界をのぞいてみたくなる」と思っています。","【A】は、INFPの【B】の「自分のペースを守りながらも、人の痛みには敏感に反応するところ」に尊敬の念を抱いています。無理して前に出ようとはしないのに、「ここだけは」と思う場面でそっと手を差し伸べる姿に、静かな強さを感じています。"],
  INFJ:["【A】は、INFJの【B】の「あまり多くを語らないのにこちらの気持ちを読んでくるところ」にドキッとしています。自分でもまだ言語化できていない感情をそっと代弁されると、「なんで分かるの…？」と不思議な安心感を覚えます。","【A】は、INFJの【B】の「長期的なビジョンと人への配慮を両立させようとする姿勢」に共感しています。ただの理想論でも、ただの優しさでもない、その絶妙なバランス感覚を「希少なタイプだ」と感じています。","【A】は、INFJの【B】の「静かに場の空気を整えているところ」に気づいています。目立たないところで気を回してくれているのを感じると、「もっと感謝を言葉にしないと」と心の中で思っています。","【A】は、INFJの【B】の「人の矛盾や弱さを見ても、簡単に切り捨てないところ」に救われています。表面的には何も言わなくても、内側では理解しようとしてくれている気配に、「この人には本音を預けられる」と感じています。","【A】は、INFJの【B】の「たまにぽつりと話す『世界の見え方』の話」に強く惹かれています。みんなが気づいていない構造や背景を指し示されると、「この人はどんな景色を見て生きているんだろう」と興味が湧きます。","【A】は、INFJの【B】の「自分のことは後回しにしてでも、誰かの変化をそっと応援し続ける姿勢」に尊敬を抱いています。声高にアピールしないその支え方に、「静かな情熱ってこういうことか」と感じています。"],
  INTJ:["【A】は、INTJの【B】の「静かに燃えている情熱」に実は興味津々です。普段クールなのに、ふと見せる深い視点やこだわりを感じると、「もっと聞きたい…」と心がそっちに向かいます。","【A】は、INTJの【B】の「静かで鋭い観察眼」に興味を持っています。自分が見落としそうな点をさらっと指摘してくれるので、内心「助かる…」と思っています。","【A】は、INTJの【B】の「感情を揺らさず本質だけを拾う姿勢」にこっそり興味があります。無駄をそぎ落とすあの冷静さが、自分にはないものとして新鮮に映ります。","【A】は、INTJの【B】の「計画が頭のなかで何通りもシミュレーションされている感じ」に圧倒されています。黙っている時間の裏側で膨大な思考が回っている気配に、「この人の頭の中、一度覗いてみたい」と感じています。","【A】は、INTJの【B】の「人に流されず、自分の基準で『これが正しい』を決めているところ」に敬意を抱いています。多数派に合わせるより、筋を通すことを選ぶ姿に、「ぶれないってかっこいい」と思っています。","【A】は、INTJの【B】の「興味を持った対象への異常なまでの掘り下げ方」に驚かされています。表にはあまり出さないのに、話し始めると専門家レベルで語り出すギャップに、「この人、実はオタク気質だ」と密かに微笑んでいます。"],
  INTP:["【A】は、INTPの【B】の「ふとした一言にだけ鋭い真理が混ざっているところ」にツボっています。普段はゆるく見えるのに、急に核心をついてきて、「この人、本気出したらすごいんだろうな」と感じています。","【A】は、INTPの【B】の「前提から疑い直すクセ」を内心頼りにしています。当たり前のルールを壊してくれるので、「この視点があるからこそ誤った方向に走らずに済んでいる」と思っています。","【A】は、INTPの【B】の「興味のあることだけ異常な集中力を発揮するところ」に驚かされています。普段とのギャップが大きく、「スイッチ入るとこんなにすごいのか」と感心しています。","【A】は、INTPの【B】の「『なぜ？』を何度でも重ねてくるしつこさ」に、少し疲れつつも感謝しています。表面的な説明で満足しないおかげで、「本当に納得できるライン」までたどり着けていると感じています。","【A】は、INTPの【B】の「人間関係さえ頭の中ではちゃんとモデル化して観察している感じ」に気づいています。感情表現は控えめなのに、意外とよく人を見ているところに、「この人なりの優しさがある」と感じています。","【A】は、INTPの【B】の「話がときどき壮大な宇宙規模に飛んでいくところ」にクスッとしながらも魅力を感じています。すぐに日常から離陸してしまうその発想に、「こういう人が新しい概念を生むんだろうな」と思っています。"],
  ISFP:["【A】は、ISFPの【B】の「飾らないのにセンスが滲み出ているところ」に憧れています。ファッションや持ち物、話し方の一つひとつに、その人らしい美意識を感じて「真似したくなる」と思っています。","【A】は、ISFPの【B】の「争いを好まず、そっと距離感を調整するやり方」に安心感を覚えています。無理に場を仕切ろうとせず、それでもちゃんと周りを気遣っている姿に、「優しいな」と感じています。","【A】は、ISFPの【B】の「言葉少なめなのに表情と雰囲気で全部伝わってしまうところ」が気になっています。「さっきの一言、実はすごく重みがあったよね？」と、あとからじわじわ思い返しています。","【A】は、ISFPの【B】の「好き嫌いがはっきりしているのに、わざわざそれを押しつけてこないところ」に好感を抱いています。自分の感性を大事にしながら、人の世界も尊重している姿に、「大人だな」と感じています。","【A】は、ISFPの【B】の「さりげなく空間を整えたり、小物を選んだりするセンス」に魅了されています。何気ない選択の一つひとつが、場の居心地を良くしているのを感じて、「この人の世界観ごと好きだな」と思っています。","【A】は、ISFPの【B】の「『無理に話さなくても一緒にいられる』空気をつくってくれるところ」に救われています。沈黙が気まずくならない時間を共有できると、「この人とは本当に相性がいいのかもしれない」と感じています。"],
  ISFJ:["【A】は、ISFJの【B】の「誰よりも静かに一番働いているところ」に頭が上がりません。目立たない雑務やケアを当たり前のように引き受けてくれる姿に、「本当は一番感謝されるべき人だ」と感じています。","【A】は、ISFJの【B】の「約束と信頼をとても大事にするところ」に強く共感しています。一度引き受けたことを最後までやり切る姿を見て、「この人には安心して任せられる」と感じています。","【A】は、ISFJの【B】の「人の弱さを責めないまなざし」に救われています。うまくいかなかった話をしても否定せず受け止めてくれるので、「この人には本音を話せる」と思っています。","【A】は、ISFJの【B】の「細かい変化に気づいて、さりげないフォローを入れてくれるところ」に驚かされています。「最近疲れてない？」の一言で救われた日を思い出し、「本当に見てくれている」と感じています。","【A】は、ISFJの【B】の「自分のことより周りの状況を優先しがちなところ」を少し心配しつつも尊敬しています。誰かのために静かに時間と労力を差し出している姿に、「この人の優しさに報いたい」と思っています。","【A】は、ISFJの【B】の「控えめな中にある、芯の強さ」に感心しています。普段おだやかな分、その芯には重みがあり、「この人の価値観はちゃんと守られている」と感じています。"],
  ISTP:["【A】は、ISTPの【B】の「必要な時だけスッと動いて結果を出すところ」にキュンとしています。余計なことは言わないのに、いざという瞬間に一番頼れる感じがして、「ヒーローみたい」と感じています。","【A】は、ISTPの【B】の「感情に飲まれず淡々と問題を分解していくスタイル」を高く評価しています。みんなが焦っている時ほど冷静さを保っている姿に、「現場のプロだな」と感じています。","【A】は、ISTPの【B】の「群れずにマイペースを貫くところ」をちょっと羨ましく思っています。空気を読みつつも必要以上に合わせない姿を見て、「自分もああなりたい」と感じています。","【A】は、ISTPの【B】の「黙って作業しているようでいて、実は一番状況を把握しているところ」に気づいています。何も言わないのに、核心だけは外さない判断に、「この人の『分かってる感』すごい」と感じています。","【A】は、ISTPの【B】の「説明よりもまず手を動かして見せるスタイル」に惹かれています。あれこれ議論する前にサクッと試してみる姿を見て、「口より行動ってこういうことか」と感心しています。","【A】は、ISTPの【B】の「感情表現は控えめなのに、困っている人にはさりげなく手を貸しているところ」にキュンとしています。照れくさそうにしながらも、必要なサポートは外さない姿に、「誠実な優しさだな」と感じています。"],
  ISTJ:["【A】は、ISTJの【B】の「ぶれない安心感」に実は惹かれています。言葉数が少なくても、そこに滲む誠実さや優しさが気になり、つい近くに座りたくなることがあります。","【A】は、ISTJの【B】の「細部まで整える几帳面さ」に密かに安心しています。自分の計画が現実に落とし込まれていく感じが、言葉にせずとも心強く感じられます。","【A】は、ISTJの【B】の「何を任せても安心な落ち着き」に信頼を寄せています。行き当たりばったりな自分を、なぜか自然に補ってくれる存在として見ています。","【A】は、ISTJの【B】の「派手さはなくても、じわじわ効いてくる責任感」に惹かれています。その場だけ盛り上がるタイプではなく、「最後までいてくれる人」だと感じて、心の中で頼りにしています。","【A】は、ISTJの【B】の「一度決めたルールや約束を、状況が変わってもきちんと守ろうとする姿勢」に敬意を抱いています。損得勘定だけで動かないその誠実さに、「この人とは長く付き合える」と感じています。","【A】は、ISTJの【B】の「たまに見せる小さなユーモア」に密かに喜んでいます。普段真面目な人から不意に出てくるボケやツッコミが、なぜか何倍もおもしろく感じられて、「このギャップはずるい」と思っています。"]
};

/* --- Seeded PRNG r() — exact 16types.studio implementation --- */
function _rng16t(str) {
  var t=0, s=0;
  for(var i=0;i<str.length;i++) s+=str.charCodeAt(i);
  return function(){t++;var e=1e4*Math.sin(s+ ++t);return e-Math.floor(e);};
}

/* --- getRandomThought (o function) --- */
function _getRandomThought(mbti,seed){
  var pool=SECRET_BY_TYPE[mbti]||SECRET_BY_TYPE.ENFP;
  if(seed){var rng=_rng16t(seed);return pool[Math.floor(rng()*pool.length)];}
  return pool[Math.floor(Math.random()*pool.length)];
}

/* --- getGroupRandomThoughts (c function) — exact logic --- */
function _getGroupThoughts(members,seed){
  var all=[], rng=seed?_rng16t(seed):null;
  members.forEach(function(a){
    members.forEach(function(b){
      if(a.name!==b.name){
        var tmpl=_getRandomThought(b.mbti,seed);
        var text=tmpl.replace(/【A】/g,a.name).replace(/【B】/g,b.name);
        all.push({thought:text,from:a.name,to:b.name,orig:tmpl});
      }
    });
  });
  /* Shuffle */
  if(rng){for(var i=all.length-1;i>0;i--){var j=Math.floor(rng()*(i+1));var tmp=all[i];all[i]=all[j];all[j]=tmp;}}
  else{for(var i2=all.length-1;i2>0;i2--){var j2=Math.floor(Math.random()*(i2+1));var tmp2=all[i2];all[i2]=all[j2];all[j2]=tmp2;}}
  /* Pick 2 with unique from, to, template */
  var result=[],usedFrom=new Set,usedTo=new Set,usedTmpl=new Set;
  for(var k=0;k<all.length;k++){
    if(result.length>=2) break;
    var s=all[k];
    if(!usedFrom.has(s.from)&&!usedTo.has(s.to)&&!usedTmpl.has(s.orig)){
      result.push(s.thought);usedFrom.add(s.from);usedTo.add(s.to);usedTmpl.add(s.orig);
    }
  }
  if(result.length<2){for(var kk=0;kk<all.length&&result.length<2;kk++){if(!usedTmpl.has(all[kk].orig)){result.push(all[kk].thought);usedTmpl.add(all[kk].orig);}}}
  return result.slice(0,2);
}

/* --- Build directed edges (exact 16types.studio algorithm) --- */
function buildEdges16t(members, labels) {
  var seed = members.map(function(m){return m.mbti;}).sort().join("-");
  var edges=[], used=new Set(), usedLabels=new Set(), inCount=new Array(members.length).fill(0);
  var hashVal=0;
  for(var i=0;i<seed.length;i++) hashVal=(31*hashVal+seed.charCodeAt(i))%0x7fffffff;
  var counter=0;
  function rng(){counter++;var e=1e4*Math.sin(hashVal+12345*counter);return e-Math.floor(e);}
  function isReverse(f,t){return used.has(t+"-"+f);}
  function pickLabel(){
    var avail=labels.filter(function(l){return !usedLabels.has(l.label);});
    if(avail.length===0) return labels[Math.floor(rng()*labels.length)];
    return avail[Math.floor(rng()*avail.length)];
  }
  /* Phase 1: each person gets up to 2 incoming */
  for(var t=0;t<members.length;t++){
    var cands=[];
    for(var f=0;f<members.length;f++){
      if(f===t||isReverse(f,t)||used.has(f+"-"+t)) continue;
      cands.push(f);
    }
    for(var ci=cands.length-1;ci>0;ci--){var j=Math.floor(rng()*(ci+1));var tmp=cands[ci];cands[ci]=cands[j];cands[j]=tmp;}
    for(var ck=0;ck<cands.length&&inCount[t]<2;ck++){
      var from=cands[ck], lbl=pickLabel();
      edges.push({from:from,to:t,label:lbl.label,color:lbl.color});
      used.add(from+"-"+t); usedLabels.add(lbl.label); inCount[t]++;
    }
  }
  /* Phase 2: extra random edges */
  var maxExtra=Math.min(members.length,3), extra=0;
  for(var tt=0;tt<members.length&&extra<maxExtra;tt++){
    for(var ff=0;ff<members.length&&extra<maxExtra;ff++){
      if(tt===ff) continue;
      var key=tt+"-"+ff;
      if(used.has(key)||isReverse(tt,ff)) continue;
      if(rng()>0.7){
        var lb=pickLabel();
        edges.push({from:tt,to:ff,label:lb.label,color:lb.color});
        used.add(key); usedLabels.add(lb.label); inCount[ff]++; extra++;
      }
    }
  }
  return edges;
}

/* --- Group description with seeded variety (different template per member) --- */
var _descUsedSet = new Set();
function pickGroupDesc16t(m, allMembers) {
  var pool = GRP_DESC[m.mbti] || ["独自の魅力を持つ{name}は、このグループで重要な役割を果たしています。"];
  /* Seed from member name + all members' MBTIs for deterministic but varied selection */
  var seed = m.name + m.mbti + (allMembers||[]).map(function(x){return x.mbti;}).sort().join("");
  var rng = _rng16t(seed);
  /* Try to pick unused template index */
  var idx = Math.floor(rng() * pool.length);
  var attempts = 0;
  while(_descUsedSet.has(m.mbti+"-"+idx) && attempts < pool.length) {
    idx = (idx + 1) % pool.length;
    attempts++;
  }
  _descUsedSet.add(m.mbti+"-"+idx);
  return pool[idx].replace(/{name}/g, m.name);
}

/* --- Main Correlation Tab Component --- */
function CorrelationTab() {
  var membersState = useState([]);
  var members = membersState[0], setMembers = membersState[1];
  var nameState = useState("");
  var nameInput = nameState[0], setNameInput = nameState[1];
  var typeState = useState("");
  var typeInput = typeState[0], setTypeInput = typeState[1];
  var hoveredNode = useState(null);
  var hovered = hoveredNode[0], setHovered = hoveredNode[1];

  function addMember() {
    if (nameInput.trim() && typeInput && members.length < 8) {
      setMembers(function(prev){ return prev.concat([{name:nameInput.trim(), mbti:typeInput, id:Date.now()}]); });
      setNameInput(""); setTypeInput("");
    }
  }
  function removeMember(id) {
    setMembers(function(prev){ return prev.filter(function(m){return m.id!==id;}); });
  }

  /* Build edges */
  var edges = members.length >= 2 ? buildEdges16t(members, REL_LABELS) : [];

  /* Today's star = seeded by member combination (same members → same star every time) */
  var starIdx = -1;
  if (members.length >= 2) {
    var starSeed = members.map(function(m){return m.name+m.mbti;}).sort().join("-");
    var starRng = _rng16t(starSeed);
    starIdx = Math.floor(starRng() * members.length);
  }

  /* SVG layout (matching 16types.studio: viewBox 0 0 900 900, radius 220, nodeR 50) */
  var n = members.length;
  var svgVB = 900, svgCx = 400, svgCy = 400, svgRadius = 280, nodeR = 50;
  var angleStep = n > 0 ? (2 * Math.PI / n) : 0;
  var nodePositions = members.map(function(_, idx) {
    if (n === 2) return {x: svgCx + (idx===0?-180:180), y: svgCy};
    return {x: svgCx + svgRadius * Math.cos(idx * angleStep - Math.PI / 2),
            y: svgCy + svgRadius * Math.sin(idx * angleStep - Math.PI / 2)};
  });

  /* Secret thoughts */
  var secrets = [];
  if (members.length >= 2) {
    var sSeed = members.map(function(m){return m.mbti;}).sort().join("-");
    secrets = _getGroupThoughts(members, sSeed);
  }

  /* Reset desc counter */
  _descUsedSet = new Set();

  /* Scale SVG to fit container */
  var containerW = 420;
  var scale = containerW / svgVB;

  return (
    <div>
      {/* Member Input */}
      <Card title="メンバーを追加" icon="✏️" color="#8B5CF6" delay={0} large>
        <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"0 0 12px"}}>名前とタイプを入力してメンバーを追加（最大8名）</p>
        <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center"}}>
          <input value={nameInput} onChange={function(e){setNameInput(e.target.value);}}
            onKeyDown={function(e){if(e.key==="Enter"&&typeInput)addMember();}}
            placeholder="名前を入力"
            style={{flex:1,padding:"10px 14px",borderRadius:12,border:"1px solid "+S.border,background:S.glass,color:S.tx,fontFamily:F.b,fontSize:12,outline:"none",transition:"border-color 0.2s"}}
            onFocus={function(e){e.target.style.borderColor="#8B5CF6";}} onBlur={function(e){e.target.style.borderColor=S.border;}} />
          <button onClick={addMember} disabled={!nameInput.trim()||!typeInput||members.length>=8}
            style={{all:"unset",cursor:(!nameInput.trim()||!typeInput)?"default":"pointer",padding:"10px 18px",borderRadius:12,fontFamily:F.b,fontSize:11,fontWeight:700,
              background:(!nameInput.trim()||!typeInput)?"rgba(255,255,255,0.03)":"linear-gradient(135deg,#8B5CF6,#6db8ff)",color:(!nameInput.trim()||!typeInput)?S.dm:"#fff",transition:"all 0.2s",letterSpacing:"0.04em"}}>追加</button>
        </div>
        <div style={{marginBottom:12}}>
          <p style={{fontFamily:F.b,fontSize:9,color:S.dm,margin:"0 0 6px"}}>タイプを選択:</p>
          <div style={{display:"flex",flexDirection:"column",gap:6}}>
            {GRPS.map(function(g) {
              return (<div key={g.name}>
                <div style={{display:"flex",alignItems:"center",gap:4,marginBottom:3}}>
                  <div style={{width:6,height:6,borderRadius:2,background:g.color}} />
                  <span style={{fontFamily:F.b,fontSize:8,color:g.color,fontWeight:700}}>{g.name}</span>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:4}}>
                  {g.types.map(function(t) {
                    var sel = typeInput === t;
                    return (<button key={t} onClick={function(){setTypeInput(sel?"":t);}}
                      style={{all:"unset",cursor:"pointer",textAlign:"center",padding:"6px 2px",borderRadius:8,
                        background:sel?g.color+"25":S.glass,border:sel?"1.5px solid "+g.color+"70":"1px solid "+S.border,transition:"all 0.2s"}}>
                      <span style={{fontFamily:F.h,fontSize:10,color:sel?g.color:S.dm,fontWeight:sel?700:500}}>{t}</span>
                    </button>);
                  })}
                </div>
              </div>);
            })}
          </div>
        </div>
        {members.length > 0 ? (
          <div>
            <Divider text={"メンバー ("+members.length+"名)"} />
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {members.map(function(m,idx) {
                var gc = GC[GRP[m.mbti]];
                return (<div key={m.id} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 12px",borderRadius:14,
                  background:idx===starIdx?("linear-gradient(135deg,#fef3c7,#fde68a22)"):(gc+"12"),
                  border:idx===starIdx?("2px dashed #fbbf24"):("1px solid "+gc+"30"),
                  animation:"fadeUp 0.3s ease both",boxShadow:idx===starIdx?"0 0 12px rgba(251,191,36,0.2)":"none"}}>
                  <Avatar type={m.mbti} size={22} />
                  <span style={{fontFamily:F.b,fontSize:11,color:gc,fontWeight:700}}>{m.name}</span>
                  <span style={{fontFamily:F.h,fontSize:9,color:gc+"99"}}>{m.mbti}</span>
                  {idx===starIdx?<span style={{fontSize:9,background:"#fbbf24",color:"#fff",padding:"1px 6px",borderRadius:8,fontFamily:F.b,fontWeight:700,letterSpacing:"0.04em"}}>⭐ 今日の主役</span>:null}
                  <button onClick={function(){removeMember(m.id);}} style={{all:"unset",cursor:"pointer",fontSize:12,color:S.dm,marginLeft:2,lineHeight:1,opacity:0.5}}>✕</button>
                </div>);
              })}
            </div>
          </div>
        ) : null}
      </Card>

      {/* === Results === */}
      {members.length >= 2 ? (
        <div>
          {/* Diagram */}
          <Card title="相関図診断 結果" icon="🔮" color="#6db8ff" delay={1} large>
            <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"0 0 8px",textAlign:"center"}}>人にカーソルを合わせると関係性が表示されます</p>
            <div style={{display:"flex",justifyContent:"center",marginBottom:8}}>
              <svg width="100%" style={{maxWidth:480,display:"block",margin:"0 auto",overflow:"visible"}} viewBox={"0 0 "+svgVB+" "+svgVB} preserveAspectRatio="xMidYMid meet">
                <defs>
                  {edges.map(function(e,idx){
                    var active = hovered===e.from||hovered===e.to;
                    return <marker key={"mk"+idx} id={"arw"+idx} markerWidth="5" markerHeight="5" refX="2.5" refY="2.5" orient="auto"><polygon points="0 0, 5 2.5, 0 5" fill={active?e.color:"#94a3b8"} /></marker>;
                  })}
                </defs>

                {/* Edge lines (path, matching 16types.studio) */}
                {edges.map(function(e, idx) {
                  var p1 = nodePositions[e.from], p2 = nodePositions[e.to];
                  if(!p1||!p2)return null;
                  var dx=p2.x-p1.x, dy=p2.y-p1.y, len=Math.sqrt(dx*dx+dy*dy)||1;
                  var ux=dx/len, uy=dy/len;
                  var x1=p1.x+ux*(nodeR)+50, y1=p1.y+uy*(nodeR)+50;
                  var x2=p2.x-ux*(nodeR+15)+50, y2=p2.y-uy*(nodeR+15)+50;
                  var active = hovered===e.from||hovered===e.to;
                  var d = "M "+x1+" "+y1+" L "+x2+" "+y2;
                  return (<path key={"l"+idx} d={d}
                    stroke={active?e.color:"#e2e8f0"} strokeWidth={active?3:2}
                    fill="none" markerEnd={"url(#arw"+idx+")"} style={{transition:"all 0.2s"}} />);
                })}

                {/* Nodes */}
                {members.map(function(m, idx) {
                  var pos = nodePositions[idx];
                  var isHov = hovered === idx;
                  var isStar = idx === starIdx;
                  return (
                    <g key={"n"+idx} style={{cursor:"pointer"}}
                      onMouseEnter={function(){setHovered(idx);}} onMouseLeave={function(){setHovered(null);}}>
                      {isHov ? <circle cx={pos.x+50} cy={pos.y+50} r={nodeR+10} fill="none" stroke="#3b82f6" strokeWidth={3} opacity={0.3} /> : null}
                      <circle cx={pos.x+50} cy={pos.y+50} r={nodeR} fill={isHov?"#3b82f6":"#60a5fa"} style={{transition:"all 0.2s"}} />
                      <text x={pos.x+50} y={pos.y+60} textAnchor="middle"
                        style={{fontSize:40,fontWeight:700,fill:"#fff",fontFamily:F.b,pointerEvents:"none"}}>{m.name.charAt(0)}</text>
                      <text x={pos.x+50} y={pos.y+82} textAnchor="middle"
                        style={{fontSize:18,fontWeight:800,fill:"#fff",fontFamily:F.h,pointerEvents:"none"}}>{m.mbti}</text>
                      {isStar ? (<g>
                        <circle cx={pos.x+50} cy={pos.y+50} r={nodeR+16} fill="none" stroke="#fbbf24" strokeWidth={2.5} strokeDasharray="8 4" opacity={0.9}>
                          <animateTransform attributeName="transform" type="rotate" from={"0 "+(pos.x+50)+" "+(pos.y+50)} to={"360 "+(pos.x+50)+" "+(pos.y+50)} dur="12s" repeatCount="indefinite" />
                        </circle>
                        <rect x={pos.x+5} y={pos.y-28} width={90} height={26} rx={13} fill="#fbbf24" filter="drop-shadow(0 2px 4px rgba(251,191,36,0.4))" />
                        <text x={pos.x+50} y={pos.y-10} textAnchor="middle"
                          style={{fontSize:12,fontWeight:800,fill:"#fff",fontFamily:F.b,pointerEvents:"none"}}>⭐ 今日の主役</text>
                      </g>) : null}
                      <text x={pos.x+50} y={pos.y+130} textAnchor="middle"
                        style={{fontSize:18,fontWeight:600,fill:S.dm,fontFamily:F.b,pointerEvents:"none"}}>{m.name}</text>
                    </g>
                  );
                })}

                {/* Label pills (only on hover, matching 16types.studio) */}
                <g style={{pointerEvents:"none"}}>
                {edges.map(function(e, idx) {
                  var p1 = nodePositions[e.from], p2 = nodePositions[e.to];
                  if(!p1||!p2)return null;
                  var active = hovered===e.from||hovered===e.to;
                  if(!active) return null;
                  var dx=p2.x-p1.x, dy=p2.y-p1.y, len=Math.sqrt(dx*dx+dy*dy)||1;
                  var ux=dx/len, uy=dy/len;
                  var x1=p1.x+ux*nodeR+50, y1=p1.y+uy*nodeR+50;
                  var x2=p2.x-ux*(nodeR+15)+50, y2=p2.y-uy*(nodeR+15)+50;
                  var mx=(x1+x2)/2+(-uy)*20, my=(y1+y2)/2+(ux)*20;
                  return (<g key={"lb"+idx}>
                    <rect x={mx-55} y={my-15} width={110} height={30} rx={6} fill="white" opacity={0.95} filter="drop-shadow(0 2px 6px rgba(0,0,0,0.12))" />
                    <text x={mx} y={my+6} textAnchor="middle"
                      style={{fontSize:18,fontWeight:700,fill:e.color,fontFamily:F.b}}>{e.label}</text>
                  </g>);
                })}
                </g>
              </svg>
            </div>
          </Card>

          {/* Group Descriptions */}
          <Card title="このグループの説明書" icon="📖" color="#33b98a" delay={2} large>
            {members.map(function(m,idx) {
              var gc = GC[GRP[m.mbti]];
              var desc = pickGroupDesc16t(m, members);
              return (
                <div key={m.id} style={{marginBottom:idx<members.length-1?12:0,animation:"fadeUp 0.4s ease both",animationDelay:idx*0.08+"s"}}>
                  <p style={{fontFamily:F.b,fontSize:13,color:gc,fontWeight:800,margin:"0 0 4px"}}>{m.name} <span style={{fontFamily:F.h,fontSize:10,fontWeight:600,color:gc+"99"}}>{m.mbti}</span></p>
                  <p style={{fontFamily:F.b,fontSize:11,color:S.tx,lineHeight:1.9,margin:0}}>{desc}</p>
                </div>
              );
            })}
          </Card>

          {/* Secret Thoughts */}
          {secrets.length > 0 ? (
            <Card title="ひそかに思っていること" icon="💭" color="#64748B" delay={3} large>
              <div style={{display:"flex",flexDirection:"column",gap:10}}>
                {secrets.map(function(text,idx) {
                  var dotIdx = text.indexOf("\u3002");
                  var first = dotIdx>=0 ? text.substring(0,dotIdx+1) : text;
                  var rest = dotIdx>=0 ? text.substring(dotIdx+1) : "";
                  return (
                    <p key={idx} style={{fontFamily:F.b,fontSize:11,color:S.tx,lineHeight:1.9,margin:0,animation:"fadeUp 0.4s ease both",animationDelay:idx*0.1+"s"}}>
                      <span style={{fontWeight:700}}>{first}</span>{rest}
                    </p>
                  );
                })}
              </div>
            </Card>
          ) : null}
        </div>
      ) : (
        <EmptyState text="2名以上のメンバーを追加すると相関図が表示されます" />
      )}
    </div>
  );
}


/* ═══════════════════════════════════════════════
   TAB: TEAM (チーム)
   ═══════════════════════════════════════════════ */

function TeamAnalysisTabs({strengths, weaknesses, gaps}) {
  var tabState = useState("strengths");
  var activeTab = tabState[0], setTab = tabState[1];

  var healthScore = Math.max(0, 100 - gaps.length * 12);
  var healthColor = healthScore >= 80 ? "#33b98a" : healthScore >= 50 ? "#eab308" : "#f97316";
  var healthLabel = healthScore >= 80 ? "とても健全" : healthScore >= 50 ? "おおむね良好" : "要改善あり";

  var tabs = [
    {id:"strengths",label:"✨ 強み",count:strengths.length,color:"#8b5cf6"},
    {id:"weaknesses",label:"⚠️ 弱み",count:weaknesses.length,color:"#eab308"},
    {id:"gaps",label:"🔧 改善",count:gaps.length,color:"#f97316"}
  ];

  return (
    <div>
      <div style={{display:"flex",gap:5,marginBottom:14}}>
        {tabs.map(function(t){
          var active = activeTab===t.id;
          return (
            <button key={t.id} onClick={function(){setTab(t.id);}}
              style={{all:"unset",cursor:"pointer",flex:1,textAlign:"center",padding:"9px 4px",borderRadius:12,
                fontFamily:F.b,fontSize:11,fontWeight:700,
                background:active?t.color+"18":"transparent",
                color:active?t.color:S.dm,
                border:active?"1.5px solid "+t.color+"40":"1.5px solid transparent",
                transition:"all 0.2s"}}>
              {t.label}<span style={{fontSize:9,opacity:0.7,marginLeft:3}}>({t.count})</span>
            </button>
          );
        })}
      </div>

      {/* ── 強み Tab ── */}
      {activeTab==="strengths" ? (
        strengths.length > 0 ? strengths.map(function(s,i){
          return (
            <div key={i} style={{padding:14,borderRadius:12,background:"rgba(139,92,246,0.03)",border:"1px solid rgba(139,92,246,0.08)",marginBottom:10}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}>
                <span style={{fontSize:16,flexShrink:0}}>{s.icon}</span>
                <p style={{fontFamily:F.b,fontSize:11,color:"#7c3aed",fontWeight:700,margin:0,flex:1}}>{s.title}</p>
                {s.pct ? <span style={{fontFamily:F.h,fontSize:9,color:"#8b5cf6",fontWeight:700,background:"rgba(139,92,246,0.12)",padding:"2px 7px",borderRadius:8,flexShrink:0}}>{s.pct}%</span> : null}
              </div>
              <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.7,margin:"0 0 8px"}}>{s.desc}</p>
              {s.tip ? (
                <div style={{padding:10,borderRadius:8,background:"rgba(139,92,246,0.05)",border:"1px solid rgba(139,92,246,0.10)"}}>
                  <p style={{fontFamily:F.b,fontSize:9,color:"#8b5cf6",fontWeight:700,margin:"0 0 3px"}}>💎 活かし方</p>
                  <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.7,margin:0}}>{s.tip}</p>
                </div>
              ) : null}
            </div>
          );
        }) : (
          <div style={{textAlign:"center",padding:20}}>
            <span style={{fontSize:24}}>⚖️</span>
            <p style={{fontFamily:F.b,fontSize:11,color:"#8b5cf6",fontWeight:700,margin:"8px 0 4px"}}>バランス型チーム</p>
            <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:0}}>突出した偏りがなく、多角的なアプローチが可能なチームです。</p>
          </div>
        )
      ) : null}

      {/* ── 弱み Tab ── */}
      {activeTab==="weaknesses" ? (
        weaknesses.length > 0 ? (
          <div>
            {weaknesses.map(function(w,i){
              return (
                <div key={i} style={{padding:12,borderRadius:12,background:"rgba(234,179,8,0.04)",border:"1px solid rgba(234,179,8,0.10)",marginBottom:8}}>
                  <div style={{display:"flex",gap:10,alignItems:"flex-start"}}>
                    <span style={{fontSize:18,flexShrink:0,marginTop:2}}>{w.icon}</span>
                    <div style={{flex:1}}>
                      <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
                        <p style={{fontFamily:F.b,fontSize:11,color:w.sevColor||"#eab308",fontWeight:700,margin:0}}>{w.title}</p>
                        <span style={{fontFamily:F.h,fontSize:8,color:"white",fontWeight:700,background:w.sevColor||"#eab308",padding:"1px 6px",borderRadius:6,flexShrink:0}}>{w.severity||"不足"}</span>
                      </div>
                      <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.7,margin:"0 0 6px"}}>{w.desc}</p>
                      <div style={{display:"flex",alignItems:"center",gap:8}}>
                        <div style={{flex:1,height:4,borderRadius:2,background:"rgba(255,255,255,0.08)"}}>
                          <div style={{width:Math.max(2,w.pct)+"%",height:4,borderRadius:2,background:w.sevColor||"#eab308",transition:"width 0.5s"}} />
                        </div>
                        <span style={{fontFamily:F.h,fontSize:9,color:w.sevColor||"#eab308",fontWeight:700,flexShrink:0}}>{w.count}名 / {w.pct}%</span>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <div style={{textAlign:"center",padding:20}}>
            <span style={{fontSize:24}}>💪</span>
            <p style={{fontFamily:F.b,fontSize:11,color:"#33b98a",fontWeight:700,margin:"8px 0 4px"}}>目立った弱みなし！</p>
            <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:0}}>認知機能が万遍なくカバーされており、大きな弱点のないチームです。</p>
          </div>
        )
      ) : null}

      {/* ── 改善ポイント Tab ── */}
      {activeTab==="gaps" ? (
        <div>
          {/* Health score banner */}
          <div style={{padding:14,borderRadius:14,background:"rgba(0,0,0,0.15)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:14,display:"flex",alignItems:"center",gap:14}}>
            <div style={{position:"relative",width:56,height:56,flexShrink:0}}>
              <svg width={56} height={56} viewBox="0 0 56 56">
                <circle cx={28} cy={28} r={24} fill="none" stroke="rgba(255,255,255,0.08)" strokeWidth={5} />
                <circle cx={28} cy={28} r={24} fill="none" stroke={healthColor} strokeWidth={5}
                  strokeDasharray={2*Math.PI*24} strokeDashoffset={2*Math.PI*24*(1-healthScore/100)}
                  strokeLinecap="round" transform="rotate(-90 28 28)" style={{transition:"stroke-dashoffset 0.8s ease"}} />
              </svg>
              <div style={{position:"absolute",top:0,left:0,width:56,height:56,display:"flex",alignItems:"center",justifyContent:"center"}}>
                <span style={{fontFamily:F.h,fontSize:16,fontWeight:800,color:healthColor}}>{healthScore}</span>
              </div>
            </div>
            <div style={{flex:1}}>
              <p style={{fontFamily:F.b,fontSize:12,color:healthColor,fontWeight:700,margin:"0 0 3px"}}>チーム健全度: {healthLabel}</p>
              <p style={{fontFamily:F.b,fontSize:9,color:S.dm,margin:0,lineHeight:1.5}}>
                {gaps.length > 0 ? gaps.length+"つの改善ポイントが見つかりました。" : "認知機能がバランスよく配分されています。"}
              </p>
            </div>
          </div>

          {/* Gaps - always fully expanded */}
          {gaps.length > 0 ? gaps.map(function(gap,i){
            return (
              <div key={i} style={{padding:14,borderRadius:12,background:"rgba(249,115,22,0.04)",border:"1px solid rgba(249,115,22,0.10)",marginBottom:10}}>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                  <p style={{fontFamily:F.b,fontSize:12,color:"#fb923c",fontWeight:700,margin:0,flex:1}}>{gap.issue}</p>
                  <span style={{fontFamily:F.h,fontSize:9,color:"#fb923c",fontWeight:700,background:"rgba(249,115,22,0.12)",padding:"2px 7px",borderRadius:8,flexShrink:0}}>{gap.count}名 ({gap.pct}%)</span>
                </div>
                <p style={{fontFamily:F.b,fontSize:10,color:S.tx,lineHeight:1.7,margin:"0 0 10px"}}>{gap.fix}</p>
                {gap.action ? (
                  <div style={{padding:10,borderRadius:8,background:"rgba(51,185,138,0.06)",border:"1px solid rgba(51,185,138,0.12)",marginBottom:10}}>
                    <p style={{fontFamily:F.b,fontSize:9,color:"#33b98a",fontWeight:700,margin:"0 0 3px"}}>💡 改善アクション</p>
                    <p style={{fontFamily:F.b,fontSize:10,color:"#a7f3d0",lineHeight:1.7,margin:0}}>{gap.action}</p>
                  </div>
                ) : null}
                <p style={{fontFamily:F.b,fontSize:9,color:S.dm,margin:"0 0 6px"}}>補強候補:</p>
                <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                  {gap.suggest.map(function(s) {
                    return <div key={s} style={{display:"flex",alignItems:"center",gap:5,padding:"4px 10px",borderRadius:12,background:GC[GRP[s]]+"12",border:"1px solid "+GC[GRP[s]]+"25"}}>
                      <Avatar type={s} size={20} /><span style={{fontFamily:F.h,fontSize:9,color:GC[GRP[s]],fontWeight:600}}>{s}</span>
                    </div>;
                  })}
                </div>
              </div>
            );
          }) : (
            <div style={{textAlign:"center",padding:20}}>
              <span style={{fontSize:24}}>🎉</span>
              <p style={{fontFamily:F.b,fontSize:11,color:"#33b98a",fontWeight:700,margin:"8px 0 4px"}}>改善不要！</p>
              <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:0}}>全ての認知機能がバランスよく配分されている理想的なチームです。</p>
            </div>
          )}
        </div>
      ) : null}
    </div>
  );
}

function teamCompatScore(a,b) {
  if(a===b) return {score:3,label:"同一タイプ",emoji:"🪞",color:"#6B7280",desc:"同じ視点で深く共感し合える。ただし盲点も共有しやすい"};
  /* Golden pairs — multiple sources agree these are best */
  var golden = ["INTJ-ENFP","INTP-ENTJ","INFJ-ENTP","INFP-ENFJ","ENFP-INTJ","ENTJ-INTP","ENTP-INFJ","ENFJ-INFP"];
  var k = a+"-"+b;
  if(golden.indexOf(k)>=0) return {score:5,label:"ゴールデンペア",emoji:"💎",color:"#2563EB",desc:"互いの強みと弱みが見事に噛み合う理想的な組み合わせ"};

  var sEI=a[0]===b[0], sSN=a[1]===b[1], sTF=a[2]===b[2], sJP=a[3]===b[3];
  var diff=(!sEI?1:0)+(!sSN?1:0)+(!sTF?1:0)+(!sJP?1:0);

  /* All 4 different — universally rated as most challenging */
  if(diff===4) return {score:1,label:"要注意ペア",emoji:"💥",color:"#DC2626",desc:"全ての軸が真逆で、価値観やコミュニケーションに大きなギャップが生じやすい"};

  /* Same group: share S/N and T/F (NT-NT, NF-NF, ST-ST, SF-SF) */
  if(sSN && sTF) return {score:4,label:"同じグループ",emoji:"🤝",color:"#10B981",desc:"思考パターンや価値観が近く、自然な協力関係を築きやすい"};

  /* Share 3 of 4 letters — very similar */
  if(diff===1) return {score:4,label:"よく似た仲間",emoji:"👥",color:"#8B5CF6",desc:"多くの共通点があり居心地が良い。小さな違いが良い刺激になる"};

  /* Near-golden: share S/N + opposite E/I + share J/P (e.g. INTJ-ENTP) */
  if(sSN && !sEI && sJP) return {score:4,label:"補完ペア",emoji:"⚡",color:"#F59E0B",desc:"共通の土台がありつつ、E/Iの違いがバランスを生む好相性"};

  /* Share S/N only — decent base */
  if(sSN) return {score:3,label:"まずまず",emoji:"💼",color:"#64748B",desc:"情報の捉え方が同じなので基本的な会話は通じやすい"};

  /* Different S/N but share T/F — some common ground */
  if(sTF && diff<=2) return {score:2,label:"努力が必要",emoji:"🌙",color:"#A78BFA",desc:"判断基準は近いが、物事の捉え方が異なりすれ違いが起きやすい"};

  /* Different S/N, different T/F but not all 4 — tough */
  return {score:2,label:"摩擦が多め",emoji:"⚔️",color:"#EF4444",desc:"価値観や優先順位の違いが大きく、意識的な歩み寄りが必要"};
}

function TeamCompatibility({members}) {
  /* Calculate all unique pairs */
  var pairs = [];
  for(var i=0;i<members.length;i++){
    for(var j=i+1;j<members.length;j++){
      var result = teamCompatScore(members[i],members[j]);
      pairs.push({a:members[i],b:members[j],result:result});
    }
  }

  /* Team chemistry score: average of pair scores mapped to 100 */
  var totalScore = pairs.reduce(function(s,p){return s+p.result.score;},0);
  var avgScore = pairs.length > 0 ? totalScore / pairs.length : 3;
  var chemScore = Math.round(avgScore / 5 * 100);
  var chemColor = chemScore >= 75 ? "#33b98a" : chemScore >= 50 ? "#eab308" : "#f97316";
  var chemLabel = chemScore >= 80 ? "最高のケミストリー" : chemScore >= 65 ? "良好なチームワーク" : chemScore >= 50 ? "まずまずの相性" : "摩擦が多い構成";

  /* Sort: best first */
  var sorted = pairs.slice().sort(function(a,b){return b.result.score - a.result.score;});
  var best = sorted.filter(function(p){return p.result.score >= 4;});
  var worst = sorted.filter(function(p){return p.result.score <= 1;});

  /* Score label */
  function scoreStars(score) {
    var stars = "";
    for(var i=0;i<5;i++) stars += i < score ? "★" : "☆";
    return stars;
  }

  return (
    <div>
      {/* Chemistry Score Banner */}
      <div style={{padding:16,borderRadius:14,background:"rgba(0,0,0,0.15)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:16,display:"flex",alignItems:"center",gap:14}}>
        <div style={{position:"relative",width:64,height:64,flexShrink:0}}>
          <svg width={64} height={64} viewBox="0 0 64 64">
            <circle cx={32} cy={32} r={27} fill="none" stroke="rgba(255,255,255,0.08)" strokeWidth={5} />
            <circle cx={32} cy={32} r={27} fill="none" stroke={chemColor} strokeWidth={5}
              strokeDasharray={2*Math.PI*27} strokeDashoffset={2*Math.PI*27*(1-chemScore/100)}
              strokeLinecap="round" transform="rotate(-90 32 32)" style={{transition:"stroke-dashoffset 0.8s ease"}} />
          </svg>
          <div style={{position:"absolute",top:0,left:0,width:64,height:64,display:"flex",alignItems:"center",justifyContent:"center"}}>
            <span style={{fontFamily:F.h,fontSize:18,fontWeight:800,color:chemColor}}>{chemScore}</span>
          </div>
        </div>
        <div style={{flex:1}}>
          <p style={{fontFamily:F.b,fontSize:13,color:chemColor,fontWeight:700,margin:"0 0 4px"}}>チームケミストリー: {chemLabel}</p>
          <p style={{fontFamily:F.b,fontSize:9,color:S.dm,margin:0,lineHeight:1.5}}>
            {pairs.length}組のペアを分析。{best.length > 0 ? "好相性ペアが"+best.length+"組" : ""}{best.length > 0 && worst.length > 0 ? "、" : ""}{worst.length > 0 ? "要注意ペアが"+worst.length+"組" : ""}
            {best.length === 0 && worst.length === 0 ? "全体的にバランスの取れた相性です。" : "あります。"}
          </p>
        </div>
      </div>

      {/* Best pairs highlight */}
      {best.length > 0 ? (
        <div style={{marginBottom:12}}>
          <p style={{fontFamily:F.b,fontSize:10,color:"#33b98a",fontWeight:700,margin:"0 0 8px"}}>🌟 好相性ペア</p>
          {best.map(function(p,i){
            var gcA = GC[GRP[p.a]], gcB = GC[GRP[p.b]];
            return (
              <div key={i} style={{padding:12,borderRadius:12,background:"rgba(51,185,138,0.05)",border:"1px solid rgba(51,185,138,0.12)",marginBottom:6,display:"flex",alignItems:"center",gap:10}}>
                <div style={{display:"flex",alignItems:"center",gap:4,flexShrink:0}}>
                  <Avatar type={p.a} size={24} />
                  <span style={{fontFamily:F.h,fontSize:10,color:gcA,fontWeight:700}}>{p.a}</span>
                </div>
                <div style={{display:"flex",flexDirection:"column",alignItems:"center",flex:0,flexShrink:0}}>
                  <span style={{fontSize:14}}>{p.result.emoji}</span>
                  <span style={{fontFamily:F.h,fontSize:8,color:p.result.color,fontWeight:700}}>{p.result.score}/5</span>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:4,flexShrink:0}}>
                  <Avatar type={p.b} size={24} />
                  <span style={{fontFamily:F.h,fontSize:10,color:gcB,fontWeight:700}}>{p.b}</span>
                </div>
                <div style={{flex:1,minWidth:0,marginLeft:4}}>
                  <p style={{fontFamily:F.b,fontSize:9,color:p.result.color,fontWeight:700,margin:"0 0 2px"}}>{p.result.label}</p>
                  <p style={{fontFamily:F.b,fontSize:8,color:S.dm,margin:0,lineHeight:1.5}}>{p.result.desc}</p>
                </div>
              </div>
            );
          })}
        </div>
      ) : null}

      {/* Worst pairs warning */}
      {worst.length > 0 ? (
        <div style={{marginBottom:12}}>
          <p style={{fontFamily:F.b,fontSize:10,color:"#ef4444",fontWeight:700,margin:"0 0 8px"}}>⚠️ 要注意ペア</p>
          {worst.map(function(p,i){
            var gcA = GC[GRP[p.a]], gcB = GC[GRP[p.b]];
            return (
              <div key={i} style={{padding:12,borderRadius:12,background:"rgba(239,68,68,0.05)",border:"1px solid rgba(239,68,68,0.12)",marginBottom:6,display:"flex",alignItems:"center",gap:10}}>
                <div style={{display:"flex",alignItems:"center",gap:4,flexShrink:0}}>
                  <Avatar type={p.a} size={24} />
                  <span style={{fontFamily:F.h,fontSize:10,color:gcA,fontWeight:700}}>{p.a}</span>
                </div>
                <div style={{display:"flex",flexDirection:"column",alignItems:"center",flex:0,flexShrink:0}}>
                  <span style={{fontSize:14}}>{p.result.emoji}</span>
                  <span style={{fontFamily:F.h,fontSize:8,color:p.result.color,fontWeight:700}}>{p.result.score}/5</span>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:4,flexShrink:0}}>
                  <Avatar type={p.b} size={24} />
                  <span style={{fontFamily:F.h,fontSize:10,color:gcB,fontWeight:700}}>{p.b}</span>
                </div>
                <div style={{flex:1,minWidth:0,marginLeft:4}}>
                  <p style={{fontFamily:F.b,fontSize:9,color:p.result.color,fontWeight:700,margin:"0 0 2px"}}>{p.result.label}</p>
                  <p style={{fontFamily:F.b,fontSize:8,color:S.dm,margin:0,lineHeight:1.5}}>{p.result.desc}</p>
                </div>
              </div>
            );
          })}
        </div>
      ) : null}

      {/* All pairs matrix */}
      <div>
        <p style={{fontFamily:F.b,fontSize:10,color:S.dm,fontWeight:700,margin:"0 0 8px"}}>📋 全ペア一覧</p>
        {sorted.map(function(p,i){
          var gcA = GC[GRP[p.a]], gcB = GC[GRP[p.b]];
          return (
            <div key={i} style={{padding:"8px 10px",borderRadius:10,background:p.result.color+"08",border:"1px solid "+p.result.color+"15",marginBottom:4,display:"flex",alignItems:"center",gap:8}}>
              <div style={{display:"flex",alignItems:"center",gap:3,minWidth:70}}>
                <Avatar type={p.a} size={18} />
                <span style={{fontFamily:F.h,fontSize:9,color:gcA,fontWeight:600}}>{p.a}</span>
              </div>
              <span style={{fontSize:10,flexShrink:0}}>{p.result.emoji}</span>
              <div style={{display:"flex",alignItems:"center",gap:3,minWidth:70}}>
                <Avatar type={p.b} size={18} />
                <span style={{fontFamily:F.h,fontSize:9,color:gcB,fontWeight:600}}>{p.b}</span>
              </div>
              <span style={{fontFamily:F.b,fontSize:9,color:p.result.color,fontWeight:700,flex:1}}>{p.result.label}</span>
              <span style={{fontFamily:F.h,fontSize:8,color:p.result.color,fontWeight:700,letterSpacing:"1px"}}>{scoreStars(p.result.score)}</span>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function TeamTab() {
  var membersState = useState([]);
  var members = membersState[0], setMembers = membersState[1];
  var analysis = members.length >= 2 ? analyzeTeam(members) : null;

  function toggleMember(t) {
    setMembers(function(prev) {
      return prev.indexOf(t) >= 0 ? prev.filter(function(x){return x!==t;}) : prev.concat([t]);
    });
  }

  return (
    <div>
      <Card title="チームメンバーを選択" icon="👥" color="#0ea5e9" delay={0} large>
        <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"0 0 12px"}}>2名以上を選択するとチーム分析が始まります（複数選択可）</p>
        {GRPS.map(function(g) {
          return (
            <div key={g.name} style={{marginBottom:10}}>
              <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
                <div style={{width:8,height:8,borderRadius:2,background:g.color}} />
                <span style={{fontFamily:F.b,fontSize:9,color:g.color,fontWeight:700}}>{g.name}</span>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:5}}>
                {g.types.map(function(t) {
                  var sel = members.indexOf(t) >= 0;
                  return (
                    <button key={t} onClick={function(){toggleMember(t);}}
                      style={{
                        all:"unset",cursor:"pointer",textAlign:"center",padding:"8px 4px",borderRadius:10,
                        background:sel?g.color+"20":S.glass, border:sel?"1.5px solid "+g.color+"70":"1px solid "+S.border,
                        transition:"all 0.2s", boxShadow:sel?"0 0 12px "+g.color+"20":"none"
                      }}>
                      <Avatar type={t} size={30} />
                      <p style={{fontFamily:F.h,fontSize:9,color:sel?g.color:S.dm,fontWeight:sel?700:500,margin:"3px 0 0"}}>{t}</p>
                    </button>
                  );
                })}
              </div>
            </div>
          );
        })}
        {members.length > 0 ? (
          <div style={{marginTop:10,display:"flex",flexWrap:"wrap",gap:6,alignItems:"center"}}>
            <span style={{fontFamily:F.b,fontSize:9,color:S.dm}}>選択中:</span>
            {members.map(function(m) {
              return <span key={m} style={{fontFamily:F.h,fontSize:10,color:GC[GRP[m]],padding:"3px 10px",borderRadius:12,background:GC[GRP[m]]+"15",border:"1px solid "+GC[GRP[m]]+"30",fontWeight:600}}>{EM[m]} {m}</span>;
            })}
          </div>
        ) : null}
      </Card>

      {analysis ? (
        <div>
          <Card title="チーム構成バランス" icon="📊" color="#9b6dff" delay={1} large>
            <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"0 0 12px"}}>メンバー {analysis.total}名 の認知機能分布</p>
            <BarChart items={[
              {label:"E 外向型",value:Math.round(analysis.traits.E/analysis.total*100),color:"#f97316"},
              {label:"I 内向型",value:Math.round(analysis.traits.I/analysis.total*100),color:"#818cf8"},
              {label:"S 感覚型",value:Math.round(analysis.traits.S/analysis.total*100),color:"#14b8a6"},
              {label:"N 直感型",value:Math.round(analysis.traits.N/analysis.total*100),color:"#a855f7"},
              {label:"T 思考型",value:Math.round(analysis.traits.T/analysis.total*100),color:"#3b82f6"},
              {label:"F 感情型",value:Math.round(analysis.traits.F/analysis.total*100),color:"#ec4899"},
              {label:"J 判断型",value:Math.round(analysis.traits.J/analysis.total*100),color:"#64748b"},
              {label:"P 知覚型",value:Math.round(analysis.traits.P/analysis.total*100),color:"#eab308"}
            ]} />
          </Card>

          <Card title="チーム分析" icon="🔎" color="#7c3aed" delay={1.5} large>
            {/* Team archetype banner */}
            <div style={{padding:16,borderRadius:14,background:"linear-gradient(135deg,rgba(124,58,237,0.08),rgba(59,130,246,0.05))",border:"1px solid rgba(124,58,237,0.15)",marginBottom:16,textAlign:"center"}}>
              <span style={{fontSize:32,display:"block",marginBottom:4}}>{analysis.archetype.icon}</span>
              <p style={{fontFamily:F.b,fontSize:16,color:"#7c3aed",fontWeight:800,margin:"0 0 4px"}}>{analysis.archetype.name}</p>
              <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:0,lineHeight:1.6}}>{analysis.archetype.desc}</p>
            </div>

            {/* Tab switcher */}
            <TeamAnalysisTabs key={members.join(",")} strengths={analysis.strengths} weaknesses={analysis.weaknesses} gaps={analysis.gaps} />
          </Card>

          {/* Member Compatibility */}
          {members.length >= 2 ? (
            <Card title="メンバー間相性" icon="💞" color="#ec4899" delay={2} large>
              <TeamCompatibility members={members} />
            </Card>
          ) : null}
        </div>
      ) : null}
    </div>
  );
}
function EmptyState({text}) {
  return (
    <div style={{textAlign:"center",padding:"60px 20px"}}>
      <div style={{fontSize:40,marginBottom:12,opacity:0.3}}>🔍</div>
      <p style={{fontFamily:F.b,fontSize:12,color:S.dm}}>{text}</p>
    </div>
  );
}

/* ═══════════════════════════════════════════════
   MAIN APP
   ═══════════════════════════════════════════════ */
var TABS = [
  {id:"analysis",label:"分析",icon:"🧬",color:"#9b6dff"},
  {id:"love",label:"恋愛",icon:"💕",color:"#ec4899"},
  {id:"work",label:"仕事",icon:"💼",color:"#3b82f6"},
  {id:"correlation",label:"相関図",icon:"🔮",color:"#8B5CF6"},
  {id:"team",label:"チーム",icon:"👥",color:"#0ea5e9"}
];

function App() {
  var typeState = useState("");
  var type = typeState[0], setType = typeState[1];
  var tabState = useState("analysis");
  var tab = tabState[0], setTab = tabState[1];

  return (
    <div style={{
      minHeight:"100vh", background:S.bg, color:S.tx, fontFamily:F.b,
      maxWidth:520, margin:"0 auto", position:"relative", overflow:"hidden"
    }}>
      {/* Background effects */}
      <div style={{position:"fixed",top:0,left:"50%",transform:"translateX(-50%)",width:600,height:600,
        background:"radial-gradient(ellipse,#9b6dff08 0%,transparent 70%)",pointerEvents:"none",zIndex:0}} />
      <div style={{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:500,height:400,
        background:"radial-gradient(ellipse,#33b98a06 0%,transparent 70%)",pointerEvents:"none",zIndex:0}} />

      {/* Header */}
      <div style={{position:"relative",zIndex:1,padding:"24px 20px 0"}}>
        <div style={{textAlign:"center",marginBottom:20}}>
          <p style={{fontFamily:F.h,fontSize:10,color:S.dm,letterSpacing:"0.25em",margin:"0 0 6px",textTransform:"uppercase"}}>Personality Deep Dive</p>
          <h1 style={{
            fontFamily:F.h, fontSize:26, fontWeight:900, margin:0, letterSpacing:"0.02em",
            background:S.gradient, WebkitBackgroundClip:"text", WebkitTextFillColor:"transparent"
          }}>16 Personalities</h1>
          <p style={{fontFamily:F.b,fontSize:10,color:S.dm,margin:"4px 0 0"}}><a href="https://www.16personalities.com/ja/%E6%80%A7%E6%A0%BC%E8%A8%BA%E6%96%AD%E3%83%86%E3%82%B9%E3%83%88" target="_blank" rel="noopener noreferrer" style={{color:"#818cf8",textDecoration:"none"}}>16Personalities診断へ ↗</a></p>
        </div>

        {/* Tab Bar */}
        <div style={{
          display:"flex",gap:4,padding:4,borderRadius:16,
          background:S.glass, border:"1px solid "+S.border,
          marginBottom:20, backdropFilter:"blur(10px)"
        }}>
          {TABS.map(function(t) {
            var sel = tab === t.id;
            return (
              <button key={t.id} onClick={function(){setTab(t.id);}}
                style={{
                  all:"unset",cursor:"pointer",flex:1,textAlign:"center",padding:"10px 4px",borderRadius:12,
                  background:sel?"linear-gradient(135deg,"+t.color+"25,"+t.color+"10)":"transparent",
                  border:sel?"1px solid "+t.color+"40":"1px solid transparent",
                  transition:"all 0.3s ease",
                  boxShadow:sel?"0 2px 12px "+t.color+"20":"none"
                }}>
                <span style={{fontSize:14,display:"block"}}>{t.icon}</span>
                <span style={{fontFamily:F.b,fontSize:9,color:sel?t.color:S.dm,fontWeight:sel?700:400,display:"block",marginTop:2}}>{t.label}</span>
              </button>
            );
          })}
        </div>

        {/* Type Selection (always visible in analysis tab) */}
        {tab === "analysis" ? (
          <div style={{marginBottom:16}}>
            <TypeGrid value={type} onChange={setType} label="あなたのタイプを選択" />
          </div>
        ) : null}
      </div>

      {/* Content */}
      <div style={{position:"relative",zIndex:1,padding:"0 20px 40px"}}>
        {tab === "analysis" ? <AnalysisTab type={type} /> : null}
        {tab === "love" ? <LoveTab type={type} /> : null}
        {tab === "work" ? <WorkTab type={type} /> : null}
        {tab === "correlation" ? <CorrelationTab /> : null}
        {tab === "team" ? <TeamTab /> : null}
      </div>

      {/* Footer */}
      <div style={{textAlign:"center",padding:"20px 0 30px",position:"relative",zIndex:1}}>
        <div style={{width:40,height:1,background:S.border,margin:"0 auto 10px"}} />
        <p style={{fontFamily:F.h,fontSize:8,color:S.dm+"80",letterSpacing:"0.12em"}}>PERSONALITY ANALYTICS</p>
      </div>
    </div>
  );
}


ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>